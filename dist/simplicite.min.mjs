/**
 * Simplicite(R) platform Javascript API client module (for node.js and browser).
 * @module simplicite
 * @version 2.1.2
 * @license Apache-2.0
 */import C from"node-fetch";import R from"buffer";const b={DEFAULT_ROW_ID_NAME:"row_id",DEFAULT_ROW_ID:"0",CONTEXT_NONE:0,CONTEXT_SEARCH:1,CONTEXT_LIST:2,CONTEXT_CREATE:3,CONTEXT_COPY:4,CONTEXT_UPDATE:5,CONTEXT_DELETE:6,CONTEXT_GRAPH:7,CONTEXT_CROSSTAB:8,CONTEXT_PRINTTMPL:9,CONTEXT_UPDATEALL:10,CONTEXT_REFSELECT:11,CONTEXT_DATAMAPSELECT:12,CONTEXT_PREVALIDATE:13,CONTEXT_POSTVALIDATE:14,CONTEXT_STATETRANSITION:15,CONTEXT_EXPORT:16,CONTEXT_IMPORT:17,CONTEXT_ASSOCIATE:18,CONTEXT_PANELLIST:19,TYPE_ID:0,TYPE_INT:1,TYPE_FLOAT:2,TYPE_STRING:3,TYPE_DATE:4,TYPE_DATETIME:5,TYPE_TIME:6,TYPE_ENUM:7,TYPE_BOOLEAN:8,TYPE_PASSWORD:9,TYPE_URL:10,TYPE_HTML:11,TYPE_EMAIL:12,TYPE_LONG_STRING:13,TYPE_ENUM_MULTI:14,TYPE_REGEXP:15,TYPE_DOC:17,TYPE_FLOAT_EMPTY:18,TYPE_EXTFILE:19,TYPE_IMAGE:20,TYPE_NOTEPAD:21,TYPE_PHONENUM:22,TYPE_COLOR:23,TYPE_OBJECT:24,TYPE_GEOCOORDS:25,VIS_NOT:0,VIS_HIDDEN:0,VIS_LIST:1,VIS_FORM:2,VIS_BOTH:3,SEARCH_NONE:0,SEARCH_MONO:1,SEARCH_MULTI_CHECK:2,SEARCH_MULTI_LIST:3,SEARCH_PERIOD:4,TRUE:"1",FALSE:"0",ERRLEVEL_FATAL:1,ERRLEVEL_ERROR:2,ERRLEVEL_WARNING:3,RESOURCE_TYPE_IMAGE:"IMG",RESOURCE_TYPE_ICON:"ICO",RESOURCE_TYPE_STYLESHEET:"CSS",RESOURCE_TYPE_JAVASCRIPT:"JS"};function L(u){return new w(u)}function w(u){u=u||{},this.constants=b,this.endpoint=u.endpoint||"api",this.log=u.logHandler||(s=>{console.log(s)}),this.info=u.infoHandle||(s=>{console.info(s)}),this.warn=u.warningHandler||(s=>{console.warn(s)}),this.error=u.errorHandler||(s=>{console.error(s)});const f=!!u.debug;if(this.debug=u.debugHandler||(s=>{f&&console.log(s)}),this.timeout=u.timeout||30,u.url)try{u.scheme=u.url.replace(/:.*$/,"");const s=u.url.replace(new RegExp("^"+u.scheme+"://"),"").split(":");if(s.length===1)u.host=s[0].replace(/\/.*$/,""),u.port=u.scheme==="http"?80:443,u.root=s[0].replace(new RegExp("^"+u.host+"/?"),"");else{if(u.host=s[0],u.port=parseInt(s[1].replace(/\/.*$/,""),10),isNaN(u.port))throw new Error("Incorrect port");u.root=s[1].replace(new RegExp("^"+u.port+"/?"),"")}u.root==="/"&&(u.root="")}catch(s){this.error("Unable to parse URL ["+u.url+"]: "+s.message);return}const m=u.scheme||(u.port===443?"https":"http");if(m!=="http"&&m!=="https"){this.error("Incorrect scheme ["+u.scheme+"]");return}const g=u.host||"localhost",p=u.port||8080;let n=u.root||"";n==="/"&&(n="");let r=m+"://"+g;(m==="http"&&p!=80||m==="https"&&p!=443)&&(r+=":"+p),n!==""&&(r+=n.startsWith("/")?n:"/"+n),this.debug("[simplicite] Base URL = "+r);const e=this.endpoint=="public"?"":"/"+this.endpoint;this.parameters={scheme:m,host:g,port:p,root:n,url:r,healthpath:(e=="/ui"?e:"")+"/health?format=json",apppath:e+"/json/app",objpath:e+"/json/obj",extpath:e+"/ext",docpath:e+"/raw/document",respath:"/resource"},this.username=u.username||u.login,this.setUsername=s=>{this.username=s},this.password=u.password||u.pwd,this.setPassword=s=>{this.password=s},this.authtoken=u.authtoken||u.authToken||u.token,this.setAuthToken=s=>{this.authtoken=s};let l={};this.getBusinessObjectCacheKey=(s,t)=>s+":"+(t||"js_"+s),this.clear=()=>{this.username=void 0,this.password=void 0,this.authtoken=void 0,this.sessionid=void 0,this.grant=void 0,this.appinfo=void 0,this.sysinfo=void 0,this.devinfo=void 0,this.userinfo=void 0,l={}},this.getBasicAuthHeader=()=>this.username&&this.password?"Basic "+R.Buffer.from(this.username+":"+this.password).toString("base64"):void 0,this.getBearerTokenHeader=()=>this.authtoken?"Bearer "+this.authtoken:void 0,this.req=(s,t,i,o)=>{const a=this,c=t?"POST":"GET",h={};t&&(h["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8");let d=a.getBearerTokenHeader();d?h["X-Simplicite-Authorization"]=d:(d=a.getBasicAuthHeader(),d&&(h.Authorization=d));const T=a.parameters.url+s||"/",y=t?typeof t=="string"?t:JSON.stringify(t):void 0;a.debug("[simplicite.req] "+c+" "+T+(y?" with "+y:"")),C(T,{method:c,headers:h,timeout:a.timeout*1e3,mode:"cors",credentials:"include",body:y}).then(E=>{i&&E.text().then(_=>{i.call(a,_,E.status,E.headers)})}).catch(E=>{const _=E.response&&E.response.status?E.response.status:void 0,I=E.response&&E.response.data?E.response.data:E;if(o)o.call(a,a.getError.call(a,I,_));else throw I})},this.getError=(s,t)=>typeof s=="string"?{message:s,status:t||200}:s.response?typeof s.response=="string"?{message:s.response,status:t||200}:s.response:s,this.parse=(s,t)=>{try{return t!==200?{type:"error",response:this.getError("HTTP status: "+t,t)}:typeof s=="object"?s:JSON.parse(s)}catch(i){return{type:"error",response:this.getError("Parsing error: "+i.message,t)}}},this.getHealth=s=>{const t=this;return s=s||{},new Promise((i,o)=>{t.req.call(t,t.parameters.healthpath+"&full="+!!s.full,void 0,(a,c)=>{const h=t.parse(a,c);t.debug("[simplicite.getHealth] HTTP status = "+c+", response type = "+a),h.type==="error"?(s.error||t.error||o).call(t,h.response):i&&i.call(t,h)},a=>{(s.error||t.error||o).call(t,t.getError(a))})})},this.login=s=>{const t=this;return s=s||{},new Promise((i,o)=>{(s.username||s.login)&&(s.password||s.pwd)?(t.clear(),t.username=s.username||s.login,t.password=s.password||s.pwd):(s.authtoken||s.authToken||s.token)&&(t.clear(),t.authtoken=s.authtoken||s.authToken||s.token),t.req.call(t,t.parameters.apppath+"?action=session",void 0,(a,c)=>{const h=t.parse(a,c);t.debug("[simplicite.login] HTTP status = "+c+", response type = "+h.type),h.type==="error"?(s.error||t.error||o).call(t,h.response):(t.sessionid=h.response.id,t.debug("[simplicite.login] Session ID = "+t.sessionid),t.username=h.response.login,t.username&&t.debug("[simplicite.login] Username = "+t.username),t.authtoken=h.response.authtoken,t.authtoken&&t.debug("[simplicite.login] Auth token = "+t.authtoken),t.grant=Object.assign(new P,{login:h.response.login,userid:h.response.userid,firstname:h.response.firstanme,lastname:h.response.lastname,email:h.response.email}),i&&i.call(t,h.response))},a=>{(s.error||t.error||o).call(t,t.getError(a))})})},this.logout=s=>{const t=this;return s=s||{},new Promise((i,o)=>{t.req.call(t,t.parameters.apppath+"?action=logout",void 0,(a,c)=>{const h=t.parse(a,c);t.debug("[simplicite.logout] HTTP status = "+c+", response type = "+h.type),h.type==="error"?(s.error||t.error||o).call(t,h.response):(t.clear(),i&&i.call(t,h.response))},a=>{a.status===401&&(t.authtoken=void 0),(s.error||t.error||o).call(t,t.getError(a))})})},this.grant=void 0,this.getGrant=s=>{const t=this;return s=s||{},new Promise((i,o)=>{let a="&web=true";(s.inlinePicture||s.picture)&&(a+="&inline_picture="+(!!s.inlinePicture||!!s.picture)),(s.includeTexts||s.texts)&&(a+="&texts="+(!!s.includeTexts||!!s.texts)),t.req.call(t,t.parameters.apppath+"?action=getgrant"+a,void 0,(c,h)=>{const d=t.parse(c,h);t.debug("[simplicite.getGrant] HTTP status = "+h+", response type = "+d.type),d.type==="error"?(s.error||t.error||o).call(t,d.response):(t.grant=Object.assign(new P,d.response),i&&i.call(t,t.grant))},c=>{(s.error||t.error||o).call(t,t.getError(c))})})},this.changePassword=(s,t)=>{const i=this;return t=t||{},new Promise((o,a)=>{i.req.call(i,i.parameters.apppath+"?action=setpassword&password="+encodeURIComponent(s),void 0,(c,h)=>{const d=i.parse(c,h);i.debug("[simplicite.changePassword] HTTP status = "+h+", response type = "+d.type),d.type==="error"?(t.error||i.error||a).call(i,d.response):o&&o.call(i,d.response)},c=>{(t.error||i.error||a).call(i,i.getError(c))})})},this.getAppInfo=s=>{const t=this;return s=s||{},new Promise((i,o)=>{t.req.call(t,t.parameters.apppath+"?action=getinfo",void 0,(a,c)=>{const h=t.parse(a,c);t.debug("[simplicite.getAppInfo] HTTP status = "+c+", response type = "+h.type),h.type==="error"?(s.error||t.error||o).call(t,h.response):(t.appinfo=h.response,i&&i.call(t,t.appinfo))},a=>{(s.error||t.error||o).call(t,t.getError(a))})})},this.getSysInfo=s=>{const t=this;return s=s||{},new Promise((i,o)=>{t.req.call(t,t.parameters.apppath+"?action=sysinfo",void 0,(a,c)=>{const h=t.parse(a,c);t.debug("[simplicite.getSysInfo] HTTP status = "+c+", response type = "+h.type),h.type==="error"?(s.error||t.error||o).call(t,h.response):(t.sysinfo=h.response,i&&i.call(t,t.sysinfo))},a=>{(s.error||t.error||o).call(t,t.getError(a))})})},this.getDevInfo=(s,t)=>{const i=this;return t=t||{},new Promise((o,a)=>{let c="";s&&(c+="&module="+encodeURIComponent(s)),i.req.call(i,i.parameters.apppath+"?action=devinfo"+c,void 0,(h,d)=>{const T=i.parse(h,d);i.debug("[simplicite.getDevInfo] HTTP status = "+d+", response type = "+T.type),T.type==="error"?(t.error||i.error||a).call(i,T.response):(s||(i.devinfo=T.response),o&&o.call(i,T.response))},h=>{(t.error||i.error||a).call(i,i.getError(h))})})},this.getNews=s=>{const t=this;return s=s||{},new Promise((i,o)=>{let a="";s.inlineImages&&(a+="&inline_images="+!!s.inlineImages),t.req.call(t,t.parameters.apppath+"?action=news"+a,void 0,(c,h)=>{const d=t.parse(c,h);t.debug("[simplicite.getNews] HTTP status = "+h+", response type = "+d.type),d.type==="error"?(s.error||t.error||o).call(t,d.response):(t.news=d.response,i&&i.call(t,t.news))},c=>{(s.error||t.error||o).call(t,t.getError(c))})})},this.indexSearch=(s,t,i)=>{const o=this;return i=i||{},new Promise((a,c)=>{let h="";i.metadata===!0&&(h+="&_md=true"),i.context&&(h+="&context="+encodeURIComponent(i.context)),o.req.call(o,o.parameters.apppath+"?action=indexsearch&request="+encodeURIComponent(s||"")+(t?"&object="+encodeURIComponent(t):"")+h,void 0,(d,T)=>{const y=o.parse(d,T);o.debug("[simplicite.indexSearch] HTTP status = "+T+", response type = "+y.type),y.type==="error"?(i.error||o.error||c).call(o,y.response):a&&a.call(o,y.response)},d=>{(i.error||o.error||c).call(o,o.getError(d))})})},this.getBusinessObject=(s,t)=>{const i=this.getBusinessObjectCacheKey(s,t);let o=l[i];return o||(o=new N(this,s,t),l[i]=o),o},this.getExternalObject=s=>new A(this,s),this.getResourceURL=(s,t,i,o)=>this.parameters.url+this.parameters.respath+"?code="+encodeURIComponent(s)+"&type="+encodeURIComponent(t||"IMG")+(i?"&object="+encodeURIComponent(i):"")+(o?"&objid="+encodeURIComponent(o):"")+(this.authtoken?"_x_simplicite_authorization_="+encodeURIComponent(this.authtoken):"")}function P(){this.getUserId=()=>this.userid,this.getUsername=()=>this.login,this.getLogin=this.getUsername,this.getLang=()=>this.lang,this.getEmail=()=>this.email,this.getFirstname=()=>this.firstname,this.getFirstName=this.getFirstname,this.getLastname=()=>this.lastname,this.getLastName=this.getLastname,this.getPictureURL=()=>{if(this.picture)return"data:"+this.picture.mime+";base64,"+this.picture.content},this.hasResponsibility=u=>this.responsibilities&&this.responsibilities.indexOf(u)!==-1,this.T=u=>this.texts&&this.texts[u]||""}function O(){this.getId=()=>this.id,this.getMIMEType=()=>this.mime,this.getMimeType=this.getMIMEType,this.setMIMEType=f=>{this.mime=f},this.setMimeType=this.setMIMEType,this.getFilename=()=>this.filename,this.getFileName=this.getFilename,this.setFilename=f=>{this.filename=f},this.setFileName=this.setFilename,this.getContent=()=>this.content,this.getThumbnail=()=>this.thumbnail;function u(f){return R.Buffer.from(f,"base64")}this.getContentAsArrayBuffer=()=>u(this.content).buffer,this.getThumbnailAsArrayBuffer=()=>u(this.thumbnail||"").buffer,this.getContentAsText=f=>u(this.content).toString(f||"utf-8"),this.setContent=f=>{this.content=f},this.setContentFromText=(f,m)=>{this.content=R.Buffer.from(f,m||"utf-8").toString("base64")},this.getDataURL=f=>{if(this.content)return"data:"+this.mime+";base64,"+(f&&this.thumbnail?this.thumbnail:this.content)},this.getValue=()=>JSON.parse(JSON.stringify(this))}function U(u,f){this.name=u,this.instance=f,this.rowidfield=b.DEFAULT_ROW_ID_NAME,this.label=u,this.help="",this.fields=[]}function N(u,f,m){m=m||"js_"+f,this.session=u,this.metadata=new U(f,m),this.cacheKey=this.session.getBusinessObjectCacheKey(f,m),this.path=this.session.parameters.objpath+"?object="+encodeURIComponent(f)+"&inst="+encodeURIComponent(m),this.item={},this.filters={},this.list=[],this.getMetaData=n=>{const r=this;return n=n||{},new Promise((e,l)=>{let s="";n.context&&(s+="&context="+encodeURIComponent(n.context)),n.contextParam&&(s+="&contextparam="+encodeURIComponent(n.contextParam)),r.session.req.call(r.session,r.path+"&action=metadata"+s,void 0,(t,i)=>{const o=r.session.parse(t,i);r.session.debug("[simplicite.BusinessObject.getMetaData] HTTP status = "+i+", response type = "+o.type),o.type==="error"?(n.error||r.session.error||l).call(r,o.response):(r.metadata=o.response,e&&e.call(r,r.metadata))},t=>{(n.error||r.session.error||l).call(r,r.session.getError(t))})})},this.getMetadata=this.getMetaData,this.getName=()=>this.metadata.name,this.getInstance=()=>this.metadata.instance,this.getLabel=()=>this.metadata.label,this.getHelp=()=>this.metadata.help,this.getFields=()=>this.metadata.fields,this.getField=n=>{let r=0;const e=this.getFields();for(;r<e.length&&e[r].name!==n;)r++;if(r<e.length)return e[r]},this.getRowIdFieldName=()=>this.metadata.rowidfield,this.getRowIdField=()=>this.getField(this.getRowIdFieldName()),this.getLinks=()=>this.metadata.links,this.getFieldType=n=>{if(typeof n=="string"&&(n=this.getField(n)),n)return n.type},this.getFieldLabel=n=>{if(typeof n=="string"&&(n=this.getField(n)),n)return n.label},this.getFieldValue=(n,r)=>{if(r||(r=this.item),n&&r)return r[typeof n=="string"?n:n.name]},this.getFieldListValue=(n,r)=>{typeof n=="string"&&(n=this.getField(n));const e=this.getFieldValue(n,r);return n&&n.listOfValues?this.getListValue(n.listOfValues,e):e},this.getFieldDataURL=(n,r)=>{typeof n!="string"&&(n=n.fullinput||n.name);const e=this.getFieldValue(n,r);if(e&&e.mime)return"data:"+e.mime+";base64,"+(e.content||e.thumbnail)},this.getFieldDocument=(n,r)=>{typeof n!="string"&&(n=n.fullinput||n.input||n.name);const e=this.getFieldValue(n,r);return e&&e.mime?Object.assign(new O,e):e},this.getFieldDocumentURL=(n,r,e)=>{typeof n!="string"&&(n=n.fullinput||n.input||n.name);let l=this.getFieldValue(n,r);if(l&&l.mime&&(l=l.id),l)return this.session.parameters.url+this.session.parameters.docpath+"?object="+encodeURIComponent(this.metadata.name)+"&inst="+encodeURIComponent(this.metadata.instance)+"&field="+encodeURIComponent(n)+"&row_id="+encodeURIComponent(this.getRowId(r))+"&doc_id="+encodeURIComponent(l)+(e?"&thumbnail=true":"")+(this.session.authtoken?"&_x_simplicite_authorization_="+encodeURIComponent(this.session.authtoken):"")},this.getListValue=(n,r)=>{if(n)for(let e=0;e<n.length;e++){const l=n[e];if(l.code===r)return l.value}return r},this.setFieldValue=(n,r,e)=>{e||(e=this.item),n&&e&&(e[typeof n=="string"?n:n.name]=r instanceof O?r.getValue():r)},this.isRowIdField=n=>!n.ref&&n.name===this.metadata.rowidfield,this.isTimestampField=n=>{const r=n.name;return!n.ref&&(r==="created_by"||r==="created_dt"||r==="updated_by"||r==="updated_dt")},this.getFilters=n=>{const r=this;return n=n||{},new Promise((e,l)=>{let s="";n.context&&(s+="&context="+encodeURIComponent(n.context)),n.reset&&(s+="&reset="+!!n.reset),r.session.req.call(r.session,r.path+"&action=filters"+s,void 0,(t,i)=>{const o=r.session.parse(t,i);r.session.debug("[simplicite.BusinessObject.getFilters] HTTP status = "+i+", response type = "+o.type),o.type==="error"?(n.error||r.session.error||l).call(r,o.response):(r.filters=o.response,e&&e.call(r,r.filters))},t=>{(n.error||r.session.error||l).call(r,r.session.getError(t))})})};function g(n){let r="";n.context&&(r+="&context="+encodeURIComponent(n.context));const e=n.inlineDocs||n.inlineDocuments||n.inlineImages;e&&(r+="&inline_documents="+encodeURIComponent(e.join?e.join(","):e));const l=n.inlineThumbs||n.inlineThumbnails;l&&(r+="&inline_thumbnails="+encodeURIComponent(l.join?l.join(","):l));const s=n.inlineObjs||n.inlineObjects;return s&&(r+="&inline_objects="+encodeURIComponent(s.join?s.join(","):s)),r}function p(n){let r="";if(!n)return r;let e=0;for(let l in n){const s=n[l]||"";if(s.name&&s.content)s.content.startsWith("data:")&&(s.content=s.content.replace(/data:.*;base64,/,"")),r+=(e++!=0?"&":"")+l+"="+encodeURIComponent("id|"+(s.id?s.id:"0")+"|name|"+s.name+"|content|"+s.content);else if(s.object&&s.row_id)r+=(e++!=0?"&":"")+l+"="+encodeURIComponent("object|"+s.object+"|row_id|"+s.row_id);else if(s.sort)for(let t=0;t<s.length;t++)r+=(e++!=0?"&":"")+l+"="+encodeURIComponent(s[t]);else r+=(e++!=0?"&":"")+l+"="+encodeURIComponent(s)}return r}this.count=(n,r)=>{const e=this;return r=r||{},new Promise((l,s)=>{e.filters=n||{},e.session.req.call(e.session,e.path+"&action=count",p(e.filters),(t,i)=>{const o=e.session.parse(t,i);e.session.debug("[simplicite.BusinessObject.getCount] HTTP status = "+i+", response type = "+o.type),o.type==="error"?(r.error||e.session.error||s).call(e,o.response):(e.count=o.response.count,e.page=o.response.page>=0?o.response.page+1:void 0,e.maxpage=o.response.maxpage>=0?o.response.maxpage+1:void 0,e.list=[],l&&l.call(e,e.count))},t=>{(r.error||e.session.error||s).call(e,e.session.getError(t))})})},this.getCount=this.count,this.search=(n,r)=>{const e=this;return r=r||{},new Promise((l,s)=>{let t=g(r);r.page>0&&(t+="&page="+(r.page-1)),r.metadata===!0&&(t+="&_md=true"),r.visible===!0&&(t+="&_visible=true"),e.filters=n||{},e.session.req.call(e.session,e.path+"&action=search"+t,p(e.filters),(i,o)=>{const a=e.session.parse(i,o);e.session.debug("[simplicite.BusinessObject.search] HTTP status = "+o+", response type = "+a.type),a.type==="error"?(r.error||e.session.error||s).call(e,a.response):(i.meta&&(e.metadata=a.response.meta),e.count=a.response.count,e.page=a.response.page>=0?a.response.page+1:void 0,e.maxpage=a.response.maxpage>=0?a.response.maxpage+1:void 0,e.list=a.response.list,l&&l.call(e,e.list))},i=>{(r.error||e.session.error||s).call(e,e.session.getError(i))})})},this.get=(n,r)=>{const e=this;return r=r||{},new Promise((l,s)=>{let t=g(r);const i=r.treeView;if(i&&(t+="&treeview="+encodeURIComponent(i)),r.fields)for(let o=0;o<r.fields.length;o++)t+="&fields="+encodeURIComponent(r.fields[o].replace(".","__"));r.metadata&&(t+="&_md=true"),r.social&&(t+="&_social=true"),e.session.req.call(e.session,e.path+"&action=get&"+e.metadata.rowidfield+"="+encodeURIComponent(n)+t,void 0,(o,a)=>{const c=e.session.parse(o,a);e.session.debug("[simplicite.BusinessObject.get] HTTP status = "+a+", response type = "+c.type),c.type==="error"?(r.error||e.session.error||s).call(e,c.response):(c.response.meta&&(e.metadata=c.response.meta),c.response.data?e.item=i?c.response.data.item:c.response.data:e.item=i?c.response.item:c.response,l&&l.call(e,i?c.response:e.item))},o=>{(r.error||e.session.error||s).call(e,e.session.getError(o))})})},this.getForCreate=n=>(n=n||{},delete n.treeview,delete n.fields,n.context=b.CONTEXT_CREATE,this.get(this.session.constants.DEFAULT_ROW_ID,n)),this.getForUpdate=(n,r)=>(r=r||{},delete r.treeview,delete r.fields,r.context=b.CONTEXT_UPDATE,this.get(n,r)),this.getForCopy=(n,r)=>(r=r||{},delete r.treeview,delete r.fields,r.context=b.CONTEXT_COPY,this.get(n,r)),this.getForDelete=(n,r)=>(r=r||{},delete r.treeview,delete r.fields,r.context=b.CONTEXT_DELETE,this.get(n,r)),this.getRowId=n=>{if(n=n||this.item,n)return n[this.getRowIdFieldName()]},this.populate=(n,r)=>{const e=this;return r=r||{},new Promise((l,s)=>{let t=g(r);e.session.req.call(e.session,e.path+"&action=populate&"+e.metadata.rowidfield+"="+encodeURIComponent(n)+t,void 0,(i,o)=>{const a=e.session.parse(i,o);e.session.debug("[simplicite.BusinessObject.populate] HTTP status = "+o+", response type = "+a.type),a.type==="error"?(r.error||e.session.error||s).call(e,a.response):(e.item=a.response.data?a.response.data:a.response,l&&l.call(e,e.item))},i=>{(r.error||e.session.error||s).call(e,e.session.getError(i))})})},this.save=(n,r)=>{n&&(this.item=n);const e=this.item[this.metadata.rowidfield];return!e||e===b.DEFAULT_ROW_ID?this.create(n,r):this.update(n,r)},this.create=(n,r)=>{const e=this;return r=r||{},new Promise((l,s)=>{n&&(e.item=n),e.item.row_id=e.session.constants.DEFAULT_ROW_ID;let t=g(r);e.session.req.call(e.session,e.path+"&action=create"+t,p(e.item),(i,o)=>{const a=e.session.parse(i,o);e.session.debug("[simplicite.BusinessObject.create] HTTP status = "+o+", response type = "+a.type),a.type==="error"?(r.error||e.session.error||s).call(e,a.response):(e.item=a.response.data?a.response.data:a.response,l&&l.call(e,e.item))},i=>{(r.error||e.session.error||s).call(e,e.session.getError(i))})})},this.update=(n,r)=>{const e=this;return r=r||{},new Promise((l,s)=>{n&&(e.item=n);let t=g(r);e.session.req.call(e.session,e.path+"&action=update"+t,p(e.item),(i,o)=>{const a=e.session.parse(i,o);e.session.debug("[simplicite.BusinessObject.update] HTTP status = "+o+", response type = "+a.type),a.type==="error"?(r.error||e.session.error||s).call(e,a.response):(e.item=a.response.data?a.response.data:a.response,l&&l.call(e,e.item))},i=>{(r.error||e.session.error||s).call(e,e.session.getError(i))})})},this.del=(n,r)=>{const e=this;return r=r||{},new Promise((l,s)=>{n&&(e.item=n),e.session.req.call(e.session,e.path+"&action=delete&"+e.metadata.rowidfield+"="+encodeURIComponent(e.item[e.metadata.rowidfield]),void 0,(t,i)=>{const o=e.session.parse(t,i);e.session.debug("[simplicite.BusinessObject.del] HTTP status = "+i+", response type = "+o.type),o.type==="error"?(r.error||e.session.error||s).call(e,o.response):(e.item=void 0,delete o.response.undoredo,l&&l.call(e,o.response))},t=>{(r.error||e.session.error||s).call(e,e.session.getError(t))})})},this.action=(n,r,e)=>{const l=this;return e=e||{},new Promise((s,t)=>{l.session.req.call(l.session,l.path+"&action="+encodeURIComponent(n)+(r?"&"+l.getRowIdFieldName()+"="+encodeURIComponent(r):""),p(e.parameters),(i,o)=>{const a=l.session.parse(i,o);if(l.session.debug("[simplicite.BusinessObject.action("+n+")] HTTP status = "+o+", response type = "+a.type),a.type==="error")(e.error||l.session.error||t).call(l,a.response);else{const c=a.response.result;s&&s.call(l,c)}},i=>{(e.error||l.session.error||t).call(l,l.session.getError(i))})})},this.crosstab=(n,r)=>{const e=this;return r=r||{},new Promise((l,s)=>{r.filters&&(e.filters=r.filters),e.session.req.call(e.session,e.path+"&action=crosstab&crosstab="+encodeURIComponent(n),p(e.filters),(t,i)=>{const o=e.session.parse(t,i);e.session.debug("[simplicite.BusinessObject.crosstab("+n+")] HTTP status = "+i+", response type = "+o.type),o.type==="error"?(r.error||e.session.error||s).call(e,o.response):(e.crosstabdata=o.response,l&&l.call(e,e.crosstabdata))},t=>{(r.error||e.session.error||s).call(e,e.session.getError(t))})})},this.print=(n,r,e)=>{const l=this;return e=e||{},new Promise((s,t)=>{e.filters&&(l.filters=e.filters);let i="";e.all&&(i+="&all="+!!e.all),e.mailing&&(i+="&mailing="+!!e.mailing),l.session.req.call(l.session,l.path+"&action=print&printtemplate="+encodeURIComponent(n)+(r?"&"+l.getRowIdFieldName()+"="+encodeURIComponent(r):"")+i,void 0,(o,a)=>{const c=l.session.parse(o,a);l.session.debug("[simplicite.BusinessObject.print("+n+")] HTTP status = "+a+", response type = "+c.type),c.type==="error"?(e.error||l.session.error||t).call(l,c.response):s&&s.call(l,Object.assign(new O,c.response))},o=>{(e.error||l.session.error||t).call(l,l.session.getError(o))})})},this.setParameter=(n,r,e)=>{const l=this;return e=e||{},new Promise((s,t)=>{let i={name:n};r&&(i.value=r),l.session.req.call(l.session,l.path+"&action=setparameter",p(i),(o,a)=>{const c=l.session.parse(o,a);if(l.session.debug("[simplicite.BusinessObject.setParameter("+i.name+")] HTTP status = "+a+", response type = "+c.type),c.type==="error")(e.error||l.session.error||t).call(l,c.response);else{const h=c.response.result;s&&s.call(l,h)}},o=>{(e.error||l.session.error||t).call(l,l.session.getError(o))})})},this.getParameter=(n,r)=>{const e=this;return r=r||{},new Promise((l,s)=>{let t={name:n};e.session.req.call(e.session,e.path+"&action=getparameter",p(t),(i,o)=>{const a=e.session.parse(i,o);if(e.session.debug("[simplicite.BusinessObject.getParameter("+t.name+")] HTTP status = "+o+", response type = "+a.type),a.type==="error")(r.error||e.session.error||s).call(e,a.response);else{const c=a.response.result;l&&l.call(e,c)}},i=>{(r.error||e.session.error||s).call(e,e.session.getError(i))})})},this.getResourceURL=(n,r)=>this.session.getResourceURL(n,r,this.metadata.name,this.metadata.id)}function S(u){this.name=u}function A(u,f){this.session=u,this.metadata=new S(f),this.path=this.session.parameters.extpath+"/"+encodeURIComponent(f),this.getName=()=>this.metadata.name,this.callParams=m=>{let g="";if(!m)return g;let p=0;for(let n in m){const r=m[n]||"";if(r.sort)for(let e=0;e<r.length;e++)g+=(p++!=0?"&":"")+n+"="+encodeURIComponent(r[e]);else g+=(p++!=0?"&":"")+n+"="+encodeURIComponent(r)}return g},this.call=(m,g,p)=>{const n=this;return p=p||{},new Promise((r,e)=>{let l="";m&&(l="?"+n.callParams(m));const s=p.method?p.method.toUpperCase():g?"POST":"GET",t={};p.contentType?t["Content-Type"]=p.contentType:g&&(t["Content-Type"]=typeof g=="string"?"application/x-www-form-urlencoded":"application/json");let i=n.session.getBearerTokenHeader();i?t["X-Simplicite-Authorization"]=i:(i=n.session.getBasicAuthHeader(),i&&(t.Authorization=i));const o=n.session.parameters.url+n.path+l,a=g?typeof g=="string"?g:JSON.stringify(g):void 0;n.session.debug("[simplicite.ExternalObject.call] "+s+" "+o+" with "+(a?" with "+a:"")),C(o,{method:s,headers:t,timeout:n.session.timeout*1e3,mode:"cors",credentials:"include",body:a}).then(c=>{const h=c.headers.get("content-type");n.session.debug("[simplicite.ExternalObject.call("+l+")] HTTP status = "+c.status+", response content type = "+h),h&&h.startsWith("application/json")?c.json().then(d=>{r&&r.call(n,d,c.status,c.headers)}).catch(d=>{(p.error||n.error||e).call(n,n.getError(d))}):h&&h.startsWith("text/")?c.text().then(d=>{r&&r.call(n,d,c.status,c.headers)}).catch(d=>{(p.error||n.error||e).call(n,n.getError(d))}):c.arrayBuffer().then(d=>{r&&r.call(n,d,c.status,c.headers)}).catch(d=>{(p.error||n.error||e).call(n,n.getError(d))})}).catch(c=>{(p.error||n.error||e).call(n,n.getError(c))})})}}export default{session:L,Session:w,Grant:P,BusinessObject:N,BusinessObjectMetadata:U,ExternalObject:A};

"use strict";/**
 * Simplicite(R) platform Javascript API client module (for node.js and browser).
 * @module simplicite
 * @version 2.2.7
 * @license Apache-2.0
 */var __importDefault=this&&this.__importDefault||function(T){return T&&T.__esModule?T:{default:T}};Object.defineProperty(exports,"__esModule",{value:!0});var node_fetch_1=__importDefault(require("node-fetch")),buffer_1=require("buffer"),constants={MODULE_VERSION:"2.2.7",DEFAULT_ROW_ID_NAME:"row_id",DEFAULT_ROW_ID:"0",CONTEXT_NONE:0,CONTEXT_SEARCH:1,CONTEXT_LIST:2,CONTEXT_CREATE:3,CONTEXT_COPY:4,CONTEXT_UPDATE:5,CONTEXT_DELETE:6,CONTEXT_GRAPH:7,CONTEXT_CROSSTAB:8,CONTEXT_PRINTTMPL:9,CONTEXT_UPDATEALL:10,CONTEXT_REFSELECT:11,CONTEXT_DATAMAPSELECT:12,CONTEXT_PREVALIDATE:13,CONTEXT_POSTVALIDATE:14,CONTEXT_STATETRANSITION:15,CONTEXT_EXPORT:16,CONTEXT_IMPORT:17,CONTEXT_ASSOCIATE:18,CONTEXT_PANELLIST:19,TYPE_ID:0,TYPE_INT:1,TYPE_FLOAT:2,TYPE_STRING:3,TYPE_DATE:4,TYPE_DATETIME:5,TYPE_TIME:6,TYPE_ENUM:7,TYPE_BOOLEAN:8,TYPE_PASSWORD:9,TYPE_URL:10,TYPE_HTML:11,TYPE_EMAIL:12,TYPE_LONG_STRING:13,TYPE_ENUM_MULTI:14,TYPE_REGEXP:15,TYPE_DOC:17,TYPE_FLOAT_EMPTY:18,TYPE_EXTFILE:19,TYPE_IMAGE:20,TYPE_NOTEPAD:21,TYPE_PHONENUM:22,TYPE_COLOR:23,TYPE_OBJECT:24,TYPE_GEOCOORDS:25,VIS_NOT:0,VIS_HIDDEN:0,VIS_LIST:1,VIS_FORM:2,VIS_BOTH:3,SEARCH_NONE:0,SEARCH_MONO:1,SEARCH_MULTI_CHECK:2,SEARCH_MULTI_LIST:3,SEARCH_PERIOD:4,TRUE:"1",FALSE:"0",ERRLEVEL_FATAL:1,ERRLEVEL_ERROR:2,ERRLEVEL_WARNING:3,RESOURCE_TYPE_IMAGE:"IMG",RESOURCE_TYPE_ICON:"ICO",RESOURCE_TYPE_STYLESHEET:"CSS",RESOURCE_TYPE_JAVASCRIPT:"JS"},session=function(T){return new Session(T)},Session=function(){function T(g){var e=this;if(this.constants=constants,this.setUsername=function(n){e.username=n},this.setPassword=function(n){e.password=n},this.setAuthToken=function(n){e.authtoken=n},this.getBusinessObjectCacheKey=function(n,o){return n+":"+(o||"js_"+n)},this.clear=function(){e.username=void 0,e.password=void 0,e.authtoken=void 0,e.sessionid=void 0,e.grant=void 0,e.appinfo=void 0,e.sysinfo=void 0,e.devinfo=void 0,e.businessObjectCache=new Map},this.getBasicAuthHeader=function(){return e.username&&e.password?"Basic "+buffer_1.Buffer.from(e.username+":"+e.password).toString("base64"):void 0},this.getBearerTokenHeader=function(){return e.authtoken?"Bearer "+e.authtoken:void 0},this.getError=function(n,o,a){if(typeof n=="string")return{message:n,status:o||200,origin:a};if(n.response){if(typeof n.response=="string")return{message:n.response,status:o||200,origin:a};if(a)try{n.response.origin=a}catch{}return n.response}else{if(a)try{n.origin=a}catch{}return n}},this.req=function(n,o,a,f){var c="Session.req",l=o?"POST":"GET",d={};o&&(d["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8");var h=e.getBearerTokenHeader();h?d["X-Simplicite-Authorization"]=h:(h=e.getBasicAuthHeader(),h&&(d.Authorization=h));var E=e.parameters.url+n||"/",p=o?typeof o=="string"?o:JSON.stringify(o):void 0;e.debug("["+c+"] "+l+" "+E+(p?" with "+p:"")),(0,node_fetch_1.default)(E,{method:l,headers:d,timeout:e.parameters.timeout*1e3,mode:"cors",credentials:"include",body:p}).then(function(R){a&&R.text().then(function(b){a.call(e,b,R.status,R.headers)})}).catch(function(R){var b=R.response&&R.response.status?R.response.status:void 0,y=R.response&&R.response.data?R.response.data:R;if(f)f.call(e,e.getError(y,b,c));else throw y})},this.parse=function(n,o){try{return o!==200?{type:"error",response:e.getError("HTTP status: "+o,o)}:typeof n=="object"?n:JSON.parse(n)}catch(a){return{type:"error",response:e.getError("Parsing error: "+a.message,o)}}},this.getHealth=function(n){var o="Session.getHealth";return n=n||{},new Promise(function(a,f){e.req(e.parameters.healthpath+"&full="+!!n.full,void 0,function(c,l){var d=e.parse(c,l);e.debug("["+o+"] HTTP status = "+l+", response type = "+c),d.type==="error"?(n.error||e.error||f).call(e,e.getError(d.response,void 0,o)):a&&a.call(e,d)},function(c){(n.error||e.error||f).call(e,e.getError(c,void 0,o))})})},this.login=function(n){var o="Session.login";return n=n||{},new Promise(function(a,f){(n.username||n.login)&&(n.password||n.pwd)?(e.clear(),e.username=n.username||n.login,e.password=n.password||n.pwd):(n.authtoken||n.authToken||n.token)&&(e.clear(),e.authtoken=n.authtoken||n.authToken||n.token),e.req(e.parameters.apppath+"?action=session",void 0,function(c,l){var d=e.parse(c,l);e.debug("["+o+"] HTTP status = "+l+", response type = "+d.type),d.type==="error"?(n.error||e.error||f).call(e,e.getError(d.response,void 0,o)):(e.sessionid=d.response.id,e.debug("["+o+"] Session ID = "+e.sessionid),e.username=d.response.login,e.username&&e.debug("["+o+"] Username = "+e.username),e.authtoken=d.response.authtoken,e.authtoken&&e.debug("["+o+"] Auth token = "+e.authtoken),e.grant=new Grant({login:d.response.login,userid:d.response.userid,firstname:d.response.firstanme,lastname:d.response.lastname,email:d.response.email}),a&&a.call(e,d.response))},function(c){(n.error||e.error||f).call(e,e.getError(c,void 0,o))})})},this.logout=function(n){var o="Session.logout";return n=n||{},new Promise(function(a,f){e.req(e.parameters.apppath+"?action=logout",void 0,function(c,l){var d=e.parse(c,l);e.debug("["+o+"] HTTP status = "+l+", response type = "+d.type),d.type==="error"?(n.error||e.error||f).call(e,e.getError(d.response,void 0,o)):(e.clear(),a&&a.call(e,d.response))},function(c){c.status===401&&(e.authtoken=void 0),(n.error||e.error||f).call(e,e.getError(c,void 0,o))})})},this.getGrant=function(n){var o="Session.getGrant";return n=n||{},new Promise(function(a,f){var c="&web=true",l=!!n.inlinePicture||!!n.picture;l&&(c+="&inline_picture=true");var d=!!n.includeTexts||!!n.texts;d&&(c+="&texts=true"),e.req(e.parameters.apppath+"?action=getgrant"+c,void 0,function(h,E){var p=e.parse(h,E);e.debug("["+o+"] HTTP status = "+E+", response type = "+p.type),p.type==="error"?(n.error||e.error||f).call(e,e.getError(p.response,void 0,o)):(e.grant=new Grant(p.response),l&&(e.grant.picture=new Doc(e.grant.picture)),d&&(e.grant.texts=Object.assign(new Map,e.grant.texts)),a&&a.call(e,e.grant))},function(h){(n.error||e.error||f).call(e,e.getError(h,void 0,o))})})},this.changePassword=function(n,o){var a="Session.changePassword";return o=o||{},new Promise(function(f,c){e.req(e.parameters.apppath+"?action=setpassword&password="+encodeURIComponent(n),void 0,function(l,d){var h=e.parse(l,d);e.debug("["+a+"] HTTP status = "+d+", response type = "+h.type),h.type==="error"?(o.error||e.error||c).call(e,e.getError(h.response,void 0,a)):f&&f.call(e,h.response)},function(l){(o.error||e.error||c).call(e,e.getError(l,void 0,a))})})},this.getAppInfo=function(n){var o="Session.getAppInfo";return n=n||{},new Promise(function(a,f){e.req(e.parameters.apppath+"?action=getinfo",void 0,function(c,l){var d=e.parse(c,l);e.debug("["+o+"] HTTP status = "+l+", response type = "+d.type),d.type==="error"?(n.error||e.error||f).call(e,e.getError(d.response,void 0,o)):(e.appinfo=d.response,a&&a.call(e,e.appinfo))},function(c){(n.error||e.error||f).call(e,e.getError(c,void 0,o))})})},this.getSysInfo=function(n){var o="Session.getSysInfo";return n=n||{},new Promise(function(a,f){e.req(e.parameters.apppath+"?action=sysinfo",void 0,function(c,l){var d=e.parse(c,l);e.debug("["+o+"] HTTP status = "+l+", response type = "+d.type),d.type==="error"?(n.error||e.error||f).call(e,e.getError(d.response,void 0,o)):(e.sysinfo=d.response,a&&a.call(e,e.sysinfo))},function(c){(n.error||e.error||f).call(e,e.getError(c,void 0,o))})})},this.getDevInfo=function(n,o){var a="Session.getDevInfo";return o=o||{},new Promise(function(f,c){var l="";n&&(l+="&module="+encodeURIComponent(n)),e.req(e.parameters.apppath+"?action=devinfo"+l,void 0,function(d,h){var E=e.parse(d,h);e.debug("["+a+"] HTTP status = "+h+", response type = "+E.type),E.type==="error"?(o.error||e.error||c).call(e,e.getError(E.response,void 0,a)):(n||(e.devinfo=E.response),f&&f.call(e,E.response))},function(d){(o.error||e.error||c).call(e,e.getError(d,void 0,a))})})},this.getNews=function(n){var o="Session.getHealth";return n=n||{},new Promise(function(a,f){var c="",l=!!n.inlineImages||!!n.images;l&&(c+="&inline_images=true"),e.req(e.parameters.apppath+"?action=news"+c,void 0,function(d,h){var E=e.parse(d,h);if(e.debug("["+o+"] HTTP status = "+h+", response type = "+E.type),E.type==="error")(n.error||e.error||f).call(e,e.getError(E.response,void 0,o));else{e.news=E.response;for(var p=0,R=e.news;p<R.length;p++){var b=R[p];b.image=new Doc(b.image)}a&&a.call(e,e.news)}},function(d){(n.error||e.error||f).call(e,e.getError(d,void 0,o))})})},this.indexSearch=function(n,o,a){var f="Session.indexSearch";return a=a||{},new Promise(function(c,l){var d="";a.metadata===!0&&(d+="&_md=true"),a.context&&(d+="&context="+encodeURIComponent(a.context)),e.req(e.parameters.apppath+"?action=indexsearch&request="+encodeURIComponent(n||"")+(o?"&object="+encodeURIComponent(o):"")+d,void 0,function(h,E){var p=e.parse(h,E);e.debug("["+f+"] HTTP status = "+E+", response type = "+p.type),p.type==="error"?(a.error||e.error||l).call(e,e.getError(p.response,void 0,f)):c&&c.call(e,p.response)},function(h){(a.error||e.error||l).call(e,e.getError(h,void 0,f))})})},this.getBusinessObject=function(n,o){var a=e.getBusinessObjectCacheKey(n,o),f=e.businessObjectCache[a];return f||(f=new BusinessObject(e,n,o),e.businessObjectCache[a]=f),f},this.getExternalObject=function(n){return new ExternalObject(e,n)},this.getResourceURL=function(n,o,a,f){return e.parameters.url+e.parameters.respath+"?code="+encodeURIComponent(n)+"&type="+encodeURIComponent(o||"IMG")+(a?"&object="+encodeURIComponent(a):"")+(f?"&objid="+encodeURIComponent(f):"")+(e.authtoken?"_x_simplicite_authorization_="+encodeURIComponent(e.authtoken):"")},!g)throw new Error("No session parammeters");if(this.endpoint=g.endpoint||"api",this.log=g.logHandler||function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];console.log(n)},this.info=g.infoHandler||function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];console.info("INFO",n)},this.warn=g.warningHandler||function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];console.warn("WARN",n)},this.error=g.errorHandler||function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];console.error("ERROR",n)},this.debugMode=!!g.debug,this.debug=g.debugHandler||function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];e.debugMode&&console.log("DEBUG",n)},g.url)try{g.scheme=g.url.replace(/:.*$/,"");var m=g.url.replace(new RegExp("^"+g.scheme+"://"),"").split(":");if(m.length===1)g.host=m[0].replace(/\/.*$/,""),g.port=g.scheme==="http"?80:443,g.root=m[0].replace(new RegExp("^"+g.host+"/?"),"");else{if(g.host=m[0],g.port=parseInt(m[1].replace(/\/.*$/,""),10),isNaN(g.port))throw new Error("Incorrect port");g.root=m[1].replace(new RegExp("^"+g.port+"/?"),"")}g.root==="/"&&(g.root="")}catch(n){this.error("Unable to parse URL ["+g.url+"]: "+n.message);return}var r=g.scheme||(g.port===443?"https":"http");if(r!=="http"&&r!=="https"){this.error("Incorrect scheme ["+g.scheme+"]");return}var v=g.host||"localhost",i=g.port||8080,t=g.root||"";t==="/"&&(t="");var s=r+"://"+v;(r==="http"&&i!==80||r==="https"&&i!==443)&&(s+=":"+i),t!==""&&(s+=t.startsWith("/")?t:"/"+t),this.debug("[simplicite] Base URL = "+s);var u=this.endpoint==="public"?"":"/"+this.endpoint;this.parameters={scheme:r,host:v,port:i,root:t,url:s,timeout:g.timeout||30,healthpath:(u==="/ui"?u:"")+"/health?format=json",apppath:u+"/json/app",objpath:u+"/json/obj",extpath:u+"/ext",docpath:u+"/raw/document",respath:"/resource"},this.username=g.username||g.login,this.password=g.password||g.pwd,this.authtoken=g.authtoken||g.token,this.businessObjectCache=new Map}return T}(),Doc=function(){function T(g){var e=this;this.getId=function(){return e.id},this.getMIMEType=function(){return e.mime},this.getMimeType=this.getMIMEType,this.setMIMEType=function(m){e.mime=m},this.setMimeType=this.setMIMEType,this.getFilename=function(){return e.filename},this.getFileName=this.getFilename,this.setFilename=function(m){e.filename=m},this.setFileName=this.setFilename,this.getContent=function(){return e.content},this.getThumbnail=function(){return e.thumbnail},this.getContentAsArrayBuffer=function(){return e.getBuffer(e.content).buffer},this.getThumbnailAsArrayBuffer=function(){return e.getBuffer(e.thumbnail||"").buffer},this.getContentAsText=function(){return e.getBuffer(e.content).toString("utf-8")},this.setContent=function(m){e.content=m},this.setContentFromText=function(m){e.content=buffer_1.Buffer.from(m,"utf-8").toString("base64")},this.getDataURL=function(m){if(e.content)return"data:"+e.mime+";base64,"+(m&&e.thumbnail?e.thumbnail:e.content)},this.getValue=function(){return JSON.parse(JSON.stringify(e))},Object.assign(this,g)}return T.prototype.getBuffer=function(g){return buffer_1.Buffer.from(g,"base64")},T}(),Grant=function(){function T(g){var e=this;this.getUserId=function(){return e.userid},this.getUsername=function(){return e.login},this.getLogin=this.getUsername,this.getLang=function(){return e.lang},this.getEmail=function(){return e.email},this.getFirstname=function(){return e.firstname},this.getFirstName=this.getFirstname,this.getLastname=function(){return e.lastname},this.getLastName=this.getLastname,this.getPictureURL=function(){if(e.picture)return"data:"+e.picture.mime+";base64,"+e.picture.content},this.hasResponsibility=function(m){return e.responsibilities&&e.responsibilities.indexOf(m)!==-1},this.T=function(m){return e.texts&&e.texts[m]||""},Object.assign(this,g)}return T}(),BusinessObjectMetadata=function(){function T(g,e){this.name=g,this.instance=e,this.rowidfield=constants.DEFAULT_ROW_ID_NAME,this.label=g,this.help="",this.fields=new Array}return T}(),BusinessObject=function(){function T(g,e,m){var r=this;this.getMetaData=function(i){var t="BusinessObject.getMetaData",s=r.session;return i=i||{},new Promise(function(u,n){var o="";i.context&&(o+="&context="+encodeURIComponent(i.context)),i.contextParam&&(o+="&contextparam="+encodeURIComponent(i.contextParam)),s.req(r.path+"&action=metadata"+o,void 0,function(a,f){var c=s.parse(a,f);s.debug("["+t+"] HTTP status = "+f+", response type = "+c.type),c.type==="error"?(i.error||s.error||n).call(r,s.getError(c.response,void 0,t)):(r.metadata=c.response,u&&u.call(r,r.metadata))},function(a){(i.error||s.error||n).call(r,s.getError(a,void 0,t))})})},this.getMetadata=this.getMetaData,this.getName=function(){return r.metadata.name},this.getInstance=function(){return r.metadata.instance},this.getLabel=function(){return r.metadata.label},this.getHelp=function(){return r.metadata.help},this.getFields=function(){return r.metadata.fields},this.getField=function(i){for(var t=r.getFields(),s=0;s<t.length&&t[s].name!==i;)s++;if(s<t.length)return t[s]},this.getRowIdFieldName=function(){return r.metadata.rowidfield},this.getRowIdField=function(){return r.getField(r.getRowIdFieldName())},this.getLinks=function(){return r.metadata.links},this.getFieldType=function(i){if(typeof i=="string"&&(i=r.getField(i)),i)return i.type},this.getFieldLabel=function(i){if(typeof i=="string"&&(i=r.getField(i)),i)return i.label},this.getFieldValue=function(i,t){if(t||(t=r.item),i&&t){var s=t[typeof i=="string"?i:i.name];return s&&s.mime?new Doc(s):s}},this.getFieldListValue=function(i,t){typeof i=="string"&&(i=r.getField(i));var s=r.getFieldValue(i,t);return i&&i.listOfValues?r.getListValue(i.listOfValues,s):s},this.getFieldDataURL=function(i,t){typeof i!="string"&&(i=i.fullinput||i.name);var s=r.getFieldValue(i,t);if(s&&s.mime)return"data:"+s.mime+";base64,"+(s.content||s.thumbnail)},this.getFieldDocument=function(i,t){typeof i!="string"&&(i=i.fullinput||i.input||i.name);var s=r.getFieldValue(i,t);return s&&s.mime?new Doc(s):s},this.getFieldDocumentURL=function(i,t,s){typeof i!="string"&&(i=i.fullinput||i.input||i.name);var u=r.getFieldValue(i,t);if(u&&u.mime&&(u=u.id),u)return r.session.parameters.url+r.session.parameters.docpath+"?object="+encodeURIComponent(r.metadata.name)+"&inst="+encodeURIComponent(r.metadata.instance)+"&field="+encodeURIComponent(i)+"&row_id="+encodeURIComponent(r.getRowId(t))+"&doc_id="+encodeURIComponent(u)+(s?"&thumbnail=true":"")+(r.session.authtoken?"&_x_simplicite_authorization_="+encodeURIComponent(r.session.authtoken):"")},this.getListValue=function(i,t){if(i)for(var s=0,u=i;s<u.length;s++){var n=u[s];if(n.code===t)return n.value}return t},this.setFieldValue=function(i,t,s){s||(s=r.item),i&&s&&(s[typeof i=="string"?i:i.name]=t instanceof Doc?t.getValue():t)},this.isRowIdField=function(i){return!i.ref&&i.name===r.metadata.rowidfield},this.isTimestampField=function(i){var t=i.name;return!i.ref&&(t==="created_by"||t==="created_dt"||t==="updated_by"||t==="updated_dt")},this.getFilters=function(i){var t="BusinessObject.getFilters",s=r.session;return i=i||{},new Promise(function(u,n){var o="";i.context&&(o+="&context="+encodeURIComponent(i.context)),i.reset&&(o+="&reset="+!!i.reset),s.req(r.path+"&action=filters"+o,void 0,function(a,f){var c=s.parse(a,f);s.debug("["+t+"] HTTP status = "+f+", response type = "+c.type),c.type==="error"?(i.error||s.error||n).call(r,s.getError(c.response,void 0,t)):(r.filters=c.response,u&&u.call(r,r.filters))},function(a){(i.error||s.error||n).call(r,s.getError(a,void 0,t))})})},this.getReqOptions=function(i){var t="";i.context&&(t+="&context="+encodeURIComponent(i.context));var s=i.inlineDocs||i.inlineDocuments||i.inlineImages;s&&(t+="&inline_documents="+encodeURIComponent(s.join?s.join(","):s));var u=i.inlineThumbs||i.inlineThumbnails;u&&(t+="&inline_thumbnails="+encodeURIComponent(u.join?u.join(","):u));var n=i.inlineObjs||i.inlineObjects;return n&&(t+="&inline_objects="+encodeURIComponent(n.join?n.join(","):n)),t},this.getReqParams=function(i){var t="";if(!i)return t;for(var s=0,u=Object.entries(i);s<u.length;s++){var n=u[s],o=n[0],a=n[1]||"";if(a.name&&a.content)a.content.startsWith("data:")&&(a.content=a.content.replace(/data:.*;base64,/,"")),t+=(t!==""?"&":"")+o+"="+encodeURIComponent("id|"+(a.id?a.id:"0")+"|name|"+a.name+"|content|"+a.content);else if(a.object&&a.row_id)t+=(t!==""?"&":"")+o+"="+encodeURIComponent("object|"+a.object+"|row_id|"+a.row_id);else if(a.sort)for(var f=0,c=a;f<c.length;f++){var l=c[f];t+=(t!==""?"&":"")+o+"="+encodeURIComponent(l)}else t+=(t!==""?"&":"")+o+"="+encodeURIComponent(a)}return t},this.getCount=function(i,t){var s="BusinessObject.getCount",u=r.session;return t=t||{},new Promise(function(n,o){r.filters=i||{},u.req(r.path+"&action=count",r.getReqParams(r.filters),function(a,f){var c=u.parse(a,f);u.debug("["+s+"] HTTP status = "+f+", response type = "+c.type),c.type==="error"?(t.error||u.error||o).call(r,u.getError(c.response,void 0,s)):(r.count=c.response.count,r.page=c.response.page>=0?c.response.page+1:void 0,r.maxpage=c.response.maxpage>=0?c.response.maxpage+1:void 0,r.list=[],n&&n.call(r,r.count))},function(a){(t.error||u.error||o).call(r,u.getError(a,void 0,s))})})},this.search=function(i,t){var s="BusinessObject.search",u=r.session;return t=t||{},new Promise(function(n,o){var a=r.getReqOptions(t);t.page>0&&(a+="&page="+(t.page-1)),t.metadata===!0&&(a+="&_md=true"),t.visible===!0&&(a+="&_visible=true"),r.filters=i||{},u.req(r.path+"&action=search"+a,r.getReqParams(r.filters),function(f,c){var l=u.parse(f,c);u.debug("["+s+"] HTTP status = "+c+", response type = "+l.type),l.type==="error"?(t.error||u.error||o).call(r,u.getError(l.response,void 0,s)):(f.meta&&(r.metadata=l.response.meta),r.count=l.response.count,r.page=l.response.page>=0?l.response.page+1:void 0,r.maxpage=l.response.maxpage>=0?l.response.maxpage+1:void 0,r.list=l.response.list,n&&n.call(r,r.list))},function(f){(t.error||u.error||o).call(r,u.getError(f,void 0,s))})})},this.get=function(i,t){var s="BusinessObject.get",u=r.session;return t=t||{},new Promise(function(n,o){var a=r.getReqOptions(t),f=t.treeView;if(f&&(a+="&treeview="+encodeURIComponent(f)),t.fields)for(var c=0,l=t.fields.length;c<l.length;c++){var d=l[c];a+="&fields="+encodeURIComponent(d.replace(".","__"))}t.metadata&&(a+="&_md=true"),t.social&&(a+="&_social=true"),u.req(r.path+"&action=get&"+r.metadata.rowidfield+"="+encodeURIComponent(i)+a,void 0,function(h,E){var p=u.parse(h,E);u.debug("[simplicite.BusinessObject.get] HTTP status = "+E+", response type = "+p.type),p.type==="error"?(t.error||u.error||o).call(r,u.getError(p.response,void 0,s)):(p.response.meta&&(r.metadata=p.response.meta),p.response.data?r.item=f?p.response.data.item:p.response.data:r.item=f?p.response.item:p.response,n&&n.call(r,f?p.response:r.item))},function(h){(t.error||u.error||o).call(r,u.getError(h,void 0,s))})})},this.getForCreate=function(i){return i=i||{},delete i.treeview,delete i.fields,i.context=constants.CONTEXT_CREATE,r.get(r.session.constants.DEFAULT_ROW_ID,i)},this.getForUpdate=function(i,t){return t=t||{},delete t.treeview,delete t.fields,t.context=constants.CONTEXT_UPDATE,r.get(i,t)},this.getForCopy=function(i,t){return t=t||{},delete t.treeview,delete t.fields,t.context=constants.CONTEXT_COPY,r.get(i,t)},this.getForDelete=function(i,t){return t=t||{},delete t.treeview,delete t.fields,t.context=constants.CONTEXT_DELETE,r.get(i,t)},this.getRowId=function(i){if(i=i||r.item,i)return i[r.getRowIdFieldName()]},this.populate=function(i,t){var s="BusinessObject.populate",u=r.session;return t=t||{},new Promise(function(n,o){var a=r.getReqOptions(t);u.req(r.path+"&action=populate&"+r.metadata.rowidfield+"="+encodeURIComponent(i)+a,void 0,function(f,c){var l=u.parse(f,c);u.debug("["+s+"] HTTP status = "+c+", response type = "+l.type),l.type==="error"?(t.error||u.error||o).call(r,u.getError(l.response,void 0,s)):(r.item=l.response.data?l.response.data:l.response,n&&n.call(r,r.item))},function(f){(t.error||u.error||o).call(r,u.getError(f,void 0,s))})})},this.save=function(i,t){i&&(r.item=i);var s=r.item[r.metadata.rowidfield];return!s||s===constants.DEFAULT_ROW_ID?r.create(i,t):r.update(i,t)},this.create=function(i,t){var s="BusinessObject.create",u=r.session;return t=t||{},new Promise(function(n,o){i&&(r.item=i),r.item.row_id=u.constants.DEFAULT_ROW_ID;var a=r.getReqOptions(t);u.req(r.path+"&action=create"+a,r.getReqParams(r.item),function(f,c){var l=u.parse(f,c);u.debug("["+s+"] HTTP status = "+c+", response type = "+l.type),l.type==="error"?(t.error||u.error||o).call(r,u.getError(l.response,void 0,s)):(r.item=l.response.data?l.response.data:l.response,n&&n.call(r,r.item))},function(f){(t.error||u.error||o).call(r,u.getError(f,void 0,s))})})},this.update=function(i,t){var s="BusinessObject.update",u=r.session;return t=t||{},new Promise(function(n,o){i&&(r.item=i);var a=r.getReqOptions(t);u.req(r.path+"&action=update"+a,r.getReqParams(r.item),function(f,c){var l=u.parse(f,c);u.debug("["+s+"] HTTP status = "+c+", response type = "+l.type),l.type==="error"?(t.error||u.error||o).call(r,u.getError(l.response,void 0,s)):(r.item=l.response.data?l.response.data:l.response,n&&n.call(r,r.item))},function(f){(t.error||u.error||o).call(r,u.getError(f,void 0,s))})})},this.del=function(i,t){var s="BusinessObject.del",u=r.session;return t=t||{},new Promise(function(n,o){i&&(r.item=i),u.req(r.path+"&action=delete&"+r.metadata.rowidfield+"="+encodeURIComponent(r.item[r.metadata.rowidfield]),void 0,function(a,f){var c=u.parse(a,f);u.debug("["+s+"] HTTP status = "+f+", response type = "+c.type),c.type==="error"?(t.error||u.error||o).call(r,u.getError(c.response,void 0,s)):(r.item=void 0,delete c.response.undoredo,n&&n.call(r,c.response))},function(a){(t.error||u.error||o).call(r,u.getError(a,void 0,s))})})},this.action=function(i,t,s){var u="BusinessObject.action("+i+")",n=r.session;return s=s||{},new Promise(function(o,a){n.req(r.path+"&action="+encodeURIComponent(i)+(t?"&"+r.getRowIdFieldName()+"="+encodeURIComponent(t):""),r.getReqParams(s.parameters),function(f,c){var l=n.parse(f,c);if(n.debug("["+u+"] HTTP status = "+c+", response type = "+l.type),l.type==="error")(s.error||n.error||a).call(r,n.getError(l.response,void 0,u));else{var d=l.response.result;o&&o.call(r,d)}},function(f){(s.error||n.error||a).call(r,n.getError(f,void 0,u))})})},this.crosstab=function(i,t){var s="BusinessObject.crosstab("+i+")",u=r.session;return t=t||{},new Promise(function(n,o){t.filters&&(r.filters=t.filters),u.req(r.path+"&action=crosstab&crosstab="+encodeURIComponent(i),r.getReqParams(r.filters),function(a,f){var c=u.parse(a,f);u.debug("["+s+"] HTTP status = "+f+", response type = "+c.type),c.type==="error"?(t.error||u.error||o).call(r,u.getError(c.response,void 0,s)):n&&n.call(r,c.response)},function(a){(t.error||u.error||o).call(r,u.getError(a,void 0,s))})})},this.print=function(i,t,s){var u="BusinessObject.print("+i+")",n=r.session;return s=s||{},new Promise(function(o,a){s.filters&&(r.filters=s.filters);var f="";s.all&&(f+="&all="+!!s.all),s.mailing&&(f+="&mailing="+!!s.mailing),n.req(r.path+"&action=print&printtemplate="+encodeURIComponent(i)+(t?"&"+r.getRowIdFieldName()+"="+encodeURIComponent(t):"")+f,void 0,function(c,l){var d=n.parse(c,l);n.debug("["+u+"] HTTP status = "+l+", response type = "+d.type),d.type==="error"?(s.error||n.error||a).call(r,n.getError(d.response,void 0,u)):o&&o.call(r,new Doc(d.response))},function(c){(s.error||n.error||a).call(r,n.getError(c,void 0,u))})})},this.setParameter=function(i,t,s){var u="BusinessObject.setParameter",n=r.session;return s=s||{},new Promise(function(o,a){var f={name:i};t&&(f.value=t),n.req(r.path+"&action=setparameter",r.getReqParams(f),function(c,l){var d=n.parse(c,l);if(n.debug("["+u+"] HTTP status = "+l+", response type = "+d.type),d.type==="error")(s.error||n.error||a).call(r,d.response);else{var h=d.response.result;o&&o.call(r,h)}},function(c){(s.error||n.error||a).call(r,n.getError(c))})})},this.getParameter=function(i,t){var s="BusinessObject.getParameter",u=r.session;return t=t||{},new Promise(function(n,o){var a={name:i};u.req(r.path+"&action=getparameter",r.getReqParams(a),function(f,c){var l=u.parse(f,c);if(u.debug("["+s+"] HTTP status = "+c+", response type = "+l.type),l.type==="error")(t.error||u.error||o).call(r,l.response);else{var d=l.response.result;n&&n.call(r,d)}},function(f){(t.error||u.error||o).call(r,u.getError(f))})})},this.getResourceURL=function(i,t){return r.session.getResourceURL(i,t,r.metadata.name,r.metadata.id)},this.session=g;var v=m||"api_"+e;this.metadata=new BusinessObjectMetadata(e,v),this.cacheKey=this.session.getBusinessObjectCacheKey(e,v),this.path=this.session.parameters.objpath+"?object="+encodeURIComponent(e)+"&inst="+encodeURIComponent(v),this.item={},this.filters={},this.list=[]}return T}(),ExternalObjectMetadata=function(){function T(g){this.name=g}return T}(),ExternalObject=function(){function T(g,e){var m=this;this.getName=function(){return m.metadata.name},this.callParams=function(r){var v="";if(!r)return v;for(var i=0,t=Object.entries(r);i<t.length;i++){var s=t[i],u=s[0],n=s[1]||"";if(n.sort)for(var o=0,a=n;o<a.length;o++){var f=a[o];v+=(v!==""?"&":"")+u+"="+encodeURIComponent(f)}else v+=(v!==""?"&":"")+u+"="+encodeURIComponent(n)}return v},this.call=function(r,v,i){var t="ExternalObject.call",s=m.session;return i=i||{},new Promise(function(u,n){var o="";r&&(o="?"+m.callParams(r));var a=i.method?i.method.toUpperCase():v?"POST":"GET",f={};i.contentType?f["Content-Type"]=i.contentType:v&&(f["Content-Type"]=typeof v=="string"?"application/x-www-form-urlencoded":"application/json");var c=s.getBearerTokenHeader();c?f["X-Simplicite-Authorization"]=c:(c=s.getBasicAuthHeader(),c&&(f.Authorization=c));var l=s.parameters.url+m.path+o,d=v?typeof v=="string"?v:JSON.stringify(v):void 0;s.debug("[simplicite.ExternalObject.call] "+a+" "+l+" with "+(d?" with "+d:"")),(0,node_fetch_1.default)(l,{method:a,headers:f,timeout:s.parameters.timeout*1e3,mode:"cors",credentials:"include",body:d}).then(function(h){var E=h.headers.get("content-type");s.debug("["+t+"] HTTP status = "+h.status+", response content type = "+E),E&&E.startsWith("application/json")?h.json().then(function(p){u&&u.call(m,p,h.status,h.headers)}).catch(function(p){(i.error||s.error||n).call(m,s.getError(p,void 0,t))}):E&&E.startsWith("text/")?h.text().then(function(p){u&&u.call(m,p,h.status,h.headers)}).catch(function(p){(i.error||s.error||n).call(m,s.getError(p,void 0,t))}):h.arrayBuffer().then(function(p){u&&u.call(m,p,h.status,h.headers)}).catch(function(p){(i.error||s.error||n).call(m,s.getError(p,void 0,t))})}).catch(function(h){(i.error||s.error||n).call(m,s.getError(h,void 0,t))})})},this.invoke=this.call,this.session=g,this.metadata=new ExternalObjectMetadata(e),this.path=this.session.parameters.extpath+"/"+encodeURIComponent(e)}return T}();exports.default={constants,session,Session,Doc,Grant,BusinessObject,BusinessObjectMetadata,ExternalObject};
//# sourceMappingURL=simplicite.min.js.map

"use strict";/**
 * Simplicite(R) platform Javascript API client module (for node.js and browser).
 * @module simplicite
 * @version 2.2.3
 * @license Apache-2.0
 */var __importDefault=this&&this.__importDefault||function(E){return E&&E.__esModule?E:{default:E}};Object.defineProperty(exports,"__esModule",{value:!0});var node_fetch_1=__importDefault(require("node-fetch")),buffer_1=require("buffer"),constants={MODULE_VERSION:"2.2.3",DEFAULT_ROW_ID_NAME:"row_id",DEFAULT_ROW_ID:"0",CONTEXT_NONE:0,CONTEXT_SEARCH:1,CONTEXT_LIST:2,CONTEXT_CREATE:3,CONTEXT_COPY:4,CONTEXT_UPDATE:5,CONTEXT_DELETE:6,CONTEXT_GRAPH:7,CONTEXT_CROSSTAB:8,CONTEXT_PRINTTMPL:9,CONTEXT_UPDATEALL:10,CONTEXT_REFSELECT:11,CONTEXT_DATAMAPSELECT:12,CONTEXT_PREVALIDATE:13,CONTEXT_POSTVALIDATE:14,CONTEXT_STATETRANSITION:15,CONTEXT_EXPORT:16,CONTEXT_IMPORT:17,CONTEXT_ASSOCIATE:18,CONTEXT_PANELLIST:19,TYPE_ID:0,TYPE_INT:1,TYPE_FLOAT:2,TYPE_STRING:3,TYPE_DATE:4,TYPE_DATETIME:5,TYPE_TIME:6,TYPE_ENUM:7,TYPE_BOOLEAN:8,TYPE_PASSWORD:9,TYPE_URL:10,TYPE_HTML:11,TYPE_EMAIL:12,TYPE_LONG_STRING:13,TYPE_ENUM_MULTI:14,TYPE_REGEXP:15,TYPE_DOC:17,TYPE_FLOAT_EMPTY:18,TYPE_EXTFILE:19,TYPE_IMAGE:20,TYPE_NOTEPAD:21,TYPE_PHONENUM:22,TYPE_COLOR:23,TYPE_OBJECT:24,TYPE_GEOCOORDS:25,VIS_NOT:0,VIS_HIDDEN:0,VIS_LIST:1,VIS_FORM:2,VIS_BOTH:3,SEARCH_NONE:0,SEARCH_MONO:1,SEARCH_MULTI_CHECK:2,SEARCH_MULTI_LIST:3,SEARCH_PERIOD:4,TRUE:"1",FALSE:"0",ERRLEVEL_FATAL:1,ERRLEVEL_ERROR:2,ERRLEVEL_WARNING:3,RESOURCE_TYPE_IMAGE:"IMG",RESOURCE_TYPE_ICON:"ICO",RESOURCE_TYPE_STYLESHEET:"CSS",RESOURCE_TYPE_JAVASCRIPT:"JS"},session=function(E){return new Session(E)},Session=function(){function E(g){var e=this;if(this.constants=constants,this.setUsername=function(n){e.username=n},this.setPassword=function(n){e.password=n},this.setAuthToken=function(n){e.authtoken=n},this.getBusinessObjectCacheKey=function(n,s){return n+":"+(s||"js_"+n)},this.clear=function(){e.username=void 0,e.password=void 0,e.authtoken=void 0,e.sessionid=void 0,e.grant=void 0,e.appinfo=void 0,e.sysinfo=void 0,e.devinfo=void 0,e.businessObjectCache=new Map},this.getBasicAuthHeader=function(){return e.username&&e.password?"Basic "+buffer_1.Buffer.from(e.username+":"+e.password).toString("base64"):void 0},this.getBearerTokenHeader=function(){return e.authtoken?"Bearer "+e.authtoken:void 0},this.getError=function(n,s,c){if(typeof n=="string")return{message:n,status:s||200,origin:c};if(n.response){if(typeof n.response=="string")return{message:n.response,status:s||200,origin:c};if(c)try{n.response.origin=c}catch{}return n.response}else{if(c)try{n.origin=c}catch{}return n}},this.req=function(n,s,c,f){var u="Session.req",l=s?"POST":"GET",d={};s&&(d["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8");var h=e.getBearerTokenHeader();h?d["X-Simplicite-Authorization"]=h:(h=e.getBasicAuthHeader(),h&&(d.Authorization=h));var T=e.parameters.url+n||"/",m=s?typeof s=="string"?s:JSON.stringify(s):void 0;e.debug("["+u+"] "+l+" "+T+(m?" with "+m:"")),(0,node_fetch_1.default)(T,{method:l,headers:d,timeout:e.parameters.timeout*1e3,mode:"cors",credentials:"include",body:m}).then(function(R){c&&R.text().then(function(b){c.call(e,b,R.status,R.headers)})}).catch(function(R){var b=R.response&&R.response.status?R.response.status:void 0,y=R.response&&R.response.data?R.response.data:R;if(f)f.call(e,e.getError(y,b,u));else throw y})},this.parse=function(n,s){try{return s!==200?{type:"error",response:e.getError("HTTP status: "+s,s)}:typeof n=="object"?n:JSON.parse(n)}catch(c){return{type:"error",response:e.getError("Parsing error: "+c.message,s)}}},this.getHealth=function(n){var s="Session.getHealth";return n=n||{},new Promise(function(c,f){e.req(e.parameters.healthpath+"&full="+!!n.full,void 0,function(u,l){var d=e.parse(u,l);e.debug("["+s+"] HTTP status = "+l+", response type = "+u),d.type==="error"?(n.error||e.error||f).call(e,e.getError(d.response,void 0,s)):c&&c.call(e,d)},function(u){(n.error||e.error||f).call(e,e.getError(u,void 0,s))})})},this.login=function(n){var s="Session.login";return n=n||{},new Promise(function(c,f){(n.username||n.login)&&(n.password||n.pwd)?(e.clear(),e.username=n.username||n.login,e.password=n.password||n.pwd):(n.authtoken||n.authToken||n.token)&&(e.clear(),e.authtoken=n.authtoken||n.authToken||n.token),e.req(e.parameters.apppath+"?action=session",void 0,function(u,l){var d=e.parse(u,l);e.debug("["+s+"] HTTP status = "+l+", response type = "+d.type),d.type==="error"?(n.error||e.error||f).call(e,e.getError(d.response,void 0,s)):(e.sessionid=d.response.id,e.debug("["+s+"] Session ID = "+e.sessionid),e.username=d.response.login,e.username&&e.debug("["+s+"] Username = "+e.username),e.authtoken=d.response.authtoken,e.authtoken&&e.debug("["+s+"] Auth token = "+e.authtoken),e.grant=new Grant({login:d.response.login,userid:d.response.userid,firstname:d.response.firstanme,lastname:d.response.lastname,email:d.response.email}),c&&c.call(e,d.response))},function(u){(n.error||e.error||f).call(e,e.getError(u,void 0,s))})})},this.logout=function(n){var s="Session.logout";return n=n||{},new Promise(function(c,f){e.req(e.parameters.apppath+"?action=logout",void 0,function(u,l){var d=e.parse(u,l);e.debug("["+s+"] HTTP status = "+l+", response type = "+d.type),d.type==="error"?(n.error||e.error||f).call(e,e.getError(d.response,void 0,s)):(e.clear(),c&&c.call(e,d.response))},function(u){u.status===401&&(e.authtoken=void 0),(n.error||e.error||f).call(e,e.getError(u,void 0,s))})})},this.getGrant=function(n){var s="Session.getGrant";return n=n||{},new Promise(function(c,f){var u="&web=true",l=!!n.inlinePicture||!!n.picture;l&&(u+="&inline_picture=true");var d=!!n.includeTexts||!!n.texts;d&&(u+="&texts=true"),e.req(e.parameters.apppath+"?action=getgrant"+u,void 0,function(h,T){var m=e.parse(h,T);e.debug("["+s+"] HTTP status = "+T+", response type = "+m.type),m.type==="error"?(n.error||e.error||f).call(e,e.getError(m.response,void 0,s)):(e.grant=new Grant(m.response),l&&(e.grant.picture=new Doc(e.grant.picture)),d&&(e.grant.texts=Object.assign(new Map,e.grant.texts)),c&&c.call(e,e.grant))},function(h){(n.error||e.error||f).call(e,e.getError(h,void 0,s))})})},this.changePassword=function(n,s){var c="Session.changePassword";return s=s||{},new Promise(function(f,u){e.req(e.parameters.apppath+"?action=setpassword&password="+encodeURIComponent(n),void 0,function(l,d){var h=e.parse(l,d);e.debug("["+c+"] HTTP status = "+d+", response type = "+h.type),h.type==="error"?(s.error||e.error||u).call(e,e.getError(h.response,void 0,c)):f&&f.call(e,h.response)},function(l){(s.error||e.error||u).call(e,e.getError(l,void 0,c))})})},this.getAppInfo=function(n){var s="Session.getAppInfo";return n=n||{},new Promise(function(c,f){e.req(e.parameters.apppath+"?action=getinfo",void 0,function(u,l){var d=e.parse(u,l);e.debug("["+s+"] HTTP status = "+l+", response type = "+d.type),d.type==="error"?(n.error||e.error||f).call(e,e.getError(d.response,void 0,s)):(e.appinfo=d.response,c&&c.call(e,e.appinfo))},function(u){(n.error||e.error||f).call(e,e.getError(u,void 0,s))})})},this.getSysInfo=function(n){var s="Session.getSysInfo";return n=n||{},new Promise(function(c,f){e.req(e.parameters.apppath+"?action=sysinfo",void 0,function(u,l){var d=e.parse(u,l);e.debug("["+s+"] HTTP status = "+l+", response type = "+d.type),d.type==="error"?(n.error||e.error||f).call(e,e.getError(d.response,void 0,s)):(e.sysinfo=d.response,c&&c.call(e,e.sysinfo))},function(u){(n.error||e.error||f).call(e,e.getError(u,void 0,s))})})},this.getDevInfo=function(n,s){var c="Session.getDevInfo";return s=s||{},new Promise(function(f,u){var l="";n&&(l+="&module="+encodeURIComponent(n)),e.req(e.parameters.apppath+"?action=devinfo"+l,void 0,function(d,h){var T=e.parse(d,h);e.debug("["+c+"] HTTP status = "+h+", response type = "+T.type),T.type==="error"?(s.error||e.error||u).call(e,e.getError(T.response,void 0,c)):(n||(e.devinfo=T.response),f&&f.call(e,T.response))},function(d){(s.error||e.error||u).call(e,e.getError(d,void 0,c))})})},this.getNews=function(n){var s="Session.getHealth";return n=n||{},new Promise(function(c,f){var u="",l=!!n.inlineImages||!!n.images;l&&(u+="&inline_images=true"),e.req(e.parameters.apppath+"?action=news"+u,void 0,function(d,h){var T=e.parse(d,h);if(e.debug("["+s+"] HTTP status = "+h+", response type = "+T.type),T.type==="error")(n.error||e.error||f).call(e,e.getError(T.response,void 0,s));else{e.news=T.response;for(var m=0,R=e.news;m<R.length;m++){var b=R[m];b.image=new Doc(b.image)}c&&c.call(e,e.news)}},function(d){(n.error||e.error||f).call(e,e.getError(d,void 0,s))})})},this.indexSearch=function(n,s,c){var f="Session.indexSearch";return c=c||{},new Promise(function(u,l){var d="";c.metadata===!0&&(d+="&_md=true"),c.context&&(d+="&context="+encodeURIComponent(c.context)),e.req(e.parameters.apppath+"?action=indexsearch&request="+encodeURIComponent(n||"")+(s?"&object="+encodeURIComponent(s):"")+d,void 0,function(h,T){var m=e.parse(h,T);e.debug("["+f+"] HTTP status = "+T+", response type = "+m.type),m.type==="error"?(c.error||e.error||l).call(e,e.getError(m.response,void 0,f)):u&&u.call(e,m.response)},function(h){(c.error||e.error||l).call(e,e.getError(h,void 0,f))})})},this.getBusinessObject=function(n,s){var c=e.getBusinessObjectCacheKey(n,s),f=e.businessObjectCache[c];return f||(f=new BusinessObject(e,n,s),e.businessObjectCache[c]=f),f},this.getExternalObject=function(n){return new ExternalObject(e,n)},this.getResourceURL=function(n,s,c,f){return e.parameters.url+e.parameters.respath+"?code="+encodeURIComponent(n)+"&type="+encodeURIComponent(s||"IMG")+(c?"&object="+encodeURIComponent(c):"")+(f?"&objid="+encodeURIComponent(f):"")+(e.authtoken?"_x_simplicite_authorization_="+encodeURIComponent(e.authtoken):"")},!g)throw"No session parammeters";if(this.endpoint=g.endpoint||"api",this.log=g.logHandler||function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];console.log(n)},this.info=g.infoHandler||function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];console.info("INFO",n)},this.warn=g.warningHandler||function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];console.warn("WARN",n)},this.error=g.errorHandler||function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];console.error("ERROR",n)},this.debugMode=!!g.debug,this.debug=g.debugHandler||function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];e.debugMode&&console.log("DEBUG",n)},g.url)try{g.scheme=g.url.replace(/:.*$/,"");var p=g.url.replace(new RegExp("^"+g.scheme+"://"),"").split(":");if(p.length===1)g.host=p[0].replace(/\/.*$/,""),g.port=g.scheme==="http"?80:443,g.root=p[0].replace(new RegExp("^"+g.host+"/?"),"");else{if(g.host=p[0],g.port=parseInt(p[1].replace(/\/.*$/,""),10),isNaN(g.port))throw new Error("Incorrect port");g.root=p[1].replace(new RegExp("^"+g.port+"/?"),"")}g.root==="/"&&(g.root="")}catch(n){this.error("Unable to parse URL ["+g.url+"]: "+n.message);return}var r=g.scheme||(g.port===443?"https":"http");if(r!=="http"&&r!=="https"){this.error("Incorrect scheme ["+g.scheme+"]");return}var v=g.host||"localhost",t=g.port||8080,i=g.root||"";i==="/"&&(i="");var o=r+"://"+v;(r==="http"&&t!=80||r==="https"&&t!=443)&&(o+=":"+t),i!==""&&(o+=i.startsWith("/")?i:"/"+i),this.debug("[simplicite] Base URL = "+o);var a=this.endpoint=="public"?"":"/"+this.endpoint;this.parameters={scheme:r,host:v,port:t,root:i,url:o,timeout:g.timeout||30,healthpath:(a=="/ui"?a:"")+"/health?format=json",apppath:a+"/json/app",objpath:a+"/json/obj",extpath:a+"/ext",docpath:a+"/raw/document",respath:"/resource"},this.username=g.username||g.login,this.password=g.password||g.pwd,this.authtoken=g.authtoken||g.token,this.businessObjectCache=new Map}return E}(),Doc=function(){function E(g){var e=this;this.getId=function(){return e.id},this.getMIMEType=function(){return e.mime},this.getMimeType=this.getMIMEType,this.setMIMEType=function(p){e.mime=p},this.setMimeType=this.setMIMEType,this.getFilename=function(){return e.filename},this.getFileName=this.getFilename,this.setFilename=function(p){e.filename=p},this.setFileName=this.setFilename,this.getContent=function(){return e.content},this.getThumbnail=function(){return e.thumbnail},this.getContentAsArrayBuffer=function(){return e.getBuffer(e.content).buffer},this.getThumbnailAsArrayBuffer=function(){return e.getBuffer(e.thumbnail||"").buffer},this.getContentAsText=function(){return e.getBuffer(e.content).toString("utf-8")},this.setContent=function(p){e.content=p},this.setContentFromText=function(p){e.content=buffer_1.Buffer.from(p,"utf-8").toString("base64")},this.getDataURL=function(p){if(e.content)return"data:"+e.mime+";base64,"+(p&&e.thumbnail?e.thumbnail:e.content)},this.getValue=function(){return JSON.parse(JSON.stringify(e))},Object.assign(this,g)}return E.prototype.getBuffer=function(g){return buffer_1.Buffer.from(g,"base64")},E}(),Grant=function(){function E(g){var e=this;this.getUserId=function(){return e.userid},this.getUsername=function(){return e.login},this.getLogin=this.getUsername,this.getLang=function(){return e.lang},this.getEmail=function(){return e.email},this.getFirstname=function(){return e.firstname},this.getFirstName=this.getFirstname,this.getLastname=function(){return e.lastname},this.getLastName=this.getLastname,this.getPictureURL=function(){if(e.picture)return"data:"+e.picture.mime+";base64,"+e.picture.content},this.hasResponsibility=function(p){return e.responsibilities&&e.responsibilities.indexOf(p)!==-1},this.T=function(p){return e.texts&&e.texts[p]||""},Object.assign(this,g)}return E}(),BusinessObjectMetadata=function(){function E(g,e){this.name=g,this.instance=e,this.rowidfield=constants.DEFAULT_ROW_ID_NAME,this.label=g,this.help="",this.fields=new Array}return E}(),BusinessObject=function(){function E(g,e,p){var r=this;this.getMetaData=function(t){var i="BusinessObject.getMetaData",o=r.session;return t=t||{},new Promise(function(a,n){var s="";t.context&&(s+="&context="+encodeURIComponent(t.context)),t.contextParam&&(s+="&contextparam="+encodeURIComponent(t.contextParam)),o.req(r.path+"&action=metadata"+s,void 0,function(c,f){var u=o.parse(c,f);o.debug("["+i+"] HTTP status = "+f+", response type = "+u.type),u.type==="error"?(t.error||o.error||n).call(r,o.getError(u.response,void 0,i)):(r.metadata=u.response,a&&a.call(r,r.metadata))},function(c){(t.error||o.error||n).call(r,o.getError(c,void 0,i))})})},this.getMetadata=this.getMetaData,this.getName=function(){return r.metadata.name},this.getInstance=function(){return r.metadata.instance},this.getLabel=function(){return r.metadata.label},this.getHelp=function(){return r.metadata.help},this.getFields=function(){return r.metadata.fields},this.getField=function(t){for(var i=r.getFields(),o=0;o<i.length&&i[o].name!==t;)o++;if(o<i.length)return i[o]},this.getRowIdFieldName=function(){return r.metadata.rowidfield},this.getRowIdField=function(){return r.getField(r.getRowIdFieldName())},this.getLinks=function(){return r.metadata.links},this.getFieldType=function(t){if(typeof t=="string"&&(t=r.getField(t)),t)return t.type},this.getFieldLabel=function(t){if(typeof t=="string"&&(t=r.getField(t)),t)return t.label},this.getFieldValue=function(t,i){if(i||(i=r.item),t&&i){var o=i[typeof t=="string"?t:t.name];return o&&o.mime?new Doc(o):o}},this.getFieldListValue=function(t,i){typeof t=="string"&&(t=r.getField(t));var o=r.getFieldValue(t,i);return t&&t.listOfValues?r.getListValue(t.listOfValues,o):o},this.getFieldDataURL=function(t,i){typeof t!="string"&&(t=t.fullinput||t.name);var o=r.getFieldValue(t,i);if(o&&o.mime)return"data:"+o.mime+";base64,"+(o.content||o.thumbnail)},this.getFieldDocument=function(t,i){typeof t!="string"&&(t=t.fullinput||t.input||t.name);var o=r.getFieldValue(t,i);return o&&o.mime?new Doc(o):o},this.getFieldDocumentURL=function(t,i,o){typeof t!="string"&&(t=t.fullinput||t.input||t.name);var a=r.getFieldValue(t,i);if(a&&a.mime&&(a=a.id),a)return r.session.parameters.url+r.session.parameters.docpath+"?object="+encodeURIComponent(r.metadata.name)+"&inst="+encodeURIComponent(r.metadata.instance)+"&field="+encodeURIComponent(t)+"&row_id="+encodeURIComponent(r.getRowId(i))+"&doc_id="+encodeURIComponent(a)+(o?"&thumbnail=true":"")+(r.session.authtoken?"&_x_simplicite_authorization_="+encodeURIComponent(r.session.authtoken):"")},this.getListValue=function(t,i){if(t)for(var o=0;o<t.length;o++){var a=t[o];if(a.code===i)return a.value}return i},this.setFieldValue=function(t,i,o){o||(o=r.item),t&&o&&(o[typeof t=="string"?t:t.name]=i instanceof Doc?i.getValue():i)},this.isRowIdField=function(t){return!t.ref&&t.name===r.metadata.rowidfield},this.isTimestampField=function(t){var i=t.name;return!t.ref&&(i==="created_by"||i==="created_dt"||i==="updated_by"||i==="updated_dt")},this.getFilters=function(t){var i="BusinessObject.getFilters",o=r.session;return t=t||{},new Promise(function(a,n){var s="";t.context&&(s+="&context="+encodeURIComponent(t.context)),t.reset&&(s+="&reset="+!!t.reset),o.req(r.path+"&action=filters"+s,void 0,function(c,f){var u=o.parse(c,f);o.debug("["+i+"] HTTP status = "+f+", response type = "+u.type),u.type==="error"?(t.error||o.error||n).call(r,o.getError(u.response,void 0,i)):(r.filters=u.response,a&&a.call(r,r.filters))},function(c){(t.error||o.error||n).call(r,o.getError(c,void 0,i))})})},this.getReqOptions=function(t){var i="";t.context&&(i+="&context="+encodeURIComponent(t.context));var o=t.inlineDocs||t.inlineDocuments||t.inlineImages;o&&(i+="&inline_documents="+encodeURIComponent(o.join?o.join(","):o));var a=t.inlineThumbs||t.inlineThumbnails;a&&(i+="&inline_thumbnails="+encodeURIComponent(a.join?a.join(","):a));var n=t.inlineObjs||t.inlineObjects;return n&&(i+="&inline_objects="+encodeURIComponent(n.join?n.join(","):n)),i},this.getReqParams=function(t){var i="";if(!t)return i;var o=0;for(var a in t){var n=t[a]||"";if(n.name&&n.content)n.content.startsWith("data:")&&(n.content=n.content.replace(/data:.*;base64,/,"")),i+=(o++!=0?"&":"")+a+"="+encodeURIComponent("id|"+(n.id?n.id:"0")+"|name|"+n.name+"|content|"+n.content);else if(n.object&&n.row_id)i+=(o++!=0?"&":"")+a+"="+encodeURIComponent("object|"+n.object+"|row_id|"+n.row_id);else if(n.sort)for(var s=0;s<n.length;s++)i+=(o++!=0?"&":"")+a+"="+encodeURIComponent(n[s]);else i+=(o++!=0?"&":"")+a+"="+encodeURIComponent(n)}return i},this.getCount=function(t,i){var o="BusinessObject.getCount",a=r.session;return i=i||{},new Promise(function(n,s){r.filters=t||{},a.req(r.path+"&action=count",r.getReqParams(r.filters),function(c,f){var u=a.parse(c,f);a.debug("["+o+"] HTTP status = "+f+", response type = "+u.type),u.type==="error"?(i.error||a.error||s).call(r,a.getError(u.response,void 0,o)):(r.count=u.response.count,r.page=u.response.page>=0?u.response.page+1:void 0,r.maxpage=u.response.maxpage>=0?u.response.maxpage+1:void 0,r.list=[],n&&n.call(r,r.count))},function(c){(i.error||a.error||s).call(r,a.getError(c,void 0,o))})})},this.search=function(t,i){var o="BusinessObject.search",a=r.session;return i=i||{},new Promise(function(n,s){var c=r.getReqOptions(i);i.page>0&&(c+="&page="+(i.page-1)),i.metadata===!0&&(c+="&_md=true"),i.visible===!0&&(c+="&_visible=true"),r.filters=t||{},a.req(r.path+"&action=search"+c,r.getReqParams(r.filters),function(f,u){var l=a.parse(f,u);a.debug("["+o+"] HTTP status = "+u+", response type = "+l.type),l.type==="error"?(i.error||a.error||s).call(r,a.getError(l.response,void 0,o)):(f.meta&&(r.metadata=l.response.meta),r.count=l.response.count,r.page=l.response.page>=0?l.response.page+1:void 0,r.maxpage=l.response.maxpage>=0?l.response.maxpage+1:void 0,r.list=l.response.list,n&&n.call(r,r.list))},function(f){(i.error||a.error||s).call(r,a.getError(f,void 0,o))})})},this.get=function(t,i){var o="BusinessObject.get",a=r.session;return i=i||{},new Promise(function(n,s){var c=r.getReqOptions(i),f=i.treeView;if(f&&(c+="&treeview="+encodeURIComponent(f)),i.fields)for(var u=0;u<i.fields.length;u++)c+="&fields="+encodeURIComponent(i.fields[u].replace(".","__"));i.metadata&&(c+="&_md=true"),i.social&&(c+="&_social=true"),a.req(r.path+"&action=get&"+r.metadata.rowidfield+"="+encodeURIComponent(t)+c,void 0,function(l,d){var h=a.parse(l,d);a.debug("[simplicite.BusinessObject.get] HTTP status = "+d+", response type = "+h.type),h.type==="error"?(i.error||a.error||s).call(r,a.getError(h.response,void 0,o)):(h.response.meta&&(r.metadata=h.response.meta),h.response.data?r.item=f?h.response.data.item:h.response.data:r.item=f?h.response.item:h.response,n&&n.call(r,f?h.response:r.item))},function(l){(i.error||a.error||s).call(r,a.getError(l,void 0,o))})})},this.getForCreate=function(t){return t=t||{},delete t.treeview,delete t.fields,t.context=constants.CONTEXT_CREATE,r.get(r.session.constants.DEFAULT_ROW_ID,t)},this.getForUpdate=function(t,i){return i=i||{},delete i.treeview,delete i.fields,i.context=constants.CONTEXT_UPDATE,r.get(t,i)},this.getForCopy=function(t,i){return i=i||{},delete i.treeview,delete i.fields,i.context=constants.CONTEXT_COPY,r.get(t,i)},this.getForDelete=function(t,i){return i=i||{},delete i.treeview,delete i.fields,i.context=constants.CONTEXT_DELETE,r.get(t,i)},this.getRowId=function(t){if(t=t||r.item,t)return t[r.getRowIdFieldName()]},this.populate=function(t,i){var o="BusinessObject.populate",a=r.session;return i=i||{},new Promise(function(n,s){var c=r.getReqOptions(i);a.req(r.path+"&action=populate&"+r.metadata.rowidfield+"="+encodeURIComponent(t)+c,void 0,function(f,u){var l=a.parse(f,u);a.debug("["+o+"] HTTP status = "+u+", response type = "+l.type),l.type==="error"?(i.error||a.error||s).call(r,a.getError(l.response,void 0,o)):(r.item=l.response.data?l.response.data:l.response,n&&n.call(r,r.item))},function(f){(i.error||a.error||s).call(r,a.getError(f,void 0,o))})})},this.save=function(t,i){t&&(r.item=t);var o=r.item[r.metadata.rowidfield];return!o||o===constants.DEFAULT_ROW_ID?r.create(t,i):r.update(t,i)},this.create=function(t,i){var o="BusinessObject.create",a=r.session;return i=i||{},new Promise(function(n,s){t&&(r.item=t),r.item.row_id=a.constants.DEFAULT_ROW_ID;var c=r.getReqOptions(i);a.req(r.path+"&action=create"+c,r.getReqParams(r.item),function(f,u){var l=a.parse(f,u);a.debug("["+o+"] HTTP status = "+u+", response type = "+l.type),l.type==="error"?(i.error||a.error||s).call(r,a.getError(l.response,void 0,o)):(r.item=l.response.data?l.response.data:l.response,n&&n.call(r,r.item))},function(f){(i.error||a.error||s).call(r,a.getError(f,void 0,o))})})},this.update=function(t,i){var o="BusinessObject.update",a=r.session;return i=i||{},new Promise(function(n,s){t&&(r.item=t);var c=r.getReqOptions(i);a.req(r.path+"&action=update"+c,r.getReqParams(r.item),function(f,u){var l=a.parse(f,u);a.debug("["+o+"] HTTP status = "+u+", response type = "+l.type),l.type==="error"?(i.error||a.error||s).call(r,a.getError(l.response,void 0,o)):(r.item=l.response.data?l.response.data:l.response,n&&n.call(r,r.item))},function(f){(i.error||a.error||s).call(r,a.getError(f,void 0,o))})})},this.del=function(t,i){var o="BusinessObject.del",a=r.session;return i=i||{},new Promise(function(n,s){t&&(r.item=t),a.req(r.path+"&action=delete&"+r.metadata.rowidfield+"="+encodeURIComponent(r.item[r.metadata.rowidfield]),void 0,function(c,f){var u=a.parse(c,f);a.debug("["+o+"] HTTP status = "+f+", response type = "+u.type),u.type==="error"?(i.error||a.error||s).call(r,a.getError(u.response,void 0,o)):(r.item=void 0,delete u.response.undoredo,n&&n.call(r,u.response))},function(c){(i.error||a.error||s).call(r,a.getError(c,void 0,o))})})},this.action=function(t,i,o){var a="BusinessObject.action("+t+")",n=r.session;return o=o||{},new Promise(function(s,c){n.req(r.path+"&action="+encodeURIComponent(t)+(i?"&"+r.getRowIdFieldName()+"="+encodeURIComponent(i):""),r.getReqParams(o.parameters),function(f,u){var l=n.parse(f,u);if(n.debug("["+a+"] HTTP status = "+u+", response type = "+l.type),l.type==="error")(o.error||n.error||c).call(r,n.getError(l.response,void 0,a));else{var d=l.response.result;s&&s.call(r,d)}},function(f){(o.error||n.error||c).call(r,n.getError(f,void 0,a))})})},this.crosstab=function(t,i){var o="BusinessObject.crosstab("+t+")",a=r.session;return i=i||{},new Promise(function(n,s){i.filters&&(r.filters=i.filters),a.req(r.path+"&action=crosstab&crosstab="+encodeURIComponent(t),r.getReqParams(r.filters),function(c,f){var u=a.parse(c,f);a.debug("["+o+"] HTTP status = "+f+", response type = "+u.type),u.type==="error"?(i.error||a.error||s).call(r,a.getError(u.response,void 0,o)):n&&n.call(r,u.response)},function(c){(i.error||a.error||s).call(r,a.getError(c,void 0,o))})})},this.print=function(t,i,o){var a="BusinessObject.print("+t+")",n=r.session;return o=o||{},new Promise(function(s,c){o.filters&&(r.filters=o.filters);var f="";o.all&&(f+="&all="+!!o.all),o.mailing&&(f+="&mailing="+!!o.mailing),n.req(r.path+"&action=print&printtemplate="+encodeURIComponent(t)+(i?"&"+r.getRowIdFieldName()+"="+encodeURIComponent(i):"")+f,void 0,function(u,l){var d=n.parse(u,l);n.debug("["+a+"] HTTP status = "+l+", response type = "+d.type),d.type==="error"?(o.error||n.error||c).call(r,n.getError(d.response,void 0,a)):s&&s.call(r,new Doc(d.response))},function(u){(o.error||n.error||c).call(r,n.getError(u,void 0,a))})})},this.setParameter=function(t,i,o){var a="BusinessObject.setParameter",n=r.session;return o=o||{},new Promise(function(s,c){var f={name:t};i&&(f.value=i),n.req(r.path+"&action=setparameter",r.getReqParams(f),function(u,l){var d=n.parse(u,l);if(n.debug("["+a+"] HTTP status = "+l+", response type = "+d.type),d.type==="error")(o.error||n.error||c).call(r,d.response);else{var h=d.response.result;s&&s.call(r,h)}},function(u){(o.error||n.error||c).call(r,n.getError(u))})})},this.getParameter=function(t,i){var o="BusinessObject.getParameter",a=r.session;return i=i||{},new Promise(function(n,s){var c={name:t};a.req(r.path+"&action=getparameter",r.getReqParams(c),function(f,u){var l=a.parse(f,u);if(a.debug("["+o+"] HTTP status = "+u+", response type = "+l.type),l.type==="error")(i.error||a.error||s).call(r,l.response);else{var d=l.response.result;n&&n.call(r,d)}},function(f){(i.error||a.error||s).call(r,a.getError(f))})})},this.getResourceURL=function(t,i){return r.session.getResourceURL(t,i,r.metadata.name,r.metadata.id)},this.session=g;var v=p||"api_"+e;this.metadata=new BusinessObjectMetadata(e,v),this.cacheKey=this.session.getBusinessObjectCacheKey(e,v),this.path=this.session.parameters.objpath+"?object="+encodeURIComponent(e)+"&inst="+encodeURIComponent(v),this.item={},this.filters={},this.list=[]}return E}(),ExternalObjectMetadata=function(){function E(g){this.name=g}return E}(),ExternalObject=function(){function E(g,e){var p=this;this.getName=function(){return p.metadata.name},this.callParams=function(r){var v="";if(!r)return v;var t=0;for(var i in r){var o=r[i]||"";if(o.sort)for(var a=0;a<o.length;a++)v+=(t++!=0?"&":"")+i+"="+encodeURIComponent(o[a]);else v+=(t++!=0?"&":"")+i+"="+encodeURIComponent(o)}return v},this.call=function(r,v,t){var i="ExternalObject.call",o=p.session;return t=t||{},new Promise(function(a,n){var s="";r&&(s="?"+p.callParams(r));var c=t.method?t.method.toUpperCase():v?"POST":"GET",f={};t.contentType?f["Content-Type"]=t.contentType:v&&(f["Content-Type"]=typeof v=="string"?"application/x-www-form-urlencoded":"application/json");var u=o.getBearerTokenHeader();u?f["X-Simplicite-Authorization"]=u:(u=o.getBasicAuthHeader(),u&&(f.Authorization=u));var l=o.parameters.url+p.path+s,d=v?typeof v=="string"?v:JSON.stringify(v):void 0;o.debug("[simplicite.ExternalObject.call] "+c+" "+l+" with "+(d?" with "+d:"")),(0,node_fetch_1.default)(l,{method:c,headers:f,timeout:o.parameters.timeout*1e3,mode:"cors",credentials:"include",body:d}).then(function(h){var T=h.headers.get("content-type");o.debug("["+i+"] HTTP status = "+h.status+", response content type = "+T),T&&T.startsWith("application/json")?h.json().then(function(m){a&&a.call(p,m,h.status,h.headers)}).catch(function(m){(t.error||o.error||n).call(p,o.getError(m,void 0,i))}):T&&T.startsWith("text/")?h.text().then(function(m){a&&a.call(p,m,h.status,h.headers)}).catch(function(m){(t.error||o.error||n).call(p,o.getError(m,void 0,i))}):h.arrayBuffer().then(function(m){a&&a.call(p,m,h.status,h.headers)}).catch(function(m){(t.error||o.error||n).call(p,o.getError(m,void 0,i))})}).catch(function(h){(t.error||o.error||n).call(p,o.getError(h,void 0,i))})})},this.invoke=this.call,this.session=g,this.metadata=new ExternalObjectMetadata(e),this.path=this.session.parameters.extpath+"/"+encodeURIComponent(e)}return E}();exports.default={constants,session,Session,Doc,Grant,BusinessObject,BusinessObjectMetadata,ExternalObject};
//# sourceMappingURL=simplicite.min.js.map

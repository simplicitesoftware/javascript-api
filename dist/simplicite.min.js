/**
 * Simplicite(R) platform Javascript API client module (for node.js and browser).
 * @module simplicite
 * @version 1.1.4
 * @license Apache-2.0
 */
var Q=require("q");var axios=require("axios");var buffer=require("buffer");var constants={DEFAULT_ROW_ID_NAME:"row_id",DEFAULT_ROW_ID:"0",CONTEXT_NONE:0,CONTEXT_SEARCH:1,CONTEXT_LIST:2,CONTEXT_CREATE:3,CONTEXT_COPY:4,CONTEXT_UPDATE:5,CONTEXT_DELETE:6,CONTEXT_GRAPH:7,CONTEXT_CROSSTAB:8,CONTEXT_PRINTTMPL:9,CONTEXT_UPDATEALL:10,CONTEXT_REFSELECT:11,CONTEXT_DATAMAPSELECT:12,CONTEXT_PREVALIDATE:13,CONTEXT_POSTVALIDATE:14,CONTEXT_STATETRANSITION:15,CONTEXT_EXPORT:16,CONTEXT_IMPORT:17,CONTEXT_ASSOCIATE:18,CONTEXT_PANELLIST:19,TYPE_ID:0,TYPE_INT:1,TYPE_FLOAT:2,TYPE_STRING:3,TYPE_DATE:4,TYPE_DATETIME:5,TYPE_TIME:6,TYPE_ENUM:7,TYPE_BOOLEAN:8,TYPE_PASSWORD:9,TYPE_URL:10,TYPE_HTML:11,TYPE_EMAIL:12,TYPE_LONG_STRING:13,TYPE_ENUM_MULTI:14,TYPE_REGEXP:15,TYPE_DOC:17,TYPE_FLOAT_EMPTY:18,TYPE_EXTFILE:19,TYPE_IMAGE:20,TYPE_NOTEPAD:21,TYPE_PHONENUM:22,TYPE_COLOR:23,TYPE_OBJECT:24,TYPE_GEOCOORDS:25,VIS_NOT:0,VIS_HIDDEN:0,VIS_LIST:1,VIS_FORM:2,VIS_BOTH:3,SEARCH_NONE:0,SEARCH_MONO:1,SEARCH_MULTI_CHECK:2,SEARCH_MULTI_LIST:3,SEARCH_PERIOD:4,TRUE:"1",FALSE:"0",ERRLEVEL_FATAL:1,ERRLEVEL_ERROR:2,ERRLEVEL_WARNING:3};function session(params){return new Session(params)}function Session(params){params=params||{};this.constants=constants;this.endpoint=params.endpoint||"api";this.log=params.logHandler||function(arg){console.log(arg)};this.info=params.infoHandle||function(arg){console.info(arg)};this.warn=params.warningHandler||function(arg){console.warn(arg)};this.error=params.errorHandler||function(arg){console.error(arg)};var _debug=!!params.debug;this.debug=params.debugHandler||function(arg){if(_debug)console.log(arg)};this.timeout=params.timeout||30;if(params.url){try{params.scheme=params.url.replace(/:.*$/,"");var u=params.url.replace(new RegExp("^"+params.scheme+"://"),"").split(":");if(u.length===1){params.host=u[0].replace(/\/.*$/,"");params.port=params.scheme==="http"?80:443;params.root=u[0].replace(new RegExp("^"+params.host+"/?"),"")}else{params.host=u[0];params.port=parseInt(u[1].replace(/\/.*$/,""),10);if(isNaN(params.port))throw new Error("Incorrect port");params.root=u[1].replace(new RegExp("^"+params.port+"/?"),"")}if(params.root==="/")params.root=""}catch(e){this.error("Unable to parse URL ["+params.url+"]: "+e.message);return}}var scheme=params.scheme||(params.port===443?"https":"http");if(scheme!=="http"&&scheme!=="https"){this.error("Incorrect scheme ["+params.scheme+"]");return}var host=params.host||"localhost";var port=params.port||8080;var root=params.root||"";if(root==="/")root="";var url=scheme+"://"+host;if(scheme==="http"&&port!=80||scheme==="https"&&port!=443)url+=":"+port;if(root!=="")url+=root.startsWith("/")?root:"/"+root;this.debug("[simplicite] Base URL = "+url);this.parameters={scheme:scheme,host:host,port:port,root:root,url:url,healthpath:(this.endpoint=="ui"?"/ui/":"")+"/health?format=json",apppath:"/"+this.endpoint+"/json/app",objpath:"/"+this.endpoint+"/json/obj",pcspath:"/"+this.endpoint+"/json/pcs",extpath:"/"+this.endpoint+"/ext"};this.username=params.username||params.login;this.setUsername=function(usr){this.username=usr};this.password=params.password||params.pwd;this.setPassword=function(pwd){this.password=pwd};this.authtoken=params.authtoken||params.authToken||params.token;this.setAuthToken=function(tkn){this.authtoken=tkn};var businessObjectCache={};this.getBusinessObjectCacheKey=function(name,instance){return name+":"+(instance||"js_"+name)};this.clear=function(){this.username=undefined;this.password=undefined;this.authtoken=undefined;this.sessionid=undefined;this.grant=undefined;this.appinfo=undefined;this.sysinfo=undefined;this.userinfo=undefined;businessObjectCache={}};function getBasicAuthHeader(){return this.username&&this.password?"Basic "+(buffer.Buffer.from?buffer.Buffer.from(this.username+":"+this.password):new buffer.Buffer(this.username+":"+this.password)).toString("base64"):null}function getBearerTokenHeader(){return this.authtoken?"Bearer "+this.authtoken:null}this.req=function(path,data,callback,errorHandler){var self=this;var m=data?"post":"get";var h={};if(data)h["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8";var b=getBearerTokenHeader.call(this);if(b){self.debug("[simplicite.req] Using bearer token header = "+b);h["X-Simplicite-Authorization"]=b}else{b=getBasicAuthHeader.call(this);if(b){self.debug("[simplicite.req] Using basic auth header = "+b);h.Authorization=b}}axios.request({baseURL:self.parameters.url,url:path||"/",method:m,headers:h,timeout:self.timeout*1e3,withCredentials:true,data:data}).then(function(res){if(callback)callback.call(self,res.data,res.status)}).catch(function(err){if(errorHandler)errorHandler.call(self,err);else throw err})};this.getError=function(err,status){return typeof err==="string"?{message:err,status:status}:err};this.parse=function(res,status){try{if(status!==200)return{type:"error",response:this.getError("HTTP status: "+status,status)};return typeof res==="object"?res:JSON.parse(res)}catch(e){return{type:"error",response:this.getError("Parsing error: "+e.message,status)}}};function _getHealth(callback,opts){var self=this;opts=opts||{};self.req.call(self,self.parameters.healthpath+"&full="+!!opts.full,undefined,function(res,status){var r=self.parse(res,status);self.debug("[simplicite._getHealth] HTTP status = "+status+", response type = "+res);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{if(callback)callback.call(self,r)}},function(e){(opts.error?opts.error:self.error).call(self,e)})}this.getHealth=function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){var err=this.getError(e);d.reject(err)};_getHealth.call(this,function(health){health=health||{};d.resolve(health)},opts);return d.promise};function _login(callback,opts){var self=this;opts=opts||{};if(opts.username||opts.login){self.clear();self.username=opts.username||opts.login;if(opts.password||opts.pwd)self.password=opts.password||opts.pwd}self.req.call(self,self.parameters.apppath+"?action=session",undefined,function(res,status){var r=self.parse(res,status);self.debug("[simplicite.login] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.sessionid=r.response.id;self.debug("[simplicite.login] Session ID = "+self.sessionid);self.username=r.response.login;if(self.username)self.debug("[simplicite.login] Username = "+self.username);self.authtoken=r.response.authtoken;if(self.authtoken)self.debug("[simplicite.login] Auth token = "+self.authtoken);self.grant={login:r.response.login,userid:r.response.userid,firstname:r.response.firstanme,lastname:r.response.lastname,email:r.response.email};if(callback)callback.call(self,r.response)}},function(e){(opts.error?opts.error:self.error).call(self,e)})}this.login=function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_login.call(this,function(res){d.resolve(res)},opts);return d.promise};function _logout(callback,opts){var self=this;opts=opts||{};self.req.call(self,self.parameters.apppath+"?action=logout",undefined,function(res,status){var r=self.parse(res,status);self.debug("[simplicite.logout] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.clear();if(callback)callback.call(self,r.response)}},function(e){if(e.status===401)self.authtoken=undefined;(opts.error?opts.error:self.error).call(self,e)})}this.logout=function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_logout.call(this,function(res){d.resolve(res)},opts);return d.promise};this.grant={};function _getGrant(callback,opts){var self=this;opts=opts||{};var p="";if(opts.inlinePicture)p+="&inline_picture="+!!opts.inlinePicture;self.req.call(self,self.parameters.apppath+"?action=getgrant"+p,undefined,function(res,status){var r=self.parse(res,status);self.debug("[simplicite.getGrant] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.grant=r.response;self.grant.getUserId=function(){return this.userid};self.grant.getLUsername=function(){return this.login};self.grant.getLogin=self.grant.getLUsername;self.grant.getLang=function(){return this.lang};self.grant.getEmail=function(){return this.email};self.grant.getFirstname=function(){return this.firstname};self.grant.getFirstName=self.grant.getFirstname;self.grant.getLastname=function(){return this.lastname};self.grant.getLastName=self.grant.getLastname;self.grant.hasResponsibility=function(group){return this.responsibilities&&this.responsibilities.indexOf(group)!==-1};if(callback)callback.call(self,self.grant)}},function(e){(opts.error?opts.error:self.error).call(self,e)})}this.getGrant=function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_getGrant.call(this,function(grt){d.resolve(grt)},opts);return d.promise};function _changePassword(callback,pwd,opts){var self=this;opts=opts||{};self.req.call(self,self.parameters.apppath+"?action=setpassword&password="+pwd,undefined,function(res,status){var r=self.parse(res,status);self.debug("[simplicite.changePassword] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{if(callback)callback.call(self,self.r.response)}},function(e){(opts.error?opts.error:self.error).call(self,e)})}this.changePassword=function(pwd,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_changePassword.call(this,function(res){d.resolve(res)},pwd,opts);return d.promise};function _getAppInfo(callback,opts){var self=this;opts=opts||{};self.req.call(self,self.parameters.apppath+"?action=getinfo",undefined,function(res,status){var r=self.parse(res,status);self.debug("[simplicite.getAppInfo] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.appinfo=r.response;if(callback)callback.call(self,self.appinfo)}},function(e){(opts.error?opts.error:self.error).call(self,e)})}this.getAppInfo=function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_getAppInfo.call(this,function(inf){d.resolve(inf)},opts);return d.promise};function _getSysInfo(callback,opts){var self=this;opts=opts||{};self.req.call(self,self.parameters.apppath+"?action=sysinfo",undefined,function(res,status){var r=self.parse(res,status);self.debug("[simplicite.getSysInfo] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.sysinfo=r.response;if(callback)callback.call(self,self.sysinfo)}},function(e){(opts.error?opts.error:self.error).call(self,e)})}this.getSysInfo=function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_getSysInfo.call(this,function(inf){d.resolve(inf)},opts);return d.promise};function _getUserInfo(callback,userlogin,opts){var self=this;opts=opts||{};self.req.call(self,self.parameters.apppath+"?action=userinfo"+(userlogin?"&login="+userlogin:""),undefined,function(res,status){var r=self.parse(res,status);self.debug("[simplicite.getUserInfo] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.userinfo=r.response;if(callback)callback.call(self,self.userinfo)}},function(e){(opts.error?opts.error:self.error).call(self,e)})}this.getUserInfo=function(username,opts){var d=Q.defer();if(opts===undefined)opts={};opts.error=function(e){d.reject(e)};_getUserInfo.call(this,function(inf){d.resolve(inf)},username,opts);return d.promise};function _getNews(callback,opts){var self=this;opts=opts||{};var p="";if(opts.inlineImages)p+="&inline_images="+opts.inlineImages;self.req.call(self,self.parameters.apppath+"?action=news"+p,undefined,function(res,status){var r=self.parse(res,status);self.debug("[simplicite.getNews] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.news=r.response;if(callback)callback.call(self,self.news)}},function(e){(opts.error?opts.error:self.error).call(self,e)})}this.getNews=function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_getNews.call(this,function(nws){d.resolve(nws)},opts);return d.promise};this.getBusinessObject=function(name,instance){var cacheKey=this.getBusinessObjectCacheKey(name,instance);var obj=businessObjectCache[cacheKey];if(!obj){obj=new BusinessObject(this,name,instance);businessObjectCache[cacheKey]=obj}return obj};this.getBusinessProcess=function(name){return{metadata:{name:name}}};this.getExternalObject=function(name){return{metadata:{name:name}}}}function BusinessObjectMetadata(name,instance){this.name=name;this.instance=instance;this.rowidfield=constants.DEFAULT_ROW_ID_NAME;this.label=name;this.help="";this.fields=[]}function BusinessObject(ses,name,instance){instance=instance||"js_"+name;this.session=ses;this.metadata=new BusinessObjectMetadata(name,instance);this.cacheKey=this.session.getBusinessObjectCacheKey(name,instance);this.path=this.session.parameters.objpath+"?object="+name+"&inst="+instance;this.item={};this.filters={};this.list=[];function _getMetaData(callback,opts){var self=this;opts=opts||{};var p="";if(opts.context)p+="&context="+opts.context;if(opts.contextParam)p+="&contextparam="+opts.contextParam;self.session.req.call(self.session,self.path+"&action=metadata"+p,undefined,function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.getMetaData] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.metadata=r.response;if(callback)callback.call(self,self.metadata)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.getMetaData=function(opts){var d=Q.defer();_getMetaData.call(this,function(metadata){d.resolve(metadata)},opts);return d.promise};this.getName=function(){return this.metadata.name};this.getInstance=function(){return this.metadata.instance};this.getLabel=function(){return this.metadata.label};this.getHelp=function(){return this.metadata.help};this.getFields=function(){return this.metadata.fields};this.getField=function(fieldname){var n=0;var fs=this.getFields();while(n<fs.length&&fs[n].name!==fieldname)n++;if(n<fs.length)return fs[n]};this.getRowIdFieldName=function(){return this.metadata.rowidfield};this.getRowIdField=function(){return this.getField(this.getRowIdFieldName())};this.getLinks=function(){return this.metadata.links};this.getValueForCode=function(field,code){var n=0;var l=field.listOfValues;if(l===undefined)return code;while(n<l.length&&l[n].code!==code)n++;return n===l.length?code:l[n].value};this.getListValue=function(list,code){for(var i=0;i<list.length;i++){var l=list[i];if(l.code===code)return l.value}};this.isRowIdField=function(field){return!field.ref&&field.name===this.metadata.rowidfield};this.isTimestampField=function(field){var n=field.name;return!field.ref&&(n==="created_by"||n==="created_dt"||n==="updated_by"||n==="updated_dt")};function _getFilters(callback,opts){var self=this;opts=opts||{};var p="";if(opts.context)p+="&context="+opts.context;if(opts.reset)p+="&reset="+!!opts.reset;self.session.req.call(self.session,self.path+"&action=filters"+p,undefined,function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.getFilters] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.item=r.response;if(callback)callback.call(self,self.filters)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.getFilters=function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_getFilters.call(this,function(filters){d.resolve(filters)},opts);return d.promise};function _getOptions(options){var opts="";if(options.context)opts+="&context="+options.context;var id=options.inlineDocs;if(!id)id=options.inlineDocuments;if(id)opts+="&inline_documents="+(id.join?id.join(","):id);var it=options.inlineThumbs;if(!it)it=options.inlineThumbnails;if(it)opts+="&inline_thumbnails="+(it.join?it.join(","):it);var io=options.inlineObjs;if(!io)io=options.inlineObjects;if(io)opts+="&inline_objects="+(io.join?io.join(","):io);return opts}function _getReqParams(data){var p="";if(!data)return p;var n=0;for(var i in data){var d=data[i]||"";if(d.name&&d.content){if(d.content.startsWith("data:"))d.content=d.content.replace(/data:.*;base64,/,"");p+=(n++!==0?"&":"")+i+"="+encodeURIComponent("id|"+(d.id?d.id:"0")+"|name|"+d.name+"|content|"+d.content)}else if(d.object&&d.row_id){p+=(n++!==0?"&":"")+i+"="+encodeURIComponent("object|"+d.object+"|row_id|"+d.row_id)}else if(d.sort){for(var j=0;j<d.length;j++)p+=(n++!==0?"&":"")+i+"="+encodeURIComponent(d[j])}else{p+=(n++!==0?"&":"")+i+"="+encodeURIComponent(d)}}return p}function _count(callback,filters,opts){var self=this;opts=opts||{};self.filters=filters||{};self.session.req.call(self.session,self.path+"&action=count",_getReqParams(self.filters),function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.getCount] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.count=r.response.count;self.page=r.response.page>=0?r.response.page+1:undefined;self.maxpage=r.response.maxpage>=0?r.response.maxpage+1:undefined;self.list=[];if(callback)callback.call(self,self.count)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.count=function(filters,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_count.call(this,function(count){d.resolve(count)},filters,opts);return d.promise};this.getCount=this.count;function _search(callback,filters,opts){var self=this;opts=opts||{};var p=_getOptions(opts);if(opts.page>0)p+="&page="+(opts.page-1);if(opts.metadata===true)p+="&_md=true";if(opts.visible===true)p+="&_visible=true";self.filters=filters||{};self.session.req.call(self.session,self.path+"&action=search"+p,_getReqParams(self.filters),function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.search] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{if(res.meta)self.metadata=r.response.meta;self.count=r.response.count;self.page=r.response.page>=0?r.response.page+1:undefined;self.maxpage=r.response.maxpage>=0?r.response.maxpage+1:undefined;self.list=r.response.list;if(callback)callback.call(self,self.list)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.search=function(filters,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_search.call(this,function(list){d.resolve(list)},filters,opts);return d.promise};function _get(callback,rowId,opts){var self=this;opts=opts||{};var p=_getOptions(opts);var tv=opts.treeView;if(tv)p+="&treeview="+tv;if(opts.fields){for(var i=0;i<opts.fields.length;i++){p+="&fields="+opts.fields[i].replace(".","__")}}if(opts.metadata)p+="&_md=true";if(opts.social)p+="&_social=true";self.session.req.call(self.session,self.path+"&action=get&"+self.metadata.rowidfield+"="+rowId+p,undefined,function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.get] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{if(res.meta)self.metadata=r.response.meta;if(res.data)self.item=tv?r.response.data.item:r.response.data;else self.item=tv?r.response.item:r.response;if(callback)callback.call(self,tv?r.response:self.item)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.get=function(rowId,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_get.call(this,function(itm){d.resolve(itm)},rowId,opts);return d.promise};function _getForCreate(callback,opts){opts=opts||{};delete opts.treeview;delete opts.fields;opts.context=constants.CONTEXT_CREATE;_get.call(this,callback,this.session.constants.DEFAULT_ROW_ID,opts)}this.getForCreate=function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_getForCreate.call(this,function(itm){d.resolve(itm)},opts);return d.promise};function _getForUpdate(callback,rowId,opts){opts=opts||{};delete opts.treeview;delete opts.fields;opts.context=constants.CONTEXT_UPDATE;_get.call(this,callback,rowId,opts)}this.getForUpdate=function(rowId,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_getForUpdate.call(this,function(itm){d.resolve(itm)},rowId,opts);return d.promise};function _getForCopy(callback,rowId,opts){opts=opts||{};delete opts.treeview;delete opts.fields;opts.context=constants.CONTEXT_COPY;_get.call(this,callback,rowId,opts)}this.getForCopy=function(rowId,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_getForCopy.call(this,function(itm){d.resolve(itm)},rowId,opts);return d.promise};function _getForDelete(callback,rowId,opts){opts=opts||{};delete opts.treeview;delete opts.fields;opts.context=constants.CONTEXT_CREATE;_get.call(this,callback,rowId,opts)}this.getForDelete=function(rowId,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_getForDelete.call(this,function(itm){d.resolve(itm)},rowId,opts);return d.promise};this.getRowId=function(){if(this.item)return this.item[this.getRowIdFieldName()]};function _populate(callback,rowId,opts){var self=this;opts=opts||{};var p=_getOptions(opts);self.session.req.call(self.session,self.path+"&action=populate&"+self.metadata.rowidfield+"="+rowId+p,undefined,function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.populate] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.item=r.response;if(callback)callback.call(self,self.item)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.populate=function(itm,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_populate.call(this,function(i){d.resolve(i)},itm,opts);return d.promise};function _save(callback,item,opts){if(item)this.item=item;var rowId=this.item[this.metadata.rowidfield];if(!rowId||rowId===constants.DEFAULT_ROW_ID)_create.call(this,callback,item,opts);else _update.call(this,callback,item,opts)}this.save=function(itm,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_save.call(this,function(i){d.resolve(i)},itm,opts);return d.promise};function _create(callback,item,opts){var self=this;if(item)self.item=item;opts=opts||{};var p=_getOptions(opts);self.session.req.call(self.session,self.path+"&action=create"+p,_getReqParams(self.item),function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.create] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.item=r.response.data?r.response.data:r.response;if(callback)callback.call(self,self.item)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.create=function(itm,opts){itm.row_id=this.session.constants.DEFAULT_ROW_ID;var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_create.call(this,function(i){d.resolve(i)},itm,opts);return d.promise};function _update(callback,item,opts){var self=this;if(item)self.item=item;opts=opts||{};var p=_getOptions(opts);self.session.req.call(self.session,self.path+"&action=update"+p,_getReqParams(self.item),function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.update] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.item=r.response.data?r.response.data:r.response;if(callback)callback.call(self,self.item)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.update=function(itm,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_update.call(this,function(i){d.resolve(i)},itm,opts);return d.promise};function _del(callback,item,opts){var self=this;if(item)self.item=item;opts=opts||{};self.session.req.call(self.session,self.path+"&action=delete&"+self.metadata.rowidfield+"="+self.item[self.metadata.rowidfield],undefined,function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.del] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.item=undefined;delete r.response.undoredo;if(callback)callback.call(self,r.response)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.del=function(itm,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_del.call(this,function(r){d.resolve(r)},itm,opts);return d.promise};function _action(callback,action,rowId,opts){var self=this;opts=opts||{};self.session.req.call(self.session,self.path+"&action="+action+(opts.rowId?"&row_id="+rowId:""),undefined,function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.action("+action+")] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{var result=r.response.result;if(callback)callback.call(self,result)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.action=function(act,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_action.call(this,function(res){d.resolve(res)},act,opts);return d.promise};function _crosstab(callback,crosstab,opts){var self=this;opts=opts||{};if(opts.filters)self.filters=opts.filters;self.session.req.call(self.session,self.path+"&action=crosstab&crosstab="+crosstab,_getReqParams(self.filters),function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.crosstab("+crosstab+")] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.crosstabdata=r.response;if(callback)callback.call(self,self.crosstabdata)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.crosstab=function(ctb,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_crosstab.call(this,function(res){d.resolve(res)},ctb,opts);return d.promise};function _print(callback,prt,opts){var self=this;opts=opts||{};if(opts.filters)self.filters=opts.filters;var p="";if(opts.all)p+="&all="+opts.all;if(opts.mailing)p+="&mailing="+opts.mailing;self.session.req.call(self.session,self.path+"&action=print&printtemplate="+prt+p,undefined,function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.print("+prt+")] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{var result=r.response.result;if(callback)callback.call(self,result)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.print=function(pt,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_print.call(this,function(res){d.resolve(res)},pt,opts);return d.promise};function _setParameter(callback,param,value,opts){var self=this;opts=opts||{};var p={name:param};if(value)p.value=value;self.session.req.call(self.session,self.path+"&action=setparameter",_getReqParams(p),function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.setParameter("+p.name+")] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{var result=r.response.result;if(callback)callback.call(self,result)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.setParameter=function(param,value,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_setParameter.call(this,function(){d.resolve()},param,value,opts);return d.promise};function _getParameter(callback,param,opts){var self=this;opts=opts||{};var p={name:param};self.session.req.call(self.session,self.path+"&action=getparameter",_getReqParams(p),function(res,status){var r=self.session.parse(res,status);this.debug("[simplicite.BusinessObject.getParameter("+p.name+")] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{var result=r.response.result;if(callback)callback.call(self,result)}},function(e){(opts.error?opts.error:self.session.error).call(self,e)})}this.getParameter=function(param,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};_getParameter.call(this,function(value){d.resolve(value)},param,opts);return d.promise}}module.exports={session:session,Session:Session,BusinessObject:BusinessObject,BusinessObjectMetadata:BusinessObjectMetadata};
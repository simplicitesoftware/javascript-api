module.exports={session:function(params){var Q=require("q");var request=require("xhr-request");var buffer=require("buffer");var infoHandler=params.infoHandler||function(msg){console.log("INFO - "+msg)};var warnHandler=params.warnHandler||function(msg){console.log("WARN - "+msg)};var errorHandler=params.errorHandler||function(msg){console.log("ERROR - "+msg)};var debugHandler=params.debugHandler||function(msg){if(debug)console.log("DEBUG - "+msg)};var constants={DEFAULT_ROW_ID:"0",CONTEXT_NONE:0,CONTEXT_SEARCH:1,CONTEXT_LIST:2,CONTEXT_CREATE:3,CONTEXT_COPY:4,CONTEXT_UPDATE:5,CONTEXT_DELETE:6,CONTEXT_GRAPH:7,CONTEXT_CROSSTAB:8,CONTEXT_PRINTTMPL:9,CONTEXT_UPDATEALL:10,CONTEXT_REFSELECT:11,CONTEXT_DATAMAPSELECT:12,CONTEXT_PREVALIDATE:13,CONTEXT_POSTVALIDATE:14,CONTEXT_STATETRANSITION:15,CONTEXT_EXPORT:16,CONTEXT_IMPORT:17,CONTEXT_ASSOCIATE:18,CONTEXT_PANELLIST:19,TYPE_ID:0,TYPE_INT:1,TYPE_FLOAT:2,TYPE_STRING:3,TYPE_DATE:4,TYPE_DATETIME:5,TYPE_TIME:6,TYPE_ENUM:7,TYPE_BOOLEAN:8,TYPE_PASSWORD:9,TYPE_URL:10,TYPE_HTML:11,TYPE_EMAIL:12,TYPE_LONG_STRING:13,TYPE_ENUM_MULTI:14,TYPE_REGEXP:15,TYPE_DOC:17,TYPE_FLOAT_EMPTY:18,TYPE_EXTFILE:19,TYPE_IMAGE:20,TYPE_NOTEPAD:21,TYPE_PHONENUM:22,TYPE_COLOR:23,TYPE_OBJECT:24,TYPE_GEOCOORDS:25,VIS_NOT:0,VIS_LIST:1,VIS_FORM:2,VIS_BOTH:3,SEARCH_NONE:0,SEARCH_MONO:1,SEARCH_MULTI_CHECK:2,SEARCH_MULTI_LIST:3,RENDERING_DEFAULT:"",RENDERING_SELECTBOX:"SB",RENDERING_HORIZCHECKBOX:"HCB",RENDERING_VERTCHECKBOX:"VCB",RENDERING_HORIZRADIOBUTTON:"HRB",RENDERING_VERTRADIOBUTTON:"VRB",TRUE:"1",FALSE:"0",ERRLEVEL_FATAL:1,ERRLEVEL_ERROR:2,ERRLEVEL_WARNING:3};params=params||{};if(params.url){try{params.scheme=params.url.replace(/:.*$/,"");var u=params.url.replace(new RegExp("^"+params.scheme+"://"),"").split(":");if(u.length===1){params.host=u[0].replace(/\/.*$/,"");params.port=params.scheme==="http"?80:443;params.root=u[0].replace(new RegExp("^"+params.host+"[/]{0,1}"),"")}else{params.host=u[0];params.port=parseInt(u[1].replace(/\/.*$/,""),10);if(isNaN(params.port))throw new Error("Incorrect port");params.root=u[1].replace(new RegExp("^"+params.port+"[/]{0,1}"),"")}if(params.root==="/")params.root=""}catch(e){console.error("Unable to parse URL ["+params.url+"]: "+e.message);return}}var scheme=params.scheme||(params.port===443?"https":"http");if(scheme!=="http"&&scheme!=="https"){console.error("Incorrect scheme ["+params.scheme+"]");return}var host=params.host||"localhost";var port=params.port||8080;var approot=params.root||"";debugHandler("[simplicite] Base URL = "+scheme+"://"+host+":"+port+(approot!==""?"/"+approot:""));var debug=params.debug||false;var timeout=params.timeout||30;var username=params.username||params.user||params.login;function setUsername(u){username=u}var password=params.password||params.pwd;function setPassword(p){password=p}function getBasicAuthHeader(){return username&&password?"Basic "+(buffer.Buffer.from?buffer.Buffer.from(username+":"+password):new buffer.Buffer(username+":"+password)).toString("base64"):null}var authToken=params.authToken||params.authtoken||params.token;function setAuthToken(t){authToken=t}function getBearerTokenHeader(){return authToken?"Bearer "+authToken:null}var sessionId=null;var cookies=null;function callParams(data){var p="";if(!data)return p;var n=0;for(var i in data){var d=data[i]||"";if(d.id&&d.content)p+=(n++!==0?"&":"")+i+"="+encodeURIComponent("id|"+d.id+"|name|"+d.name+"|content|"+d.content);else if(d.object&&d.row_id)p+=(n++!==0?"&":"")+i+"="+encodeURIComponent("object|"+d.object+"|row_id|"+d.row_id);else if(d.sort)for(var j=0;j<d.length;j++)p+=(n++!==0?"&":"")+i+"="+encodeURIComponent(d[j]);else p+=(n++!==0?"&":"")+i+"="+encodeURIComponent(d)}return p}function call(path,data,callback,error){var p=path||"/";p=(approot!==""?"/"+approot:"")+p;var m=data?"POST":"GET";var h={};if(data)h["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8";var b=getBearerTokenHeader();if(b){h["X-Simplicite-Authorization"]=b}else{b=getBasicAuthHeader();if(b)h.Authorization=b}if(cookies)h.Cookie=cookies;request(scheme+"://"+host+":"+port+p,{method:m,headers:h,timeout:timeout*1e3,withCredentials:true,body:data},function(err,dat,res){if(err){if(error)error.call(this,err);else throw err}else if(callback){callback.call(this,dat,res.statusCode)}})}function _getError(error,status){return typeof error==="string"?{message:error,status:status}:error}function parse(res,status){try{if(status!==200)return{type:"error",response:_getError("HTTP status: "+status,status)};return JSON.parse(res)}catch(e){return{type:"error",response:_getError("Parsing error: "+e.message,status)}}}var ui=typeof window!=="undefined"&&typeof window.$ui!=="undefined";var healthpath=(ui?"/ui/":"")+"/health?format=json";function _getHealth(callback,opts){var self=this;opts=opts||{};call(healthpath,undefined,function(res,status){debugHandler("[simplicite._getHealth] HTTP status = "+status+", response = "+res);var health=parse(res,status);if(health.type==="error"){(opts.error?opts.error:errorHandler).call(self,health.response)}else if(callback){callback.call(self,health)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}var apppath="/"+(ui?"ui":"api")+"/json/app";var objpath="/"+(ui?"ui":"api")+"/json/obj";function _login(callback,opts){var self=this;opts=opts||{};call(apppath+"?action=session",undefined,function(res,status){debugHandler("[simplicite.login] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.sessionId=r.response.id;debugHandler("[simplicite.login] Session ID = "+self.sessionId);self.username=r.response.login;if(self.username)debugHandler("[simplicite.login] Username = "+self.username);self.authToken=r.response.authtoken;if(self.authToken)debugHandler("[simplicite.login] Auth token = "+self.authToken);if(callback)callback.call(self,r.response)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _logout(callback,opts){var self=this;opts=opts||{};call(apppath+"?action=logout",undefined,function(res,status){debugHandler("[simplicite.logout] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.username=null;self.password=null;self.authToken=null;self.sessionId=null;self.cookies=null;self.appinfo=undefined;self.sysinfo=undefined;self.userinfo=undefined;self.grant=undefined;self.businessObjectCache={};if(callback)callback.call(self,r.response)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _getGrant(callback,opts){var self=this;opts=opts||{};var p="";if(opts.inlinePicture)p+="&inline_picture="+opts.inlinePicture;call(apppath+"?action=getgrant"+p,undefined,function(res,status){debugHandler("[simplicite.getGrant] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.grant=r.response;self.grant.getUserID=function(){return this.userid};self.grant.getLogin=function(){return this.login};self.grant.getLang=function(){return this.lang};self.grant.getEmail=function(){return this.email};self.grant.getFirstName=function(){return this.firstname};self.grant.getLastName=function(){return this.lastname};self.grant.hasResponsibility=function(group){return this.responsibilities&&this.responsibilities.indexOf(group)!==-1};if(callback)callback.call(self,self.grant)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _getAppInfo(callback,opts){var self=this;opts=opts||{};call(apppath+"?action=getinfo",undefined,function(res,status){debugHandler("[simplicite.getAppInfo] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.appinfo=r.response;if(callback)callback.call(self,self.appinfo)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _getSysInfo(callback,opts){var self=this;opts=opts||{};call(apppath+"?action=sysinfo",undefined,function(res,status){debugHandler("[simplicite.getSysInfo] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.sysinfo=r.response;if(callback)callback.call(self,self.sysinfo)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _getUserInfo(callback,userlogin,opts){var self=this;opts=opts||{};call(apppath+"?action=userinfo"+(userlogin?"&login="+userlogin:""),undefined,function(res,status){debugHandler("[simplicite.getUserInfo] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.userinfo=r.response;if(callback)callback.call(self,self.userinfo)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _getNews(callback,opts){var self=this;opts=opts||{};var p="";if(opts.inlineImages)p+="&inline_images="+opts.inlineImages;call(apppath+"?action=news"+p,undefined,function(res,status){debugHandler("[simplicite.getNews] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.news=r.response;if(callback)callback.call(self,self.news)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}var businessObjectCache={};function getBusinessObject(name,instance){instance=instance||"node_"+name;var cacheKey=name+":"+instance;var obj=businessObjectCache[cacheKey];if(obj)return obj;var path=objpath+"?object="+name+"&inst="+instance;function _getMetaData(callback,opts){var self=this;opts=opts||{};var p="";if(opts.context)p+="&context="+opts.context;if(opts.contextParam)p+="&contextparam="+opts.contextParam;call(path+"&action=metadata"+p,undefined,function(res,status){debugHandler("[simplicite.BusinessObject.getMetaData] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.metadata=r.response;if(callback)callback.call(self,self.metadata)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _getFilters(callback,opts){var self=this;opts=opts||{};var p="";if(opts.context)p+="&context="+opts.context;if(opts.reset)p+="&reset="+opts.reset;call(path+"&action=filters"+p,undefined,function(res,status){debugHandler("[simplicite.BusinessObject.getFilters] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.item=r.response;if(callback)callback.call(self,self.filters)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _getOptions(options){var opts="";if(options.context)opts+="&context="+options.context;var id=options.inlineDocs;if(!id)id=options.inlineDocuments;if(id)opts+="&inline_documents="+(id.join?id.join(","):id);var it=options.inlineThumbs;if(!it)it=options.inlineThumbnails;if(it)opts+="&inline_thumbnails="+(it.join?it.join(","):it);var io=options.inlineObjs;if(!io)io=options.inlineObjects;if(io)opts+="&inline_objects="+(io.join?io.join(","):io);return opts}function _search(callback,filters,opts){var self=this;if(filters)self.filters=filters;opts=opts||{};var p=_getOptions(opts);if(opts.page>0)p+="&page="+(opts.page-1);if(opts.metadata===true)p+="&_md=true";if(opts.visible===true)p+="&_visible=true";call(path+"&action=search"+p,callParams(self.filters),function(res,status){debugHandler("[simplicite.BusinessObject.search] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{if(res.meta)self.metadata=r.response.meta;self.count=r.response.count;self.page=r.response.page>=0?r.response.page+1:undefined;self.maxpage=r.response.maxpage>=0?r.response.maxpage+1:undefined;self.list=r.response.list;if(callback)callback.call(self,self.list)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _getCount(callback,filters,opts){var self=this;if(filters)self.filters=filters;opts=opts||{};call(path+"&action=count",callParams(self.filters),function(res,status){debugHandler("[simplicite.BusinessObject.getCount] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.count=r.response.count;self.page=r.response.page>=0?r.response.page+1:undefined;self.maxpage=r.response.maxpage>=0?r.response.maxpage+1:undefined;self.list=[];if(callback)callback.call(self,self.count)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _get(callback,rowId,opts){var self=this;opts=opts||{};var p=_getOptions(opts);var tv=opts.treeView;if(tv)p+="&treeview="+tv;if(opts.fields){for(var i=0;i<opts.fields.length;i++){p+="&fields="+opts.fields[i].replace(".","__")}}if(opts.metadata)p+="&_md=true";if(opts.social)p+="&_social=true";call(path+"&action=get&"+self.metadata.rowidfield+"="+rowId+p,undefined,function(res,status){debugHandler("[simplicite.BusinessObject.get] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.item=tv?r.response.item:r.response;if(callback)callback.call(self,tv?r.response:self.item)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _getForCreate(callback,opts){opts=opts||{};opts.context=constants.CONTEXT_CREATE;this._get(callback,constants.DEFAULT_ROW_ID,opts)}function _getForUpdate(callback,rowId,opts){opts=opts||{};opts.context=constants.CONTEXT_UPDATE;this._get(callback,rowId,opts)}function _getForCopy(callback,rowId,opts){opts=opts||{};opts.context=constants.CONTEXT_COPY;this._get(callback,rowId,opts)}function _getForDelete(callback,rowId,opts){opts=opts||{};opts.context=constants.CONTEXT_CREATE;this._get(callback,rowId,opts)}function _populate(callback,rowId,opts){var self=this;opts=opts||{};var p=_getOptions(opts);call(path+"&action=populate&"+self.metadata.rowidfield+"="+rowId+p,undefined,function(res,status){debugHandler("[simplicite.BusinessObject.populate] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.item=r.response;if(callback)callback.call(self,self.item)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _save(callback,item,opts){if(item)this.item=item;if(this.item[this.metadata.rowidfield]===constants.DEFAULT_ROW_ID)this.create(callback,item,opts);else this.update(callback,item,opts)}function _create(callback,item,opts){var self=this;if(item)self.item=item;opts=opts||{};var p=_getOptions(opts);call(path+"&action=create"+p,callParams(self.item),function(res,status){debugHandler("[simplicite.BusinessObject.create] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.item=r.response;if(callback)callback.call(self,self.item)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _update(callback,item,opts){var self=this;if(item)self.item=item;opts=opts||{};var p=_getOptions(opts);call(path+"&action=update"+p,callParams(self.item),function(res,status){debugHandler("[simplicite.BusinessObject.update] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.item=r.response;if(callback)callback.call(self,self.item)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _del(callback,item,opts){var self=this;if(item)self.item=item;opts=opts||{};call(path+"&action=delete&"+self.metadata.rowidfield+"="+self.item[self.metadata.rowidfield],undefined,function(res,status){debugHandler("[simplicite.BusinessObject.del] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.item=undefined;if(callback)callback.call(self)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _action(callback,action,opts){var self=this;opts=opts||{};call(path+"&action="+action,undefined,function(res,status){debugHandler("[simplicite.BusinessObject.action("+action+")] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{var result=r.response.result;if(callback)callback.call(self,result)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _crosstab(callback,crosstab,opts){var self=this;opts=opts||{};if(opts.filters)self.filters=opts.filters;call(path+"&action=crosstab&crosstab="+crosstab,callParams(self.filters),function(res,status){debugHandler("[simplicite.BusinessObject.crosstab("+crosstab+")] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{self.crosstabdata=r.response;if(callback)callback.call(self,self.crosstabdata)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _print(callback,prt,opts){var self=this;opts=opts||{};if(opts.filters)self.filters=opts.filters;var p="";if(opts.all)p+="&all="+opts.all;if(opts.mailing)p+="&mailing="+opts.mailing;call(path+"&action=print&printtemplate="+prt+p,undefined,function(res,status){debugHandler("[simplicite.BusinessObject.print("+prt+")] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{var result=r.response.result;if(callback)callback.call(self,result)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _setParameter(callback,param,value,opts){var self=this;opts=opts||{};var p={name:param};if(value)p.value=value;call(path+"&action=setparameter",callParams(p),function(res,status){debugHandler("[simplicite.BusinessObject.setParameter("+p.name+")] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{var result=r.response.result;if(callback)callback.call(self,result)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}function _getParameter(callback,param,opts){var self=this;opts=opts||{};var p={name:param};call(path+"&action=getparameter",callParams(p),function(res,status){debugHandler("[simplicite.BusinessObject.getParameter("+p.name+")] HTTP status = "+status+", response = "+res);var r=parse(res,status);if(r.type==="error"){(opts.error?opts.error:errorHandler).call(self,r.response)}else{var result=r.response.result;if(callback)callback.call(self,result)}},function(e){(opts.error?opts.error:errorHandler).call(self,e)})}obj={metadata:{name:name,instance:instance,rowidfield:"row_id"},_getMetaData:_getMetaData,getMetaData:function(opts){var d=Q.defer();this._getMetaData(function(metadata){d.resolve(metadata)},params);return d.promise},getName:function(){return this.metadata.name},getInstance:function(){return this.metadata.instance},getLabel:function(){return this.metadata.label},getHelp:function(){return this.metadata.help},getFields:function(){return this.metadata.fields},getField:function(fieldname){var n=0;var fs=this.getFields();while(n<fs.length&&fs[n].name!==fieldname)n++;if(n<fs.length)return fs[n]},getRowIdFieldName:function(){return this.metadata.rowidfield},getRowIdField:function(){return this.getField(this.getRowIdFieldName())},getLinks:function(){return this.metadata.links},getValueForCode:function(field,code){var n=0;var l=field.listOfValues;if(l===undefined)return code;while(n<l.length&&l[n].code!==code)n++;return n===l.length?code:l[n].value},getListValue:function(list,code){for(var i=0;i<list.length;i++){var l=list[i];if(l.code===code)return l.value}},isRowIdField:function(field){return!field.ref&&field.name===this.metadata.rowidfield},isTimestampField:function(field){var n=field.name;return!field.ref&&(n==="created_by"||n==="created_dt"||n==="updated_by"||n==="updated_dt")},_getFilters:_getFilters,getFilters:function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getFilters(function(filters){d.resolve(filters)},opts);return d.promise},_search:_search,search:function(filters,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._search(function(list){d.resolve(list)},filters,opts);return d.promise},_getCount:_getCount,getCount:function(filters,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getCount(function(count){d.resolve(count)},filters,opts);return d.promise},_get:_get,get:function(rowId,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._get(function(itm){d.resolve(itm)},rowId,opts);return d.promise},_getForCreate:_getForCreate,getForCreate:function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getForCreate(function(itm){d.resolve(itm)},opts);return d.promise},_getForUpdate:_getForUpdate,getForUpdate:function(rowId,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getForUpdate(function(itm){d.resolve(itm)},rowId,opts);return d.promise},_getForCopy:_getForCopy,getForCopy:function(rowId,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getForCopy(function(itm){d.resolve(itm)},rowId,opts);return d.promise},_getForDelete:_getForDelete,getForDelete:function(rowId,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getForDelete(function(itm){d.resolve(itm)},rowId,opts);return d.promise},getRowId:function(){if(this.item)return this.item[this.getRowIdFieldName()]},_populate:_populate,populate:function(itm,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._populate(function(i){d.resolve(i)},itm,opts);return d.promise},_save:_save,save:function(itm,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._save(function(i){d.resolve(i)},itm,opts);return d.promise},_create:_create,create:function(itm,opts){itm.row_id=constants.DEFAULT_ROW_ID;var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._create(function(i){d.resolve(i)},itm,opts);return d.promise},_update:_update,update:function(itm,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._update(function(i){d.resolve(i)},itm,opts);return d.promise},_del:_del,del:function(itm,opts){var d=Q.defer();if(opts===undefined)opts={};opts.error=function(e){d.reject(e)};this._del(function(){d.resolve()},itm,opts);return d.promise},_action:_action,action:function(act,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._action(function(res){d.resolve(res)},act,opts);return d.promise},_crosstab:_crosstab,crosstab:function(ctb,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._crosstab(function(res){d.resolve(res)},ctb,opts);return d.promise},_print:_print,print:function(pt,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._print(function(res){d.resolve(res)},pt,opts);return d.promise},_setParameter:_setParameter,setParameter:function(param,value,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._setParameter(function(){d.resolve()},param,value,opts);return d.promise},_getParameter:_getParameter,getParameter:function(param,opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getParameter(function(value){d.resolve(value)},param,opts);return d.promise}};businessObjectCache[cacheKey]=obj;return obj}function getBusinessProcess(name){return{metadata:{name:name}}}function getExternalObject(name){return{metadata:{name:name}}}return{constants:constants,parameters:{scheme:scheme,host:host,port:port,root:approot},setUsername:setUsername,setPassword:setPassword,setAuthToken:setAuthToken,info:infoHandler,warn:warnHandler,error:errorHandler,debug:debugHandler,_getError:_getError,_getHealth:_getHealth,getHealth:function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){var err=this._getError(e);err._scope=this;d.reject(err)};this._getHealth(function(health){health=health||{};health._scope=this;d.resolve(health)},opts);return d.promise},_login:_login,login:function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._login(function(res){d.resolve(res)},opts);return d.promise},_logout:_logout,logout:function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._logout(function(res){d.resolve(res)},opts);return d.promise},_getGrant:_getGrant,getGrant:function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getGrant(function(grant){d.resolve(grant)},opts);return d.promise},_getAppInfo:_getAppInfo,getAppInfo:function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getAppInfo(function(appinfo){d.resolve(appinfo)},opts);return d.promise},_getSysInfo:_getSysInfo,getSysInfo:function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getSysInfo(function(sysinfo){d.resolve(sysinfo)},opts);return d.promise},_getUserInfo:_getUserInfo,getUserInfo:function(userlogin,opts){var d=Q.defer();if(opts===undefined)opts={};opts.error=function(e){d.reject(e)};this._getUserInfo(function(userinfo){d.resolve(userinfo)},userlogin,opts);return d.promise},_getNews:_getNews,getNews:function(opts){var d=Q.defer();opts=opts||{};opts.error=function(e){d.reject(e)};this._getNews(function(news){d.resolve(news)},opts);return d.promise},getBusinessObject:getBusinessObject,getBusinessProcess:getBusinessProcess,getExternalObject:getExternalObject}}};
/**
 * Simplicite(R) platform Javascript API client module (for node.js and browser).
 * @module simplicite
 * @version 2.0.1
 * @license Apache-2.0
 */
const Q=require("q");const fetch=require("cross-fetch");const buffer=require("buffer");const constants={DEFAULT_ROW_ID_NAME:"row_id",DEFAULT_ROW_ID:"0",CONTEXT_NONE:0,CONTEXT_SEARCH:1,CONTEXT_LIST:2,CONTEXT_CREATE:3,CONTEXT_COPY:4,CONTEXT_UPDATE:5,CONTEXT_DELETE:6,CONTEXT_GRAPH:7,CONTEXT_CROSSTAB:8,CONTEXT_PRINTTMPL:9,CONTEXT_UPDATEALL:10,CONTEXT_REFSELECT:11,CONTEXT_DATAMAPSELECT:12,CONTEXT_PREVALIDATE:13,CONTEXT_POSTVALIDATE:14,CONTEXT_STATETRANSITION:15,CONTEXT_EXPORT:16,CONTEXT_IMPORT:17,CONTEXT_ASSOCIATE:18,CONTEXT_PANELLIST:19,TYPE_ID:0,TYPE_INT:1,TYPE_FLOAT:2,TYPE_STRING:3,TYPE_DATE:4,TYPE_DATETIME:5,TYPE_TIME:6,TYPE_ENUM:7,TYPE_BOOLEAN:8,TYPE_PASSWORD:9,TYPE_URL:10,TYPE_HTML:11,TYPE_EMAIL:12,TYPE_LONG_STRING:13,TYPE_ENUM_MULTI:14,TYPE_REGEXP:15,TYPE_DOC:17,TYPE_FLOAT_EMPTY:18,TYPE_EXTFILE:19,TYPE_IMAGE:20,TYPE_NOTEPAD:21,TYPE_PHONENUM:22,TYPE_COLOR:23,TYPE_OBJECT:24,TYPE_GEOCOORDS:25,VIS_NOT:0,VIS_HIDDEN:0,VIS_LIST:1,VIS_FORM:2,VIS_BOTH:3,SEARCH_NONE:0,SEARCH_MONO:1,SEARCH_MULTI_CHECK:2,SEARCH_MULTI_LIST:3,SEARCH_PERIOD:4,TRUE:"1",FALSE:"0",ERRLEVEL_FATAL:1,ERRLEVEL_ERROR:2,ERRLEVEL_WARNING:3,RESOURCE_TYPE_IMAGE:"IMG",RESOURCE_TYPE_ICON:"ICO",RESOURCE_TYPE_STYLESHEET:"CSS",RESOURCE_TYPE_JAVASCRIPT:"JS"};function session(params){return new Session(params)}function Session(params){params=params||{};this.constants=constants;this.endpoint=params.endpoint||"api";this.log=params.logHandler||(arg=>{console.log(arg)});this.info=params.infoHandle||(arg=>{console.info(arg)});this.warn=params.warningHandler||(arg=>{console.warn(arg)});this.error=params.errorHandler||(arg=>{console.error(arg)});const _debug=!!params.debug;this.debug=params.debugHandler||(arg=>{if(_debug)console.log(arg)});this.timeout=params.timeout||30;if(params.url){try{params.scheme=params.url.replace(/:.*$/,"");const u=params.url.replace(new RegExp("^"+params.scheme+"://"),"").split(":");if(u.length===1){params.host=u[0].replace(/\/.*$/,"");params.port=params.scheme==="http"?80:443;params.root=u[0].replace(new RegExp("^"+params.host+"/?"),"")}else{params.host=u[0];params.port=parseInt(u[1].replace(/\/.*$/,""),10);if(isNaN(params.port))throw new Error("Incorrect port");params.root=u[1].replace(new RegExp("^"+params.port+"/?"),"")}if(params.root==="/")params.root=""}catch(e){this.error("Unable to parse URL ["+params.url+"]: "+e.message);return}}const scheme=params.scheme||(params.port===443?"https":"http");if(scheme!=="http"&&scheme!=="https"){this.error("Incorrect scheme ["+params.scheme+"]");return}const host=params.host||"localhost";const port=params.port||8080;let root=params.root||"";if(root==="/")root="";let url=scheme+"://"+host;if(scheme==="http"&&port!=80||scheme==="https"&&port!=443)url+=":"+port;if(root!=="")url+=root.startsWith("/")?root:"/"+root;this.debug("[simplicite] Base URL = "+url);const ep=this.endpoint=="public"?"":"/"+this.endpoint;this.parameters={scheme:scheme,host:host,port:port,root:root,url:url,healthpath:(ep=="/ui"?ep:"")+"/health?format=json",apppath:ep+"/json/app",objpath:ep+"/json/obj",extpath:ep+"/ext",docpath:ep+"/raw/document",respath:"/resource"};this.username=params.username||params.login;this.setUsername=usr=>{this.username=usr};this.password=params.password||params.pwd;this.setPassword=pwd=>{this.password=pwd};this.authtoken=params.authtoken||params.authToken||params.token;this.setAuthToken=tkn=>{this.authtoken=tkn};let businessObjectCache={};this.getBusinessObjectCacheKey=(name,instance)=>{return name+":"+(instance||"js_"+name)};this.clear=()=>{this.username=undefined;this.password=undefined;this.authtoken=undefined;this.sessionid=undefined;this.grant=undefined;this.appinfo=undefined;this.sysinfo=undefined;this.devinfo=undefined;this.userinfo=undefined;businessObjectCache={}};this.getBasicAuthHeader=()=>{return this.username&&this.password?"Basic "+buffer.Buffer.from(this.username+":"+this.password).toString("base64"):undefined};this.getBearerTokenHeader=()=>{return this.authtoken?"Bearer "+this.authtoken:undefined};this.req=(path,data,callback,errorHandler)=>{const self=this;const m=data?"post":"get";const h={};if(data)h["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8";let b=self.getBearerTokenHeader();if(b){self.debug("[simplicite.req] Using bearer token header = "+b);h["X-Simplicite-Authorization"]=b}else{b=self.getBasicAuthHeader();if(b){self.debug("[simplicite.req] Using basic auth header = "+b);h.Authorization=b}}fetch(self.parameters.url+path||"/",{method:m,headers:h,mode:"cors",credentials:"include",body:data?typeof data==="string"?data:JSON.stringify(data):undefined}).then(res=>{if(callback){res.text().then(data=>{callback.call(self,data,res.status,res.headers)})}}).catch(err=>{const s=err.response&&err.response.status?err.response.status:undefined;const e=err.response&&err.response.data?err.response.data:err;if(errorHandler)errorHandler.call(self,self.getError.call(self,e,s));else throw e})};this.getError=(err,status)=>{if(typeof err==="string")return{message:err,status:status||200};else if(err.response)return typeof err.response==="string"?{message:err.response,status:status||200}:err.response;else return err};this.parse=(res,status)=>{try{if(status!==200)return{type:"error",response:this.getError("HTTP status: "+status,status)};return typeof res==="object"?res:JSON.parse(res)}catch(e){return{type:"error",response:this.getError("Parsing error: "+e.message,status)}}};function _getHealth(callback,opts){const self=this;opts=opts||{};self.req.call(self,self.parameters.healthpath+"&full="+!!opts.full,undefined,(res,status)=>{const r=self.parse(res,status);self.debug("[simplicite._getHealth] HTTP status = "+status+", response type = "+res);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{if(callback)callback.call(self,r)}},e=>{(opts.error?opts.error:self.error).call(self,e)})}this.getHealth=opts=>{const d=Q.defer();opts=opts||{};opts.error=e=>{const err=this.getError(e);d.reject(err)};_getHealth.call(this,health=>{d.resolve(health)},opts);return d.promise};function _login(callback,opts){const self=this;opts=opts||{};if((opts.username||opts.login)&&(opts.password||opts.pwd)){self.clear();self.username=opts.username||opts.login;self.password=opts.password||opts.pwd}else if(opts.authtoken||opts.authToken||opts.token){self.clear();self.authtoken=opts.authtoken||opts.authToken||opts.token}self.req.call(self,self.parameters.apppath+"?action=session",undefined,(res,status)=>{const r=self.parse(res,status);self.debug("[simplicite.login] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.sessionid=r.response.id;self.debug("[simplicite.login] Session ID = "+self.sessionid);self.username=r.response.login;if(self.username)self.debug("[simplicite.login] Username = "+self.username);self.authtoken=r.response.authtoken;if(self.authtoken)self.debug("[simplicite.login] Auth token = "+self.authtoken);self.grant=Object.assign(new Grant,{login:r.response.login,userid:r.response.userid,firstname:r.response.firstanme,lastname:r.response.lastname,email:r.response.email});if(callback)callback.call(self,r.response)}},e=>{(opts.error?opts.error:self.error).call(self,e)})}this.login=opts=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_login.call(this,res=>{d.resolve(res)},opts);return d.promise};function _logout(callback,opts){const self=this;opts=opts||{};self.req.call(self,self.parameters.apppath+"?action=logout",undefined,(res,status)=>{const r=self.parse(res,status);self.debug("[simplicite.logout] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.clear();if(callback)callback.call(self,r.response)}},e=>{if(e.status===401)self.authtoken=undefined;(opts.error?opts.error:self.error).call(self,e)})}this.logout=opts=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_logout.call(this,res=>{d.resolve(res)},opts);return d.promise};this.grant=undefined;function _getGrant(callback,opts){const self=this;opts=opts||{};let p="&web=true";if(opts.inlinePicture||opts.picture)p+="&inline_picture="+(!!opts.inlinePicture||!!opts.picture);if(opts.includeTexts||opts.texts)p+="&texts="+(!!opts.includeTexts||!!opts.texts);self.req.call(self,self.parameters.apppath+"?action=getgrant"+p,undefined,(res,status)=>{const r=self.parse(res,status);self.debug("[simplicite.getGrant] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.grant=Object.assign(new Grant,r.response);if(callback)callback.call(self,self.grant)}},e=>{(opts.error?opts.error:self.error).call(self,e)})}this.getGrant=opts=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getGrant.call(this,grt=>{d.resolve(grt)},opts);return d.promise};function _changePassword(callback,pwd,opts){const self=this;opts=opts||{};self.req.call(self,self.parameters.apppath+"?action=setpassword&password="+encodeURIComponent(pwd),undefined,(res,status)=>{const r=self.parse(res,status);self.debug("[simplicite.changePassword] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{if(callback)callback.call(self,r.response)}},e=>{(opts.error?opts.error:self.error).call(self,e)})}this.changePassword=(pwd,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_changePassword.call(this,res=>{d.resolve(res)},pwd,opts);return d.promise};function _getAppInfo(callback,opts){const self=this;opts=opts||{};self.req.call(self,self.parameters.apppath+"?action=getinfo",undefined,(res,status)=>{const r=self.parse(res,status);self.debug("[simplicite.getAppInfo] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.appinfo=r.response;if(callback)callback.call(self,self.appinfo)}},e=>{(opts.error?opts.error:self.error).call(self,e)})}this.getAppInfo=opts=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getAppInfo.call(this,inf=>{d.resolve(inf)},opts);return d.promise};function _getSysInfo(callback,opts){const self=this;opts=opts||{};self.req.call(self,self.parameters.apppath+"?action=sysinfo",undefined,(res,status)=>{const r=self.parse(res,status);self.debug("[simplicite.getSysInfo] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.sysinfo=r.response;if(callback)callback.call(self,self.sysinfo)}},e=>{(opts.error?opts.error:self.error).call(self,e)})}this.getSysInfo=opts=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getSysInfo.call(this,inf=>{d.resolve(inf)},opts);return d.promise};function _getDevInfo(callback,module,opts){const self=this;opts=opts||{};let p="";if(module)p+="&module="+encodeURIComponent(module);self.req.call(self,self.parameters.apppath+"?action=devinfo"+p,undefined,(res,status)=>{const r=self.parse(res,status);self.debug("[simplicite.getDevInfo] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.devinfo=r.response;if(callback)callback.call(self,self.devinfo)}},e=>{(opts.error?opts.error:self.error).call(self,e)})}this.getDevInfo=(module,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getDevInfo.call(this,inf=>{d.resolve(inf)},module,opts);return d.promise};function _getNews(callback,opts){const self=this;opts=opts||{};let p="";if(opts.inlineImages)p+="&inline_images="+!!opts.inlineImages;self.req.call(self,self.parameters.apppath+"?action=news"+p,undefined,(res,status)=>{const r=self.parse(res,status);self.debug("[simplicite.getNews] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{self.news=r.response;if(callback)callback.call(self,self.news)}},e=>{(opts.error?opts.error:self.error).call(self,e)})}this.getNews=opts=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getNews.call(this,nws=>{d.resolve(nws)},opts);return d.promise};function _indexSearch(callback,request,object,opts){const self=this;opts=opts||{};let p="";if(opts.metadata===true)p+="&_md=true";if(opts.context)p+="&context="+encodeURIComponent(opts.context);self.req.call(self,self.parameters.apppath+"?action=indexsearch&request="+encodeURIComponent(request?request:"")+(object?"&object="+encodeURIComponent(object):"")+p,undefined,(res,status)=>{const r=self.parse(res,status);self.debug("[simplicite.indexSearch] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.error).call(self,r.response)}else{if(callback)callback.call(self,r.response)}},e=>{(opts.error?opts.error:self.error).call(self,e)})}this.indexSearch=(request,object,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_indexSearch.call(this,srs=>{d.resolve(srs)},request,object,opts);return d.promise};this.getBusinessObject=(name,instance)=>{const cacheKey=this.getBusinessObjectCacheKey(name,instance);let obj=businessObjectCache[cacheKey];if(!obj){obj=new BusinessObject(this,name,instance);businessObjectCache[cacheKey]=obj}return obj};this.getExternalObject=name=>{return new ExternalObject(this,name)};this.getResourceURL=(code,type,object,objId)=>{return this.parameters.url+this.parameters.respath+"?code="+encodeURIComponent(code)+"&type="+encodeURIComponent(type||"IMG")+(object?"&object="+encodeURIComponent(object):"")+(objId?"&objid="+encodeURIComponent(objId):"")+(this.authtoken?"_x_simplicite_authorization_="+encodeURIComponent(this.authtoken):"")}}function Grant(){this.getUserId=()=>{return this.userid};this.getUsername=()=>{return this.login};this.getLogin=this.getUsername;this.getLang=()=>{return this.lang};this.getEmail=()=>{return this.email};this.getFirstname=()=>{return this.firstname};this.getFirstName=this.getFirstname;this.getLastname=()=>{return this.lastname};this.getLastName=this.getLastname;this.getPictureURL=()=>{if(this.picture)return"data:"+this.picture.mime+";base64,"+this.picture.content};this.hasResponsibility=group=>{return this.responsibilities&&this.responsibilities.indexOf(group)!==-1};this.T=code=>{return this.texts?this.texts[code]||"":""}}function Document(){this.getId=()=>{return this.id};this.getMIMEType=()=>{return this.mime};this.getMimeType=this.getMIMEType;this.setMIMEType=mime=>{this.mime=mime};this.setMimeType=this.setMIMEType;this.getFilename=()=>{return this.filename};this.getFileName=this.getFilename;this.setFilename=filename=>{this.filename=filename};this.setFileName=this.setFilename;this.getContent=()=>{return this.content};this.getThumbnail=()=>{return this.thumbnail};function getBuffer(data){return buffer.Buffer.from(data,"base64")}this.getContentAsArrayBuffer=()=>{return getBuffer(this.content).buffer};this.getThumbnailAsArrayBuffer=()=>{return getBuffer(this.thumbnail||"").buffer};this.getContentAsText=encoding=>{return getBuffer(this.content).toString(encoding||"utf-8")};this.setContent=content=>{this.content=content};this.setContentFromText=(content,encoding)=>{this.content=buffer.Buffer.from(content,encoding||"utf-8").toString("base64")};this.getDataURL=thumbnail=>{if(this.content)return"data:"+this.mime+";base64,"+(thumbnail&&this.thumbnail?this.thumbnail:this.content)};this.getValue=()=>{return JSON.parse(JSON.stringify(this))}}function BusinessObjectMetadata(name,instance){this.name=name;this.instance=instance;this.rowidfield=constants.DEFAULT_ROW_ID_NAME;this.label=name;this.help="";this.fields=[]}function BusinessObject(ses,name,instance){instance=instance||"js_"+name;this.session=ses;this.metadata=new BusinessObjectMetadata(name,instance);this.cacheKey=this.session.getBusinessObjectCacheKey(name,instance);this.path=this.session.parameters.objpath+"?object="+encodeURIComponent(name)+"&inst="+encodeURIComponent(instance);this.item={};this.filters={};this.list=[];function _getMetaData(callback,opts){const self=this;opts=opts||{};let p="";if(opts.context)p+="&context="+encodeURIComponent(opts.context);if(opts.contextParam)p+="&contextparam="+encodeURIComponent(opts.contextParam);self.session.req.call(self.session,self.path+"&action=metadata"+p,undefined,(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.getMetaData] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.metadata=r.response;if(callback)callback.call(self,self.metadata)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.getMetaData=opts=>{const d=Q.defer();_getMetaData.call(this,metadata=>{d.resolve(metadata)},opts);return d.promise};this.getMetadata=this.getMetaData;this.getName=()=>{return this.metadata.name};this.getInstance=()=>{return this.metadata.instance};this.getLabel=()=>{return this.metadata.label};this.getHelp=()=>{return this.metadata.help};this.getFields=()=>{return this.metadata.fields};this.getField=fieldName=>{let n=0;const fs=this.getFields();while(n<fs.length&&fs[n].name!==fieldName)n++;if(n<fs.length)return fs[n]};this.getRowIdFieldName=()=>{return this.metadata.rowidfield};this.getRowIdField=()=>{return this.getField(this.getRowIdFieldName())};this.getLinks=()=>{return this.metadata.links};this.getFieldType=field=>{if(typeof field==="string")field=this.getField(field);if(field)return field.type};this.getFieldLabel=field=>{if(typeof field==="string")field=this.getField(field);if(field)return field.label};this.getFieldValue=(field,item)=>{if(!item)item=this.item;if(field&&item){return item[typeof field==="string"?field:field.name]}};this.getFieldListValue=(field,item)=>{if(typeof field==="string")field=this.getField(field);const val=this.getFieldValue(field,item);return field&&field.listOfValues?this.getListValue(field.listOfValues,val):val};this.getFieldDataURL=(field,item)=>{if(typeof field!=="string")field=field.fullinput||field.name;const val=this.getFieldValue(field,item);if(val&&val.mime)return"data:"+val.mime+";base64,"+(val.content||val.thumbnail)};this.getFieldDocument=(field,item)=>{if(typeof field!=="string")field=field.fullinput||field.input||field.name;const val=this.getFieldValue(field,item);if(val&&val.mime)return Object.assign(new Document,val);else return val};this.getFieldDocumentURL=(field,item,thumbnail)=>{if(typeof field!=="string")field=field.fullinput||field.input||field.name;let val=this.getFieldValue(field,item);if(val&&val.mime)val=val.id;if(val)return this.session.parameters.url+this.session.parameters.docpath+"?object="+encodeURIComponent(this.metadata.name)+"&inst="+encodeURIComponent(this.metadata.instance)+"&field="+encodeURIComponent(field)+"&row_id="+encodeURIComponent(this.getRowId(item))+"&doc_id="+encodeURIComponent(val)+(thumbnail?"&thumbnail=true":"")+(this.session.authtoken?"&_x_simplicite_authorization_="+encodeURIComponent(this.session.authtoken):"")};this.getListValue=(list,code)=>{if(list){for(let i=0;i<list.length;i++){const l=list[i];if(l.code===code)return l.value}}return code};this.setFieldValue=(field,value,item)=>{if(!item)item=this.item;if(field&&item){item[typeof field==="string"?field:field.name]=value instanceof Document?value.getValue():value}};this.isRowIdField=field=>{return!field.ref&&field.name===this.metadata.rowidfield};this.isTimestampField=field=>{const n=field.name;return!field.ref&&(n==="created_by"||n==="created_dt"||n==="updated_by"||n==="updated_dt")};function _getFilters(callback,opts){const self=this;opts=opts||{};let p="";if(opts.context)p+="&context="+encodeURIComponent(opts.context);if(opts.reset)p+="&reset="+!!opts.reset;self.session.req.call(self.session,self.path+"&action=filters"+p,undefined,(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.getFilters] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.item=r.response;if(callback)callback.call(self,self.filters)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.getFilters=opts=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getFilters.call(this,filters=>{d.resolve(filters)},opts);return d.promise};function _getOptions(options){let opts="";if(options.context)opts+="&context="+encodeURIComponent(options.context);const id=options.inlineDocs||options.inlineDocuments||options.inlineImages;if(id)opts+="&inline_documents="+encodeURIComponent(id.join?id.join(","):id);const it=options.inlineThumbs||options.inlineThumbnails;if(it)opts+="&inline_thumbnails="+encodeURIComponent(it.join?it.join(","):it);const io=options.inlineObjs||options.inlineObjects;if(io)opts+="&inline_objects="+encodeURIComponent(io.join?io.join(","):io);return opts}function _getReqParams(data){let p="";if(!data)return p;let n=0;for(let i in data){const d=data[i]||"";if(d.name&&d.content){if(d.content.startsWith("data:"))d.content=d.content.replace(/data:.*;base64,/,"");p+=(n++!==0?"&":"")+i+"="+encodeURIComponent("id|"+(d.id?d.id:"0")+"|name|"+d.name+"|content|"+d.content)}else if(d.object&&d.row_id){p+=(n++!==0?"&":"")+i+"="+encodeURIComponent("object|"+d.object+"|row_id|"+d.row_id)}else if(d.sort){for(let j=0;j<d.length;j++)p+=(n++!==0?"&":"")+i+"="+encodeURIComponent(d[j])}else{p+=(n++!==0?"&":"")+i+"="+encodeURIComponent(d)}}return p}function _count(callback,filters,opts){const self=this;opts=opts||{};self.filters=filters||{};self.session.req.call(self.session,self.path+"&action=count",_getReqParams(self.filters),(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.getCount] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.count=r.response.count;self.page=r.response.page>=0?r.response.page+1:undefined;self.maxpage=r.response.maxpage>=0?r.response.maxpage+1:undefined;self.list=[];if(callback)callback.call(self,self.count)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.count=(filters,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_count.call(this,count=>{d.resolve(count)},filters,opts);return d.promise};this.getCount=this.count;function _search(callback,filters,opts){const self=this;opts=opts||{};let p=_getOptions(opts);if(opts.page>0)p+="&page="+(opts.page-1);if(opts.metadata===true)p+="&_md=true";if(opts.visible===true)p+="&_visible=true";self.filters=filters||{};self.session.req.call(self.session,self.path+"&action=search"+p,_getReqParams(self.filters),(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.search] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{if(res.meta)self.metadata=r.response.meta;self.count=r.response.count;self.page=r.response.page>=0?r.response.page+1:undefined;self.maxpage=r.response.maxpage>=0?r.response.maxpage+1:undefined;self.list=r.response.list;if(callback)callback.call(self,self.list)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.search=(filters,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_search.call(this,list=>{d.resolve(list)},filters,opts);return d.promise};function _get(callback,rowId,opts){const self=this;opts=opts||{};let p=_getOptions(opts);const tv=opts.treeView;if(tv)p+="&treeview="+encodeURIComponent(tv);if(opts.fields){for(let i=0;i<opts.fields.length;i++){p+="&fields="+encodeURIComponent(opts.fields[i].replace(".","__"))}}if(opts.metadata)p+="&_md=true";if(opts.social)p+="&_social=true";self.session.req.call(self.session,self.path+"&action=get&"+self.metadata.rowidfield+"="+encodeURIComponent(rowId)+p,undefined,(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.get] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{if(res.meta)self.metadata=r.response.meta;if(res.data)self.item=tv?r.response.data.item:r.response.data;else self.item=tv?r.response.item:r.response;if(callback)callback.call(self,tv?r.response:self.item)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.get=(rowId,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_get.call(this,itm=>{d.resolve(itm)},rowId,opts);return d.promise};function _getForCreate(callback,opts){opts=opts||{};delete opts.treeview;delete opts.fields;opts.context=constants.CONTEXT_CREATE;_get.call(this,callback,this.session.constants.DEFAULT_ROW_ID,opts)}this.getForCreate=opts=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getForCreate.call(this,itm=>{d.resolve(itm)},opts);return d.promise};function _getForUpdate(callback,rowId,opts){opts=opts||{};delete opts.treeview;delete opts.fields;opts.context=constants.CONTEXT_UPDATE;_get.call(this,callback,rowId,opts)}this.getForUpdate=(rowId,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getForUpdate.call(this,itm=>{d.resolve(itm)},rowId,opts);return d.promise};function _getForCopy(callback,rowId,opts){opts=opts||{};delete opts.treeview;delete opts.fields;opts.context=constants.CONTEXT_COPY;_get.call(this,callback,rowId,opts)}this.getForCopy=(rowId,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getForCopy.call(this,itm=>{d.resolve(itm)},rowId,opts);return d.promise};function _getForDelete(callback,rowId,opts){opts=opts||{};delete opts.treeview;delete opts.fields;opts.context=constants.CONTEXT_CREATE;_get.call(this,callback,rowId,opts)}this.getForDelete=(rowId,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getForDelete.call(this,itm=>{d.resolve(itm)},rowId,opts);return d.promise};this.getRowId=item=>{item=item||this.item;if(item)return item[this.getRowIdFieldName()]};function _populate(callback,rowId,opts){const self=this;opts=opts||{};let p=_getOptions(opts);self.session.req.call(self.session,self.path+"&action=populate&"+self.metadata.rowidfield+"="+encodeURIComponent(rowId)+p,undefined,(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.populate] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.item=r.response;if(callback)callback.call(self,self.item)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.populate=(itm,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_populate.call(this,i=>{d.resolve(i)},itm,opts);return d.promise};function _save(callback,item,opts){if(item)this.item=item;const rowId=this.item[this.metadata.rowidfield];if(!rowId||rowId===constants.DEFAULT_ROW_ID)_create.call(this,callback,item,opts);else _update.call(this,callback,item,opts)}this.save=(itm,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_save.call(this,i=>{d.resolve(i)},itm,opts);return d.promise};function _create(callback,item,opts){const self=this;if(item)self.item=item;opts=opts||{};let p=_getOptions(opts);self.session.req.call(self.session,self.path+"&action=create"+p,_getReqParams(self.item),(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.create] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.item=r.response.data?r.response.data:r.response;if(callback)callback.call(self,self.item)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.create=(itm,opts)=>{itm.row_id=this.session.constants.DEFAULT_ROW_ID;const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_create.call(this,i=>{d.resolve(i)},itm,opts);return d.promise};function _update(callback,item,opts){const self=this;if(item)self.item=item;opts=opts||{};let p=_getOptions(opts);self.session.req.call(self.session,self.path+"&action=update"+p,_getReqParams(self.item),(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.update] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.item=r.response.data?r.response.data:r.response;if(callback)callback.call(self,self.item)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.update=(itm,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_update.call(this,i=>{d.resolve(i)},itm,opts);return d.promise};function _del(callback,item,opts){const self=this;if(item)self.item=item;opts=opts||{};self.session.req.call(self.session,self.path+"&action=delete&"+self.metadata.rowidfield+"="+encodeURIComponent(self.item[self.metadata.rowidfield]),undefined,(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.del] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.item=undefined;delete r.response.undoredo;if(callback)callback.call(self,r.response)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.del=(itm,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_del.call(this,r=>{d.resolve(r)},itm,opts);return d.promise};function _action(callback,action,rowId,opts){const self=this;opts=opts||{};self.session.req.call(self.session,self.path+"&action="+encodeURIComponent(action)+(rowId?"&"+self.getRowIdFieldName()+"="+encodeURIComponent(rowId):""),_getReqParams(opts.parameters),(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.action("+action+")] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{const result=r.response.result;if(callback)callback.call(self,result)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.action=(action,rowId,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_action.call(this,res=>{d.resolve(res)},action,rowId,opts);return d.promise};function _crosstab(callback,crosstab,opts){const self=this;opts=opts||{};if(opts.filters)self.filters=opts.filters;self.session.req.call(self.session,self.path+"&action=crosstab&crosstab="+encodeURIComponent(crosstab),_getReqParams(self.filters),(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.crosstab("+crosstab+")] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{self.crosstabdata=r.response;if(callback)callback.call(self,self.crosstabdata)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.crosstab=(ctb,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_crosstab.call(this,res=>{d.resolve(res)},ctb,opts);return d.promise};function _print(callback,prt,rowId,opts){const self=this;opts=opts||{};if(opts.filters)self.filters=opts.filters;let p="";if(opts.all)p+="&all="+!!opts.all;if(opts.mailing)p+="&mailing="+!!opts.mailing;self.session.req.call(self.session,self.path+"&action=print&printtemplate="+encodeURIComponent(prt)+(rowId?"&"+self.getRowIdFieldName()+"="+encodeURIComponent(rowId):"")+p,undefined,(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.print("+prt+")] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{if(callback)callback.call(self,Object.assign(new Document,r.response))}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.print=(pt,rowId,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_print.call(this,res=>{d.resolve(res)},pt,rowId,opts);return d.promise};function _setParameter(callback,param,value,opts){const self=this;opts=opts||{};let p={name:param};if(value)p.value=value;self.session.req.call(self.session,self.path+"&action=setparameter",_getReqParams(p),(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.setParameter("+p.name+")] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{const result=r.response.result;if(callback)callback.call(self,result)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.setParameter=(param,value,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_setParameter.call(this,()=>{d.resolve()},param,value,opts);return d.promise};function _getParameter(callback,param,opts){const self=this;opts=opts||{};let p={name:param};self.session.req.call(self.session,self.path+"&action=getparameter",_getReqParams(p),(res,status)=>{const r=self.session.parse(res,status);self.session.debug("[simplicite.BusinessObject.getParameter("+p.name+")] HTTP status = "+status+", response type = "+r.type);if(r.type==="error"){(opts.error?opts.error:self.session.error).call(self,r.response)}else{const result=r.response.result;if(callback)callback.call(self,result)}},e=>{(opts.error?opts.error:self.session.error).call(self,e)})}this.getParameter=(param,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_getParameter.call(this,value=>{d.resolve(value)},param,opts);return d.promise};this.getResourceURL=(code,type)=>{return this.session.getResourceURL(code,type,this.metadata.name,this.metadata.id)}}function ExternalObjectMetadata(name){this.name=name}function ExternalObject(ses,name){this.session=ses;this.metadata=new ExternalObjectMetadata(name);this.path=this.session.parameters.extpath+"/"+encodeURIComponent(name);this.getName=()=>{return this.metadata.name};this.callParams=params=>{let p="";if(!params)return p;let n=0;for(let i in params){const v=params[i]||"";if(v.sort){for(let j=0;j<v.length;j++)p+=(n++!==0?"&":"")+i+"="+encodeURIComponent(v[j])}else{p+=(n++!==0?"&":"")+i+"="+encodeURIComponent(v)}}return p};function _call(callback,params,data,opts){const self=this;opts=opts||{};let p="";if(params)p="?"+self.callParams(params);const m=opts.method?opts.method:data?"post":"get";const h={};if(opts.contentType)h["Content-Type"]=opts.contentType;let b=self.session.getBearerTokenHeader();if(b){self.session.debug("[simplicite.ExternalObject.call] Using bearer token header = "+b);h["X-Simplicite-Authorization"]=b}else{b=self.session.getBasicAuthHeader();if(b){self.session.debug("[simplicite.ExternalObject.call] Using basic auth header = "+b);h.Authorization=b}}fetch(self.session.parameters.url+self.path+p,{method:m,headers:h,timeout:self.session.timeout*1e3,mode:"cors",credentials:"include",body:data?typeof data==="string"?data:JSON.stringify(data):undefined}).then(res=>{if(callback){res.text().then(data=>{callback.call(self,data,res.status,res.headers)})}}).catch(err=>{if(opts.error)opts.error.call(self,err);else throw err})}this.call=(params,data,opts)=>{const d=Q.defer();opts=opts||{};opts.error=opts.error||(e=>{d.reject(e)});_call.call(this,value=>{d.resolve(value)},params,data,opts);return d.promise}}module.exports={session:session,Session:Session,Grant:Grant,BusinessObject:BusinessObject,BusinessObjectMetadata:BusinessObjectMetadata,ExternalObject:ExternalObject};
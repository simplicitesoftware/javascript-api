<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>session.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BusinessObject.html">BusinessObject</a><ul class='methods'><li data-type='method'><a href="BusinessObject.html#action">action</a></li><li data-type='method'><a href="BusinessObject.html#create">create</a></li><li data-type='method'><a href="BusinessObject.html#crosstab">crosstab</a></li><li data-type='method'><a href="BusinessObject.html#del">del</a></li><li data-type='method'><a href="BusinessObject.html#get">get</a></li><li data-type='method'><a href="BusinessObject.html#getCount">getCount</a></li><li data-type='method'><a href="BusinessObject.html#getField">getField</a></li><li data-type='method'><a href="BusinessObject.html#getFieldDataURL">getFieldDataURL</a></li><li data-type='method'><a href="BusinessObject.html#getFieldDocument">getFieldDocument</a></li><li data-type='method'><a href="BusinessObject.html#getFieldDocumentURL">getFieldDocumentURL</a></li><li data-type='method'><a href="BusinessObject.html#getFieldLabel">getFieldLabel</a></li><li data-type='method'><a href="BusinessObject.html#getFieldLinkedList">getFieldLinkedList</a></li><li data-type='method'><a href="BusinessObject.html#getFieldListColors">getFieldListColors</a></li><li data-type='method'><a href="BusinessObject.html#getFieldListValue">getFieldListValue</a></li><li data-type='method'><a href="BusinessObject.html#getFieldType">getFieldType</a></li><li data-type='method'><a href="BusinessObject.html#getFieldValue">getFieldValue</a></li><li data-type='method'><a href="BusinessObject.html#getFields">getFields</a></li><li data-type='method'><a href="BusinessObject.html#getFilters">getFilters</a></li><li data-type='method'><a href="BusinessObject.html#getForCopy">getForCopy</a></li><li data-type='method'><a href="BusinessObject.html#getForCreate">getForCreate</a></li><li data-type='method'><a href="BusinessObject.html#getForDelete">getForDelete</a></li><li data-type='method'><a href="BusinessObject.html#getForUpdate">getForUpdate</a></li><li data-type='method'><a href="BusinessObject.html#getHelp">getHelp</a></li><li data-type='method'><a href="BusinessObject.html#getInstance">getInstance</a></li><li data-type='method'><a href="BusinessObject.html#getLabel">getLabel</a></li><li data-type='method'><a href="BusinessObject.html#getLinks">getLinks</a></li><li data-type='method'><a href="BusinessObject.html#getListColors">getListColors</a></li><li data-type='method'><a href="BusinessObject.html#getListValue">getListValue</a></li><li data-type='method'><a href="BusinessObject.html#getMetaData">getMetaData</a></li><li data-type='method'><a href="BusinessObject.html#getMetadata">getMetadata</a></li><li data-type='method'><a href="BusinessObject.html#getName">getName</a></li><li data-type='method'><a href="BusinessObject.html#getParameter">getParameter</a></li><li data-type='method'><a href="BusinessObject.html#getPath">getPath</a></li><li data-type='method'><a href="BusinessObject.html#getResourceURL">getResourceURL</a></li><li data-type='method'><a href="BusinessObject.html#getRowId">getRowId</a></li><li data-type='method'><a href="BusinessObject.html#getRowIdField">getRowIdField</a></li><li data-type='method'><a href="BusinessObject.html#getRowIdFieldName">getRowIdFieldName</a></li><li data-type='method'><a href="BusinessObject.html#isRowIdField">isRowIdField</a></li><li data-type='method'><a href="BusinessObject.html#isTimestampField">isTimestampField</a></li><li data-type='method'><a href="BusinessObject.html#placemap">placemap</a></li><li data-type='method'><a href="BusinessObject.html#populate">populate</a></li><li data-type='method'><a href="BusinessObject.html#print">print</a></li><li data-type='method'><a href="BusinessObject.html#resetValues">resetValues</a></li><li data-type='method'><a href="BusinessObject.html#save">save</a></li><li data-type='method'><a href="BusinessObject.html#search">search</a></li><li data-type='method'><a href="BusinessObject.html#setFieldValue">setFieldValue</a></li><li data-type='method'><a href="BusinessObject.html#setFieldValues">setFieldValues</a></li><li data-type='method'><a href="BusinessObject.html#setParameter">setParameter</a></li><li data-type='method'><a href="BusinessObject.html#update">update</a></li></ul></li><li><a href="BusinessObjectMetadata.html">BusinessObjectMetadata</a></li><li><a href="Doc.html">Doc</a><ul class='methods'><li data-type='method'><a href="Doc.html#getContent">getContent</a></li><li data-type='method'><a href="Doc.html#getContentAsArrayBuffer">getContentAsArrayBuffer</a></li><li data-type='method'><a href="Doc.html#getContentAsText">getContentAsText</a></li><li data-type='method'><a href="Doc.html#getDataURL">getDataURL</a></li><li data-type='method'><a href="Doc.html#getFileName">getFileName</a></li><li data-type='method'><a href="Doc.html#getFilename">getFilename</a></li><li data-type='method'><a href="Doc.html#getId">getId</a></li><li data-type='method'><a href="Doc.html#getMIMEType">getMIMEType</a></li><li data-type='method'><a href="Doc.html#getMimeType">getMimeType</a></li><li data-type='method'><a href="Doc.html#getName">getName</a></li><li data-type='method'><a href="Doc.html#getThumbnail">getThumbnail</a></li><li data-type='method'><a href="Doc.html#getThumbnailAsArrayBuffer">getThumbnailAsArrayBuffer</a></li><li data-type='method'><a href="Doc.html#getValue">getValue</a></li><li data-type='method'><a href="Doc.html#load">load</a></li><li data-type='method'><a href="Doc.html#setContent">setContent</a></li><li data-type='method'><a href="Doc.html#setContentFromText">setContentFromText</a></li><li data-type='method'><a href="Doc.html#setFileName">setFileName</a></li><li data-type='method'><a href="Doc.html#setFilename">setFilename</a></li><li data-type='method'><a href="Doc.html#setMIMEType">setMIMEType</a></li><li data-type='method'><a href="Doc.html#setMimeType">setMimeType</a></li><li data-type='method'><a href="Doc.html#setName">setName</a></li></ul></li><li><a href="ExternalObject.html">ExternalObject</a><ul class='methods'><li data-type='method'><a href="ExternalObject.html#call">call</a></li><li data-type='method'><a href="ExternalObject.html#callParams">callParams</a></li><li data-type='method'><a href="ExternalObject.html#getName">getName</a></li><li data-type='method'><a href="ExternalObject.html#invoke">invoke</a></li></ul></li><li><a href="ExternalObjectMetadata.html">ExternalObjectMetadata</a></li><li><a href="Grant.html">Grant</a><ul class='methods'><li data-type='method'><a href="Grant.html#T">T</a></li><li data-type='method'><a href="Grant.html#getEmail">getEmail</a></li><li data-type='method'><a href="Grant.html#getFirstName">getFirstName</a></li><li data-type='method'><a href="Grant.html#getFirstname">getFirstname</a></li><li data-type='method'><a href="Grant.html#getLang">getLang</a></li><li data-type='method'><a href="Grant.html#getLastName">getLastName</a></li><li data-type='method'><a href="Grant.html#getLastname">getLastname</a></li><li data-type='method'><a href="Grant.html#getLogin">getLogin</a></li><li data-type='method'><a href="Grant.html#getPictureURL">getPictureURL</a></li><li data-type='method'><a href="Grant.html#getSysParam">getSysParam</a></li><li data-type='method'><a href="Grant.html#getSystemParameter">getSystemParameter</a></li><li data-type='method'><a href="Grant.html#getUserId">getUserId</a></li><li data-type='method'><a href="Grant.html#getUsername">getUsername</a></li><li data-type='method'><a href="Grant.html#hasResponsibility">hasResponsibility</a></li><li data-type='method'><a href="Grant.html#hasScope">hasScope</a></li></ul></li><li><a href="Session.html">Session</a><ul class='methods'><li data-type='method'><a href="Session.html#changePassword">changePassword</a></li><li data-type='method'><a href="Session.html#clear">clear</a></li><li data-type='method'><a href="Session.html#compressData">compressData</a></li><li data-type='method'><a href="Session.html#getAppInfo">getAppInfo</a></li><li data-type='method'><a href="Session.html#getBasicAuthHeader">getBasicAuthHeader</a></li><li data-type='method'><a href="Session.html#getBearerTokenHeader">getBearerTokenHeader</a></li><li data-type='method'><a href="Session.html#getBusinessObject">getBusinessObject</a></li><li data-type='method'><a href="Session.html#getBusinessObjectCacheKey">getBusinessObjectCacheKey</a></li><li data-type='method'><a href="Session.html#getDevInfo">getDevInfo</a></li><li data-type='method'><a href="Session.html#getError">getError</a></li><li data-type='method'><a href="Session.html#getExternalObject">getExternalObject</a></li><li data-type='method'><a href="Session.html#getGrant">getGrant</a></li><li data-type='method'><a href="Session.html#getHealth">getHealth</a></li><li data-type='method'><a href="Session.html#getModuleVersion">getModuleVersion</a></li><li data-type='method'><a href="Session.html#getNews">getNews</a></li><li data-type='method'><a href="Session.html#getPath">getPath</a></li><li data-type='method'><a href="Session.html#getResourceURL">getResourceURL</a></li><li data-type='method'><a href="Session.html#getSysInfo">getSysInfo</a></li><li data-type='method'><a href="Session.html#health">health</a></li><li data-type='method'><a href="Session.html#indexSearch">indexSearch</a></li><li data-type='method'><a href="Session.html#isAuthTokenExpired">isAuthTokenExpired</a></li><li data-type='method'><a href="Session.html#login">login</a></li><li data-type='method'><a href="Session.html#logout">logout</a></li><li data-type='method'><a href="Session.html#parseResponse">parseResponse</a></li><li data-type='method'><a href="Session.html#sendRequest">sendRequest</a></li><li data-type='method'><a href="Session.html#setAjaxKey">setAjaxKey</a></li><li data-type='method'><a href="Session.html#setAuthToken">setAuthToken</a></li><li data-type='method'><a href="Session.html#setAuthTokenExpiryDate">setAuthTokenExpiryDate</a></li><li data-type='method'><a href="Session.html#setPassword">setPassword</a></li><li data-type='method'><a href="Session.html#setUsername">setUsername</a></li><li data-type='method'><a href="Session.html#uncompressData">uncompressData</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-simplicite.html">simplicite</a><ul class='methods'><li data-type='method'><a href="module-simplicite.html#~session">session</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#constants">constants</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">session.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { Buffer } from 'buffer'; // Browser polyfill for Buffer
import { constants } from './constants';
import { Grant } from './grant';
import { Doc } from './doc';
import { BusinessObject } from './businessobject';
import { ExternalObject } from './externalobject';
/**
 * Simplicite application session.
 * @param {object} params Parameters
 * @param {string} params.url Base URL of the Simplicite application
 * @param {string} params.scheme URL scheme (e.g. &lt;code>'https'&lt;/code>) of the Simplicite application (not needed if &lt;code>url&lt;/code> is set)
 * @param {string} params.host Hostname or IP address (e.g. &lt;code>'host.mydomain.com'&lt;/code>) of the Simplicite application (not needed if &lt;code>url&lt;/code> is set)
 * @param {number} params.port Port (e.g. &lt;code>443&lt;/code>) of the Simplicite application (not needed if &lt;code>url&lt;/code> is set)
 * @param {string} params.root Root context URL (e.g. &lt;code>'/myapp'&lt;/code>) the Simplicite application (not needed if &lt;code>url&lt;/code> is set)
 * @param {boolean} [params.endpoint='api'] Endpoint (&lt;code>'api'|'ui'|'uipublic'&lt;/code>)
 * @param {string} [params.username] Username (not needed for the public UI endpoint)
 * @param {string} [params.password] Password (not needed for the public UI endpoint)
 * @param {string} [params.authtoken] Authentication token (if set, username and password are not needed; not needed for the public UI endpoint)
 * @param {string} [params.authheader] Authorization HTTP header name (defaults to the standard &lt;code>Authorization&lt;/code>, the alternative is the value of the &lt;code>SIMPLICITE_AUTH_HEADER&lt;/code> constant, not needed for public endpoint)
 * @param {string} [params.ajaxkey] Ajax key (only useful for usage from the generic UI)
 * @param {boolean} [params.debug=false] Debug mode?
 * @param {function} [params.debugHandler] Debug handler function
 * @param {function} [params.infoHandler] Info handler function
 * @param {function} [params.warningHandler] Warning handler function
 * @param {function} [params.errorHandler] Error handler function
 * @param {function} [params.logHandler] Log handler function
 * @class
 */
class Session {
    /**
     * Constructor
     * @param params {object} Parameters
     */
    constructor(params) {
        /**
         * Constants
         * @member
         */
        this.constants = constants;
        /**
         * Alias to getHealth
         * @param {object} [opts] Options
         * @param {boolean} [opts.full=false] Full health check?
         * @param {function} [opts.error] Error handler function
         * @return {promise&lt;object>} Promise to the health data
         * @function
         */
        this.health = this.getHealth;
        params = params || {};
        // Within the generic web UI if Simplicite is defined
        const inUI = typeof globalThis.Simplicite !== 'undefined';
        this.endpoint = params.endpoint || (inUI ? globalThis.Simplicite.ENDPOINT : "api" /* SessionParamEndpoint.API */);
        this.authheader = params.authheader || this.constants.DEFAULT_AUTH_HEADER;
        this.log = params.logHandler || ((...args) => {
            // eslint-disable-next-line no-console
            console.log(args);
        });
        this.info = params.infoHandler || ((...args) => {
            if (args &amp;&amp; args.length === 1 &amp;&amp; typeof args[0] === 'string')
                // eslint-disable-next-line no-console
                console.info(`INFO - ${args[0]}`);
            else
                // eslint-disable-next-line no-console
                console.info('INFO', args);
        });
        this.warn = params.warningHandler || ((...args) => {
            if (args &amp;&amp; args.length === 1 &amp;&amp; typeof args[0] === 'string')
                // eslint-disable-next-line no-console
                console.warn(`WARN - ${args[0]}`);
            else
                // eslint-disable-next-line no-console
                console.warn(`WARN${args &amp;&amp; args.length > 0 &amp;&amp; args[0].message ? ` - ${args[0].message}` : ''}`, args);
        });
        this.error = params.errorHandler || ((...args) => {
            if (args &amp;&amp; args.length === 1 &amp;&amp; typeof args[0] === 'string')
                // eslint-disable-next-line no-console
                console.error(`ERROR - ${args[0]}`);
            else
                // eslint-disable-next-line no-console
                console.error(`ERROR${args &amp;&amp; args.length > 0 &amp;&amp; args[0].message ? ` - ${args[0].message}` : ''}`, args);
        });
        this.debugMode = !!params.debug;
        this.debug = params.debugHandler || ((...args) => {
            if (this.debugMode) {
                if (args &amp;&amp; args.length === 1 &amp;&amp; typeof args[0] === 'string')
                    // eslint-disable-next-line no-console
                    console.info(`DEBUG - ${args[0]}`);
                else
                    // eslint-disable-next-line no-console
                    console.log('DEBUG', args);
            }
        });
        const purl = params.url || (inUI &amp;&amp; globalThis.Simplicite.URL) || (globalThis.window &amp;&amp; globalThis.window.location.origin);
        this.debug('[simplicite] URL parameter = ' + purl);
        if (purl) {
            try {
                params.scheme = purl.replace(/:.*$/, '');
                const u = purl.replace(new RegExp('^' + params.scheme + '://'), '').split(':');
                if (u.length === 1) {
                    params.host = u[0].replace(/\/.*$/, '');
                    params.port = params.scheme === 'http' ? 80 : 443;
                    params.root = u[0].replace(new RegExp('^' + params.host + '/?'), '');
                }
                else {
                    params.host = u[0];
                    params.port = parseInt(u[1].replace(/\/.*$/, ''), 10);
                    if (isNaN(params.port))
                        throw new Error('Incorrect port');
                    params.root = u[1].replace(new RegExp('^' + params.port + '/?'), '');
                }
                if (params.root === '/')
                    params.root = '';
            }
            catch (e) {
                this.error('Unable to parse URL [' + purl + ']: ' + e.message);
                return;
            }
        }
        const scheme = params.scheme || (params.port === 443 ? 'https' : 'http');
        if (scheme !== 'http' &amp;&amp; scheme !== 'https') {
            this.error('Incorrect scheme [' + params.scheme + ']');
            return;
        }
        const host = params.host || 'localhost';
        const port = params.port || 8080;
        let root = params.root || '';
        if (root === '/')
            root = '';
        let url = scheme + '://' + host;
        if ((scheme === 'http' &amp;&amp; port !== 80) || (scheme === 'https' &amp;&amp; port !== 443))
            url += ':' + port;
        if (root !== '')
            url += root.startsWith('/') ? root : '/' + root;
        this.debug('[simplicite] Base URL = ' + url);
        const ep = this.endpoint === 'uipublic' ? '' : '/' + this.endpoint;
        this.parameters = {
            scheme,
            host,
            port,
            root,
            url,
            username: params.username,
            password: params.password,
            authtoken: params.authtoken,
            timeout: (params.timeout || 30) * 1000, // milliseconds
            compress: params.compress || true,
            healthpath: (ep === '/ui' ? ep : '') + '/health?format=json',
            loginpath: ep === '/api' ? '/api/login?format=json' : ep + '/json/app?action=session',
            logoutpath: ep === '/api' ? '/api/logout?format=json' : ep + '/json/app?action=logout',
            apppath: ep + '/json/app',
            objpath: ep + '/json/obj',
            extpath: ep + '/ext',
            docpath: ep + '/raw/document',
            respath: '/resource'
        };
        this.username = params.username || params.login; // naming flexibility
        this.password = params.password || params.pwd; // naming flexibility
        this.authtoken = params.authtoken || params.token; // explicit token with naming flexibility
        if (!this.authtoken &amp;&amp; this.endpoint === "ui" /* SessionParamEndpoint.UI */) {
            // If on the UI endpoint, get the auth token from browser's storages or from the constant
            this.authtoken = this.getFromStorage(this.constants.UI_AUTH_TOKEN_STORAGE_KEY) || (inUI ? globalThis.Simplicite.AUTH_TOKEN : undefined);
        }
        this.ajaxkey = params.ajaxkey; // explicit Ajax key
        if (!this.ajaxkey &amp;&amp; this.endpoint === "ui" /* SessionParamEndpoint.UI */) {
            // If on the UI endpoint, get the ajax key from browser's storages or from the constant
            this.ajaxkey = this.getFromStorage(this.constants.UI_AJAX_KEY_STORAGE_KEY) || (inUI ? globalThis.Simplicite.AJAX_KEY : undefined);
        }
        this.businessObjectCache = new Map();
    }
    getFromStorage(key) {
        let val = null;
        // First search in local storage if available
        const ls = globalThis.window ? globalThis.window.localStorage : null;
        if (ls)
            val = ls.getItem(key) || ls.getItem(key.toLowerCase()); // also try lowercase key for compatibility with older versions
        if (!val) {
            // Then search in session storage if available
            const ss = globalThis.window ? globalThis.window.sessionStorage : null;
            if (ss)
                val = ss.getItem(key) || ss.getItem(key.toLowerCase()); // also try lowercase key for compatibility with older versions
        }
        return val;
    }
    /**
     * Get API client module version
     * @function
     */
    getModuleVersion() {
        return this.constants.MODULE_VERSION;
    }
    /**
     * Set username
     * @param {string} usr Username
     * @function
     */
    setUsername(usr) {
        this.username = usr;
    }
    /**
     * Set password
     * @param {string} pwd Password
     * @function
     */
    setPassword(pwd) {
        this.password = pwd;
    }
    /**
     * Set auth token
     * @param {string} token Auth token
     * @function
     */
    setAuthToken(token) {
        this.authtoken = token;
    }
    /**
     * Set auth token expiry date
     * @param {Date} expiry Auth token expiry
     * @function
     */
    setAuthTokenExpiryDate(expiry) {
        this.authtokenexpiry = expiry;
    }
    /**
     * Is the auth token expired?
     * @return {boolean} true if the auth token is expired
     * @function
     */
    isAuthTokenExpired() {
        return this.authtokenexpiry ? new Date() > this.authtokenexpiry : false;
    }
    /**
     * Set Ajax key
     * @param {string} key Ajax key
     * @function
     */
    setAjaxKey(key) {
        this.ajaxkey = key;
    }
    /**
     * Get business object cache key
     * @param {string} name Business object name
     * @param {string} [instance] Business object instance name, defaults to &lt;code>js_&amp;lt;object name&amp;gt;&lt;/code>
     * @return {object} Business object cache key
     * @function
     */
    getBusinessObjectCacheKey(name, instance) {
        return name + ':' + (instance || 'js_' + name);
    }
    /**
     * Clears all data (credentials, objects, ...)
     * @function
     */
    clear() {
        this.username = undefined;
        this.password = undefined;
        this.authtoken = undefined;
        this.authtokenexpiry = undefined;
        this.sessionid = undefined;
        this.grant = undefined;
        this.appinfo = undefined;
        this.sysinfo = undefined;
        this.devinfo = undefined;
        this.businessObjectCache = new Map();
    }
    /**
     * Basic HTTP authorization header value
     * @return {string} HTTP authorization header value
     * @function
     */
    getBasicAuthHeader() {
        return this.username &amp;&amp; this.password
            ? 'Basic ' + Buffer.from(this.username + ':' + this.password).toString('base64')
            : undefined;
    }
    /**
     * Get bearer token header value
     * @return {string} Bearer token header value
     * @function
     */
    getBearerTokenHeader() {
        return this.authtoken
            ? 'Bearer ' + this.authtoken
            : undefined;
    }
    /**
     * Get error object
     * @param {(string|object)} err Error
     * @param {string} err.message Error message
     * @param {number} [status] Optional error status (defaults to 200)
     * @param {string} [origin] Optional error origin
     * @return {object} Error object
     * @function
     */
    getError(err, status, origin) {
        if (typeof err === 'string') { // plain text error
            return { message: err, status: status || 200, origin };
        }
        else if (err.response) { // wrapped error
            if (typeof err.response === 'string') {
                return { message: err.response, status: status || 200, origin };
            }
            else {
                if (origin) {
                    try {
                        err.response.origin = origin;
                    }
                    // eslint-disable-next-line @typescript-eslint/no-unused-vars
                    catch (e) {
                        /* ignore */
                    }
                }
                return err.response;
            }
        }
        else { // other cases
            if (origin) {
                try {
                    err.origin = origin;
                }
                // eslint-disable-next-line @typescript-eslint/no-unused-vars
                catch (e) {
                    /* ignore */
                }
            }
            return err;
        }
    }
    /**
     * Compress data as blob
     * @param data {string|any} Data to compress
     * @return {Promise&lt;Blob>} Promise to the compressed data blob
     */
    compressData(data) {
        const s = typeof data === 'string'
            ? new Blob([data], { type: 'text/plain' }).stream()
            : new Blob([JSON.stringify(data)], { type: 'application/json' }).stream();
        const cs = s.pipeThrough(new CompressionStream('gzip'));
        return new Response(cs).blob();
    }
    /**
     * Uncompress blob
     * @param blob {Blob} Compressed data blob
     * @return {Promise&lt;string>} Promise to the uncompressed string
     */
    uncompressData(blob) {
        const us = blob.stream().pipeThrough(new DecompressionStream('gzip'));
        return new Response(us).text();
    }
    /**
     * Send request
     * @param {string} path Path
     * @param {object} [data] Data
     * @param {function} [callback] Callback
     * @param {function} [errorHandler] Error handler
     * @function
     */
    sendRequest(path, data, callback, errorHandler) {
        const origin = 'Session.sendRequest';
        const m = data ? 'POST' : 'GET';
        const h = {};
        if (data)
            h['content-type'] = 'application/x-www-form-urlencoded; charset=utf-8';
        h.accept = 'application/json';
        let b = this.getBearerTokenHeader();
        if (b) {
            h[this.authheader] = b;
        }
        else {
            b = this.getBasicAuthHeader();
            if (b)
                h[this.authheader] = b;
        }
        let u = this.parameters.url + (path || '/');
        if (this.ajaxkey)
            u += (u.indexOf('?') >= 0 ? '&amp;' : '?') + '_ajaxkey=' + encodeURIComponent(this.ajaxkey);
        const d = data ? (typeof data === 'string' ? data : JSON.stringify(data)) : undefined;
        this.debug(`[${origin}] ${m} ${u}${d ? ' with ' + d : ''}`);
        fetch(u, {
            method: m,
            headers: h,
            //compress: this.parameters.compress,
            signal: AbortSignal.timeout(this.parameters.timeout),
            body: d
        }).then((res) => {
            if (callback) {
                res.text().then((textData) => {
                    callback.call(this, textData, res.status, res.headers);
                });
            }
        }).catch((err) => {
            const s = err.response &amp;&amp; err.response.status ? err.response.status : undefined;
            const e = err.response &amp;&amp; err.response.data ? err.response.data : err;
            if (errorHandler)
                errorHandler.call(this, this.getError(e, s, origin));
            else
                throw e;
        });
    }
    /**
     * Parse response
     * @param {object} res Response to parse
     * @param {number} [status=200] HTTP status
     * @return {object} Error object
     * @function
     */
    parseResponse(res, status) {
        try {
            if (status !== 200)
                return { type: 'error', response: this.getError('HTTP status: ' + status, status) };
            return typeof res === 'object' ? res : JSON.parse(res);
        }
        catch (e) {
            return { type: 'error', response: this.getError('Parsing error: ' + e.message, status) };
        }
    }
    /**
     * Get health check (no need to be authenticated)
     * @param {object} [opts] Options
     * @param {boolean} [opts.full=false] Full health check?
     * @param {function} [opts.error] Error handler function
     * @return {promise&lt;object>} Promise to the health data
     * @function
     */
    getHealth(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const origin = 'Session.getHealth';
            opts = opts || {};
            return new Promise((resolve, reject) => {
                let p = `&amp;full=${!!opts.full}`;
                if (opts.businessCase)
                    p += `&amp;_bc=${encodeURIComponent(opts.businessCase)}`;
                this.sendRequest(`${this.parameters.healthpath}${p}`, undefined, (res, status) => {
                    const r = this.parseResponse(res, status);
                    this.debug(`[${origin}] HTTP status = ${status}, response type = ${res}`);
                    if (r.type === 'error') {
                        const err = this.getError(r.response, undefined, origin);
                        if (!(opts.error || this.error).call(this, err))
                            reject.call(this, err);
                    }
                    else {
                        resolve.call(this, r);
                    }
                }, (err) => {
                    err = this.getError(err, undefined, origin);
                    if (!(opts.error || this.error).call(this, err))
                        reject.call(this, err);
                });
            });
        });
    }
    /**
     * Login
     * @param {object} [opts] Options
     * @param {string} [opts.username] Username (exclusive with authentication token)
     * @param {string} [opts.password] Password (required if username is set)
     * @param {string} [opts.authtoken] Authentication token ((exclusive with username)
     * @param {function} [opts.error] Error handler function
     * @return {promise&lt;object>} Promise to the login result
     * @function
     */
    login(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const origin = 'Session.login';
            opts = opts || {};
            return new Promise((resolve, reject) => {
                if ((opts.username || opts.login) &amp;&amp; (opts.password || opts.pwd)) {
                    this.clear();
                    this.username = opts.username || opts.login;
                    this.password = opts.password || opts.pwd;
                }
                else if (opts.authtoken || opts.authToken || opts.token) {
                    this.clear();
                    this.authtoken = opts.authtoken || opts.authToken || opts.token;
                }
                this.sendRequest(this.parameters.loginpath, undefined, (res, status) => {
                    const r = this.parseResponse(res, status);
                    this.debug(`[${origin}] HTTP status = ${status}, response type = ${r.type || (r.error ? 'error' : 'login')}`);
                    if (r.type === 'error' || r.error) {
                        const err = this.getError(r.response ? r.response : r, undefined, origin);
                        if (!(opts.error || this.error).call(this, err))
                            reject.call(this, err);
                    }
                    else {
                        this.sessionid = r.response ? r.response.id : r.sessionid;
                        this.debug(`[${origin}] Session ID = ${this.sessionid}`);
                        this.username = r.response ? r.response.login : r.login;
                        if (this.username)
                            this.debug(`[${origin}] Username = ${this.username}`);
                        this.authtoken = r.response ? r.response.authtoken : r.authtoken;
                        if (this.authtoken)
                            this.debug(`[${origin}] Auth token = ${this.authtoken}`);
                        try {
                            const exp = new Date();
                            exp.setTime(r.response ? r.response.authtokenexpiry : r.authtokenexpiry);
                            this.authtokenexpiry = exp;
                            // eslint-disable-next-line @typescript-eslint/no-unused-vars
                        }
                        catch (e) {
                            this.authtokenexpiry = undefined;
                        }
                        if (this.authtokenexpiry)
                            this.debug(`[${origin}] Auth token expiry date = ${this.authtokenexpiry.toLocaleDateString()} ${this.authtokenexpiry.toLocaleTimeString()}`);
                        // Minimal grant from session data
                        this.grant = new Grant({
                            login: this.username,
                            userid: r.response ? r.response.userid : r.userid,
                            firstname: r.response ? r.response.firstname : r.firstname,
                            lastname: r.response ? r.response.lastname : r.lastname,
                            email: r.response ? r.response.email : r.email
                        });
                        resolve.call(this, r.response || r);
                    }
                }, (err) => {
                    err = this.getError(err, undefined, origin);
                    if (!(opts.error || this.error).call(this, err))
                        reject.call(this, err);
                });
            });
        });
    }
    /**
     * Logout
     * @param {function} callback Callback (called upon success)
     * @param {object} [opts] Options
     * @param {function} [opts.error] Error handler function
     * @return {promise&lt;object>} Promise to the logout result
     * @function
     */
    logout(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const origin = 'Session.logout';
            opts = opts || {};
            return new Promise((resolve, reject) => {
                this.sendRequest(this.parameters.logoutpath, undefined, (res, status) => {
                    const r = this.parseResponse(res, status);
                    this.debug(`[${origin}] HTTP status = ${status}, response type = ${r.type || (r.error ? 'error' : 'logout')}`);
                    if (r.type === 'error') {
                        const err = this.getError(r.response ? r.response : r, undefined, origin);
                        if (!(opts.error || this.error).call(this, err))
                            reject.call(this, err);
                    }
                    else {
                        this.clear();
                        // Restore session parameter-level credentials if present
                        this.username = this.parameters.username;
                        this.password = this.parameters.password;
                        this.authtoken = this.parameters.authtoken;
                        resolve.call(this, r.response || r);
                    }
                }, (err) => {
                    err = this.getError(err, undefined, origin);
                    if (err.status === 401) // Removes (expired or deleted) token if any
                        this.authtoken = undefined;
                    if (!(opts.error || this.error).call(this, err))
                        reject.call(this, err);
                });
            });
        });
    }
    /**
     * Get path
     * @param {string} action Action
     * @param {object} [opts] Options
     * @param {string} [opts.businessCase] Business case label
     */
    getPath(action, opts) {
        const bc = opts &amp;&amp; opts.businessCase ? `&amp;_bc=${encodeURIComponent(opts.businessCase)}` : '';
        return `${this.parameters.apppath}?action=${encodeURIComponent(action)}${bc}`;
    }
    /**
     * Get grant (current user data)
     * @param {object} [opts] Options
     * @param {boolean} [opts.inlinePicture=false] Inline user picture?
     * @param {boolean} [opts.includeTexts=false] Include texts?
     * @param {boolean} [opts.includeSysparams=false] Include system parameters?
     * @param {function} [opts.error] Error handler function
     * @param {string} [opts.businessCase] Business case label
     * @return {promise&lt;Grant>} A promise to the grant (also available as the &lt;code>grant&lt;/code> member)
     * @function
     */
    getGrant(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const origin = 'Session.getGrant';
            opts = opts || {};
            return new Promise((resolve, reject) => {
                let p = '&amp;web=true'; // Required to be able to include texts
                const txt = !!opts.includeTexts || !!opts.texts; // naming flexibility
                p += `&amp;texts=${encodeURIComponent(txt)}`;
                const pic = !!opts.inlinePicture || !!opts.picture; // naming flexibility
                if (pic)
                    p += '&amp;inline_picture=true';
                const sys = !!opts.includeSysparams || !!opts.sysparams; // naming flexibility
                if (sys)
                    p += '&amp;sysparams=true';
                this.sendRequest(`${this.getPath('getgrant', opts)}${p}`, undefined, (res, status) => {
                    const r = this.parseResponse(res, status);
                    this.debug(`[${origin}] HTTP status = ${status}, response type = ${r.type}`);
                    if (r.type === 'error') {
                        const err = this.getError(r.response, undefined, origin);
                        if (!(opts.error || this.error).call(this, err))
                            reject.call(this, err);
                    }
                    else {
                        this.grant = new Grant(r.response); // Set as Grant
                        if (pic)
                            this.grant.picture = new Doc(this.grant.picture); // Set picture as Document
                        if (txt)
                            this.grant.texts = Object.assign(new Map(), this.grant.texts); // Set texts as Map
                        resolve.call(this, this.grant);
                    }
                }, (err) => {
                    err = this.getError(err, undefined, origin);
                    if (!(opts.error || this.error).call(this, err))
                        reject.call(this, err);
                });
            });
        });
    }
    /**
     * Change password
     * @param {string} pwd Password
     * @param {object} [opts] Options
     * @param {function} [opts.error] Error handler function
     * @param {string} [opts.businessCase] Business case label
     * @return {promise&lt;object>} A promise to the change password result
     * @function
     */
    changePassword(pwd, opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const origin = 'Session.changePassword';
            opts = opts || {};
            return new Promise((resolve, reject) => {
                this.sendRequest(`${this.getPath('setpassword', opts)}&amp;password=${encodeURIComponent(pwd)}`, undefined, (res, status) => {
                    const r = this.parseResponse(res, status);
                    this.debug(`[${origin}] HTTP status = ${status}, response type = ${r.type}`);
                    if (r.type === 'error') {
                        const err = this.getError(r.response, undefined, origin);
                        if (!(opts.error || this.error).call(this, err))
                            reject.call(this, err);
                    }
                    else {
                        resolve.call(this, r.response);
                    }
                }, (err) => {
                    err = this.getError(err, undefined, origin);
                    if (!(opts.error || this.error).call(this, err))
                        reject.call(this, err);
                });
            });
        });
    }
    /**
     * Get application info
     * @param {object} [opts] Options
     * @param {function} [opts.error] Error handler function
     * @param {string} [opts.businessCase] Business case label
     * @return {promise&lt;object>} A promise to the application info (also available as the &lt;code>appinfo&lt;/code> member)
     * @function
     */
    getAppInfo(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const origin = 'Session.getAppInfo';
            opts = opts || {};
            return new Promise((resolve, reject) => {
                this.sendRequest(this.getPath('getinfo', opts), undefined, (res, status) => {
                    const r = this.parseResponse(res, status);
                    this.debug(`[${origin}] HTTP status = ${status}, response type = ${r.type}`);
                    if (r.type === 'error') {
                        const err = this.getError(r.response, undefined, origin);
                        if (!(opts.error || this.error).call(this, err))
                            reject.call(this, err);
                    }
                    else {
                        this.appinfo = r.response;
                        resolve.call(this, this.appinfo);
                    }
                }, (err) => {
                    err = this.getError(err, undefined, origin);
                    if (!(opts.error || this.error).call(this, err))
                        reject.call(this, err);
                });
            });
        });
    }
    /**
     * Get system info
     * @param {object} [opts] Options
     * @param {function} [opts.error] Error handler function
     * @param {string} [opts.businessCase] Business case label
     * @return {promise&lt;object>} A promise to the system info (also available as the &lt;code>sysinfo&lt;/code> member)
     * @function
     */
    getSysInfo(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const origin = 'Session.getSysInfo';
            opts = opts || {};
            return new Promise((resolve, reject) => {
                this.sendRequest(this.getPath('sysinfo', opts), undefined, (res, status) => {
                    const r = this.parseResponse(res, status);
                    this.debug(`[${origin}] HTTP status = ${status}, response type = ${r.type}`);
                    if (r.type === 'error') {
                        const err = this.getError(r.response, undefined, origin);
                        if (!(opts.error || this.error).call(this, err))
                            reject.call(this, err);
                    }
                    else {
                        this.sysinfo = r.response;
                        resolve.call(this, this.sysinfo);
                    }
                }, (err) => {
                    err = this.getError(err, undefined, origin);
                    if (!(opts.error || this.error).call(this, err))
                        reject.call(this, err);
                });
            });
        });
    }
    /**
     * Get development info
     * @param {string} [module] Module name
     * @param {object} [opts] Options
     * @param {function} [opts.error] Error handler function
     * @param {string} [opts.businessCase] Business case label
     * @return {promise&lt;object>} A promise to the development info (also available as the &lt;code>devinfo&lt;/code> member)
     * @function
     */
    getDevInfo(module, opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const origin = 'Session.getDevInfo';
            opts = opts || {};
            return new Promise((resolve, reject) => {
                let p = '';
                if (module)
                    p += `&amp;module=${encodeURIComponent(module)}`;
                this.sendRequest(`${this.getPath('devinfo', opts)}${p}`, undefined, (res, status) => {
                    const r = this.parseResponse(res, status);
                    this.debug(`[${origin}] HTTP status = ${status}, response type = ${r.type}`);
                    if (r.type === 'error') {
                        const err = this.getError(r.response, undefined, origin);
                        if (!(opts.error || this.error).call(this, err))
                            reject.call(this, err);
                    }
                    else {
                        if (!module)
                            this.devinfo = r.response;
                        resolve.call(this, r.response);
                    }
                }, (err) => {
                    err = this.getError(err, undefined, origin);
                    if (!(opts.error || this.error).call(this, err))
                        reject.call(this, err);
                });
            });
        });
    }
    /**
     * Get news
     * @param {object} [opts] Options
     * @param {boolean} [opts.inlineImages=false] Inline news images?
     * @param {function} [opts.error] Error handler function
     * @param {string} [opts.businessCase] Business case label
     * @return {promise&lt;array>} A promise to the list of news (also available as the &lt;code>news&lt;/code> member)
     * @function
     */
    getNews(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const origin = 'Session.getNews';
            opts = opts || {};
            return new Promise((resolve, reject) => {
                let p = '';
                const img = !!opts.inlineImages || !!opts.images; // naming flexibility
                if (img)
                    p += '&amp;inline_images=true';
                this.sendRequest(`${this.getPath('news', opts)}${p}`, undefined, (res, status) => {
                    const r = this.parseResponse(res, status);
                    this.debug(`[${origin}] HTTP status = ${status}, response type = ${r.type}`);
                    if (r.type === 'error') {
                        const err = this.getError(r.response, undefined, origin);
                        if (!(opts.error || this.error).call(this, err))
                            reject.call(this, err);
                    }
                    else {
                        this.news = r.response;
                        for (const n of this.news)
                            n.image = new Doc(n.image); // Set image as document
                        resolve.call(this, this.news);
                    }
                }, (err) => {
                    err = this.getError(err, undefined, origin);
                    if (!(opts.error || this.error).call(this, err))
                        reject.call(this, err);
                });
            });
        });
    }
    /**
     * Index search
     * @param {string} query Index search query
     * @param {string} [object] Object
     * @param {object} [opts] Options
     * @param {boolean} [opts.metadata=false] Add meta data for each result
     * @param {number} [opts.context] Context
     * @param {function} [opts.error] Error handler function
     * @param {string} [opts.businessCase] Business case label
     * @return {promise&lt;array>} A promise to a list of index search records
     * @function
     */
    indexSearch(query, object, opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const origin = 'Session.indexSearch';
            opts = opts || {};
            return new Promise((resolve, reject) => {
                let p = `&amp;request=${encodeURIComponent(query ? query : '')}`;
                if (object)
                    p += `&amp;object=${encodeURIComponent(object)}`;
                if (opts.metadata === true)
                    p += '&amp;_md=true';
                if (opts.context)
                    p += `&amp;context=${encodeURIComponent(opts.context)}`;
                this.sendRequest(`${this.getPath('indexsearch', opts)}${p}`, undefined, (res, status) => {
                    const r = this.parseResponse(res, status);
                    this.debug(`[${origin}] HTTP status = ${status}, response type = ${r.type}`);
                    if (r.type === 'error') {
                        const err = this.getError(r.response, undefined, origin);
                        if (!(opts.error || this.error).call(this, err))
                            reject.call(this, err);
                    }
                    else {
                        resolve.call(this, r.response);
                    }
                }, (err) => {
                    err = this.getError(err, undefined, origin);
                    if (!(opts.error || this.error).call(this, err))
                        reject.call(this, err);
                });
            });
        });
    }
    /**
     * Get business object
     * @param {string} name Business object name
     * @param {string} [instance] Business object instance name, defaults to &lt;code>js_&amp;lt;object name&amp;gt;&lt;/code>
     * @return {BusinessObject} Business object
     * @function
     */
    getBusinessObject(name, instance) {
        const cacheKey = this.getBusinessObjectCacheKey(name, instance);
        let obj = this.businessObjectCache[cacheKey];
        if (!obj) {
            obj = new BusinessObject(this, name, instance);
            this.businessObjectCache[cacheKey] = obj;
        }
        return obj;
    }
    /**
     * Get an external object
     * @param {string} name External object name
     * @function
     */
    getExternalObject(name) {
        return new ExternalObject(this, name);
    }
    /**
     * Get a resource URL
     * @param {string} code Resource code
     * @param {string} [type=IMG] Resource type (IMG=image (default), ICO=Icon, CSS=stylesheet, JS=Javascript, HTML=HTML)
     * @param {string} [object] Object name (not required for global resources)
     * @param {string} [objId] Object ID (not required for global resources)
     * @function
     */
    getResourceURL(code, type, object, objId) {
        return this.parameters.url + this.parameters.respath
            + '?code=' + encodeURIComponent(code) + '&amp;type=' + encodeURIComponent(type || 'IMG')
            + (object ? '&amp;object=' + encodeURIComponent(object) : '')
            + (objId ? '&amp;objid=' + encodeURIComponent(objId) : '')
            + (this.authtoken ? '_x_simplicite_authorization_=' + encodeURIComponent(this.authtoken) : '');
    }
}
export { Session };
//# sourceMappingURL=session.js.map</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Thu Jun 26 2025 15:46:40 GMT+0200 (heure dt dEurope centrale) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
